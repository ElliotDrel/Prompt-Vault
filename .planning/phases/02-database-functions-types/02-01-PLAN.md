---
phase: 02-database-functions-types
plan: 01
type: execute
---

<objective>
Create atomic RPC function for inserting prompt version snapshots with version number management.

Purpose: Enable application code to save prompt versions without complex SQL, following established RPC patterns.
Output: Working `create_prompt_version` function that validates inputs, enforces RLS, and returns the created version.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema-rls/01-01-SUMMARY.md
@supabase/migrations/20260106133457_create_increment_prompt_usage_rpc.sql
@supabase/migrations/20260106151530_search_copy_events_function.sql

**Tech stack available:** PostgreSQL RPC functions, Supabase auth context
**Established patterns:** SECURITY DEFINER functions, auth.uid() checks, RETURNING queries, GRANT EXECUTE to authenticated
**Constraining decisions:**
- Phase 1: Application-controlled version numbers (not auto-increment)
- Phase 1: Immutable snapshots store complete prompt state
- Phase 1: RLS policies enforce user isolation

**Version creation logic:**
- Takes prompt_id, version_number, title, body, variables as inputs
- Validates prompt ownership via auth.uid()
- Inserts complete snapshot into prompt_versions table
- Returns created version row or empty result if unauthorized
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration with create_prompt_version function</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_create_prompt_version_rpc.sql</files>
  <action>Create migration file with `create_prompt_version` function. Function signature: takes p_prompt_id UUID, p_version_number INTEGER, p_title TEXT, p_body TEXT, p_variables JSONB. Returns TABLE matching prompt_versions columns. Use SECURITY DEFINER and set search_path = public. Validate prompt ownership with WHERE prompts.id = p_prompt_id AND prompts.user_id = auth.uid() before INSERT. Use INSERT INTO prompt_versions ... RETURNING * pattern. Follow existing RPC patterns from increment_prompt_usage and search_copy_events. Add COMMENT ON FUNCTION for documentation. Do NOT use DEFAULT parameters for required fields - all parameters must be explicitly provided.</action>
  <verify>Migration file exists, SQL syntax is valid (check for PostgreSQL compliance)</verify>
  <done>Migration file created with properly structured function definition</done>
</task>

<task type="auto">
  <name>Task 2: Add GRANT EXECUTE and apply migration</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_create_prompt_version_rpc.sql</files>
  <action>Add GRANT EXECUTE ON FUNCTION create_prompt_version(...) TO authenticated; after function definition. Apply migration with `npx supabase db push`. Verify function exists in remote database with MCP query: SELECT routine_name, routine_type FROM information_schema.routines WHERE routine_schema = 'public' AND routine_name = 'create_prompt_version';</action>
  <verify>npx supabase db push succeeds without errors, MCP query confirms function exists</verify>
  <done>Function deployed to remote database and accessible to authenticated users</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file follows naming convention YYYYMMDDHHMMSS_create_prompt_version_rpc.sql
- [ ] Function uses SECURITY DEFINER and set search_path = public
- [ ] Ownership validation present (auth.uid() check)
- [ ] GRANT EXECUTE to authenticated users included
- [ ] Function deployed successfully to remote database
- [ ] Function name and signature documented with COMMENT
</verification>

<success_criteria>

- Migration file created in supabase/migrations/
- Function accepts prompt_id, version_number, title, body, variables
- Function validates prompt ownership via auth.uid()
- Function returns created version row
- GRANT EXECUTE to authenticated users configured
- Migration applied to remote database
- Function callable by authenticated users
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-functions-types/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Create create_prompt_version RPC function Summary

**[Substantive one-liner - what shipped, not "plan complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-02-PLAN.md
</output>
