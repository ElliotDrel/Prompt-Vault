---
phase: 02-database-functions-types
plan: 02
type: execute
---

<objective>
Create paginated query function for retrieving version history ordered by recency with efficient offset/limit pagination.

Purpose: Enable version list UI to fetch versions incrementally for prompts with extensive history, following React Query patterns.
Output: Working `get_prompt_versions` function with pagination support, timestamp ordering, and RLS enforcement.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema-rls/01-01-SUMMARY.md
@.planning/phases/02-database-functions-types/02-01-SUMMARY.md
@supabase/migrations/20260106151530_search_copy_events_function.sql

**Tech stack available:** PostgreSQL RPC functions, pagination patterns (OFFSET/LIMIT)
**Established patterns:** RETURNS SETOF table_name, ORDER BY created_at DESC, parameterized limits
**Constraining decisions:**
- Phase 1: Composite index on (prompt_id, version_number) for efficient lookups
- Phase 1: created_at DESC index for time-ordered queries
- PROJECT.md: Paginated version fetching to handle high-frequency editors

**Query requirements:**
- Filter by prompt_id (required parameter)
- Validate prompt ownership via RLS (auth.uid())
- Order by created_at DESC (newest first)
- Support offset/limit for pagination
- Use indexed columns for performance
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration with get_prompt_versions function</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_get_prompt_versions_rpc.sql</files>
  <action>Create migration file with `get_prompt_versions` function. Function signature: takes p_prompt_id UUID, p_offset INTEGER DEFAULT 0, p_limit INTEGER DEFAULT 50. RETURNS SETOF prompt_versions. Use SECURITY DEFINER and set search_path = public. Query pattern: SELECT * FROM prompt_versions WHERE prompt_id = p_prompt_id AND user_id = auth.uid() ORDER BY created_at DESC OFFSET p_offset LIMIT p_limit. Follow search_copy_events pagination pattern. Add COMMENT ON FUNCTION for documentation. Use LANGUAGE plpgsql.</action>
  <verify>Migration file exists, SQL syntax valid, follows established pagination patterns</verify>
  <done>Migration file created with paginated query function</done>
</task>

<task type="auto">
  <name>Task 2: Add GRANT EXECUTE and apply migration</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_get_prompt_versions_rpc.sql</files>
  <action>Add GRANT EXECUTE ON FUNCTION get_prompt_versions(UUID, INTEGER, INTEGER) TO authenticated; after function definition. Apply migration with `npx supabase db push`. Verify function exists in remote database with MCP query: SELECT routine_name, specific_name, routine_type FROM information_schema.routines WHERE routine_schema = 'public' AND routine_name = 'get_prompt_versions';</action>
  <verify>npx supabase db push succeeds, MCP query confirms function exists with correct signature</verify>
  <done>Function deployed to remote database with pagination parameters accessible to authenticated users</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file follows naming convention
- [ ] Function returns SETOF prompt_versions
- [ ] Pagination uses OFFSET/LIMIT pattern
- [ ] Query ordered by created_at DESC
- [ ] RLS enforced via user_id = auth.uid()
- [ ] Default limit of 50 prevents unbounded queries
- [ ] GRANT EXECUTE to authenticated users included
- [ ] Function deployed successfully to remote database
</verification>

<success_criteria>

- Migration file created in supabase/migrations/
- Function accepts prompt_id, optional offset, optional limit
- Function filters by prompt ownership (auth.uid())
- Function returns versions ordered newest-first
- Default limit of 50 applied
- GRANT EXECUTE to authenticated users configured
- Migration applied to remote database
- Function callable by authenticated users
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-functions-types/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Create get_prompt_versions RPC function Summary

**[Substantive one-liner - what shipped, not "plan complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-03-PLAN.md
</output>
