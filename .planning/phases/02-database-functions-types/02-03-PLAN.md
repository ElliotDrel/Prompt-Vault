---
phase: 02-database-functions-types
plan: 03
type: execute
---

<objective>
Create consolidation function for merging older versions into consolidated snapshots to manage storage growth (infrastructure for deferred Phase 8).

Purpose: Provide database function for future consolidation job even though background scheduling is deferred. Forward compatibility for Phase 8 optimization.
Output: Working `consolidate_prompt_versions` function that groups old versions and marks them consolidated without executing automatically.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema-rls/01-01-SUMMARY.md
@.planning/phases/02-database-functions-types/02-01-SUMMARY.md
@.planning/phases/02-database-functions-types/02-02-SUMMARY.md

**Tech stack available:** PostgreSQL RPC functions, timestamp manipulation, UPDATE queries
**Established patterns:** SECURITY DEFINER functions, auth.uid() checks, batch operations
**Constraining decisions:**
- Phase 1: is_consolidated and consolidation_group_id columns exist for forward compatibility
- PROJECT.md: Phase 8 (Consolidation Scheduling) deferred until storage needs prove necessary
- ROADMAP.md: Tiered version consolidation (7-30 days hourly, 30-90 days daily, 90+ days weekly)

**Consolidation strategy (for Phase 8):**
- Keep all versions from last 7 days
- 7-30 days ago: keep 1 version per hour
- 30-90 days ago: keep 1 version per day
- 90+ days ago: keep 1 version per week
- Mark consolidated versions with is_consolidated = true
- Group consolidated versions with consolidation_group_id (UUID)

**Note:** This function creates the infrastructure but will not be called until Phase 8 implements pg_cron scheduling.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration with consolidate_prompt_versions function</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_consolidate_prompt_versions_rpc.sql</files>
  <action>Create migration file with `consolidate_prompt_versions` function. Function signature: takes p_prompt_id UUID. RETURNS INTEGER (count of versions marked as consolidated). Use SECURITY DEFINER and set search_path = public. Logic: (1) Keep all versions from last 7 days. (2) For 7-30 days ago, mark versions as consolidated except 1 per hour. (3) For 30-90 days ago, keep 1 per day. (4) For 90+ days ago, keep 1 per week. Use CTEs for readability. Mark consolidated versions: UPDATE prompt_versions SET is_consolidated = true, consolidation_group_id = gen_random_uuid() WHERE ... Use date_trunc for time bucketing. Add COMMENT ON FUNCTION explaining consolidation tiers. Use LANGUAGE plpgsql.</action>
  <verify>Migration file exists, SQL syntax valid, CTE logic correctly implements tiered consolidation</verify>
  <done>Migration file created with consolidation function implementing tiered strategy</done>
</task>

<task type="auto">
  <name>Task 2: Add GRANT EXECUTE and apply migration</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_consolidate_prompt_versions_rpc.sql</files>
  <action>Add GRANT EXECUTE ON FUNCTION consolidate_prompt_versions(UUID) TO authenticated; after function definition. Apply migration with `npx supabase db push`. Verify function exists in remote database with MCP query: SELECT routine_name, routine_type FROM information_schema.routines WHERE routine_schema = 'public' AND routine_name = 'consolidate_prompt_versions';</action>
  <verify>npx supabase db push succeeds, MCP query confirms function exists</verify>
  <done>Function deployed to remote database, ready for future Phase 8 scheduling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file follows naming convention
- [ ] Function implements tiered consolidation logic (7/30/90 day boundaries)
- [ ] Uses date_trunc for time bucketing
- [ ] Marks versions with is_consolidated = true
- [ ] Assigns consolidation_group_id to merged versions
- [ ] Returns count of consolidated versions
- [ ] GRANT EXECUTE to authenticated users included
- [ ] Function deployed successfully to remote database
- [ ] Function documented for Phase 8 usage
</verification>

<success_criteria>

- Migration file created in supabase/migrations/
- Function accepts prompt_id
- Function implements 3-tier consolidation strategy
- Function marks versions as consolidated
- Function returns consolidation count
- GRANT EXECUTE to authenticated users configured
- Migration applied to remote database
- Function ready for Phase 8 pg_cron integration (not called yet)
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-functions-types/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Create consolidate_prompt_versions function Summary

**[Substantive one-liner - what shipped, not "plan complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 02-04-PLAN.md
</output>
