---
phase: 08-backfill-existing-prompts-as-version-one
plan: 01
type: execute
---

<objective>
Backfill all existing prompts with version 1 and clean up unused consolidation columns/function.

Purpose: Users with prompts created before the version history feature should see their existing prompt state as version 1. Also remove dead code from deferred consolidation feature.
Output: All 53 existing prompts have version 1 entries. Unused is_consolidated, consolidation_group_id columns and consolidate_prompt_versions function removed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/7.1-version-history-ui-enhancements/7.1-03-FIX2-SUMMARY.md

# Key constraint from 7.1-FIX2:
**Versioning model:** "Version N = content AFTER Nth save"
- Version 1 should capture the CURRENT state of existing prompts

# Database schema context:
@supabase/migrations/20260111152134_create_prompt_versions_table.sql
@supabase/migrations/20260112030510_update_version_functions_for_revert_tracking.sql

**Current state (verified via SQL):**
- 53 total prompts exist
- 0 prompts have version history
- All 53 prompts need backfill

**Cleanup targets (unused - consolidation feature was removed from roadmap):**
- Column: `is_consolidated` (always false)
- Column: `consolidation_group_id` (always NULL)
- Function: `consolidate_prompt_versions` (never called)
- RPC returns: Both columns returned by create_prompt_version and get_prompt_versions

**Code references to remove:**
- `src/types/prompt.ts` lines 36-37: isConsolidated, consolidationGroupId in PromptVersion
- `src/lib/storage/supabaseAdapter.ts` lines 34-35, 67-68: VersionRow type and mapVersionRow
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and apply backfill migration</name>
  <files>supabase/migrations/[timestamp]_backfill_existing_prompts_version_one.sql</files>
  <action>
Create a new migration file that inserts version 1 records for all prompts without version history.

SQL:
```sql
-- Backfill existing prompts as version 1
-- Uses prompt's original created_at to reflect when content was first saved
-- Idempotent: safe to run multiple times (NOT EXISTS check)

INSERT INTO prompt_versions (
    prompt_id,
    user_id,
    version_number,
    title,
    body,
    variables,
    is_consolidated,
    consolidation_group_id,
    reverted_from_version_id,
    created_at
)
SELECT
    p.id,
    p.user_id,
    1,
    p.title,
    p.body,
    COALESCE(p.variables, '[]'::jsonb),
    false,
    NULL,
    NULL,
    p.created_at
FROM prompts p
WHERE NOT EXISTS (
    SELECT 1 FROM prompt_versions pv
    WHERE pv.prompt_id = p.id
);
```

After creating migration, run `npx supabase db push` to apply.
  </action>
  <verify>
```sql
SELECT
    (SELECT COUNT(*) FROM prompts) as total_prompts,
    (SELECT COUNT(DISTINCT prompt_id) FROM prompt_versions) as prompts_with_versions
```
Expected: Both counts equal (~53)
  </verify>
  <done>All existing prompts have version 1 entry in prompt_versions table</done>
</task>

<task type="auto">
  <name>Task 2: Remove unused consolidation columns and function</name>
  <files>supabase/migrations/[timestamp]_remove_consolidation_columns.sql</files>
  <action>
Create migration to remove dead code from deferred consolidation feature.

SQL:
```sql
-- Remove unused consolidation columns and function
-- These were added for forward-compatibility with a consolidation feature
-- that was later removed from the roadmap (too complex, not needed)

-- 1. Drop the unused consolidation function
DROP FUNCTION IF EXISTS public.consolidate_prompt_versions(uuid, uuid[]);

-- 2. Drop unused columns from prompt_versions
ALTER TABLE prompt_versions DROP COLUMN IF EXISTS is_consolidated;
ALTER TABLE prompt_versions DROP COLUMN IF EXISTS consolidation_group_id;

-- 3. Update create_prompt_version to not reference removed columns
DROP FUNCTION IF EXISTS public.create_prompt_version(uuid, integer, text, text, jsonb, uuid);

CREATE OR REPLACE FUNCTION public.create_prompt_version(
    prompt_id uuid,
    version_number integer,
    title text,
    body text,
    variables jsonb,
    reverted_from_version_id uuid DEFAULT NULL
)
RETURNS TABLE(
    id uuid,
    out_prompt_id uuid,
    user_id uuid,
    out_version_number integer,
    out_title text,
    out_body text,
    out_variables jsonb,
    out_reverted_from_version_id uuid,
    created_at timestamp with time zone
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $function$
DECLARE
    v_user_id UUID;
BEGIN
    -- Validate prompt ownership before creating version
    SELECT prompts.user_id INTO v_user_id
    FROM prompts
    WHERE prompts.id = create_prompt_version.prompt_id
      AND prompts.user_id = auth.uid();

    -- If prompt doesn't exist or user doesn't own it, return empty result
    IF v_user_id IS NULL THEN
        RETURN;
    END IF;

    -- Insert new version snapshot and return the created row
    RETURN QUERY
    INSERT INTO prompt_versions (
        prompt_id,
        user_id,
        version_number,
        title,
        body,
        variables,
        reverted_from_version_id
    )
    VALUES (
        create_prompt_version.prompt_id,
        v_user_id,
        create_prompt_version.version_number,
        create_prompt_version.title,
        create_prompt_version.body,
        create_prompt_version.variables,
        create_prompt_version.reverted_from_version_id
    )
    RETURNING
        prompt_versions.id,
        prompt_versions.prompt_id,
        prompt_versions.user_id,
        prompt_versions.version_number,
        prompt_versions.title,
        prompt_versions.body,
        prompt_versions.variables,
        prompt_versions.reverted_from_version_id,
        prompt_versions.created_at;
END;
$function$;

-- 4. Update get_prompt_versions to not return removed columns
DROP FUNCTION IF EXISTS public.get_prompt_versions(uuid, integer, integer);

CREATE OR REPLACE FUNCTION public.get_prompt_versions(
    prompt_id uuid,
    offset_count integer DEFAULT 0,
    limit_count integer DEFAULT 50
)
RETURNS json
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $function$
DECLARE
    v_total_count INTEGER;
    v_versions JSON;
BEGIN
    -- Get total count first
    SELECT COUNT(*)::INTEGER INTO v_total_count
    FROM prompt_versions pv
    WHERE pv.prompt_id = get_prompt_versions.prompt_id
      AND pv.user_id = auth.uid();

    -- Get paginated versions as JSON array
    SELECT COALESCE(json_agg(row_to_json(v)), '[]'::json) INTO v_versions
    FROM (
        SELECT
            pv.id,
            pv.prompt_id,
            pv.user_id,
            pv.version_number,
            pv.title,
            pv.body,
            pv.variables,
            pv.reverted_from_version_id,
            pv.created_at
        FROM prompt_versions pv
        WHERE pv.prompt_id = get_prompt_versions.prompt_id
          AND pv.user_id = auth.uid()
        ORDER BY pv.created_at DESC
        OFFSET offset_count
        LIMIT limit_count
    ) v;

    -- Return as JSON object with versions array and total_count
    RETURN json_build_object(
        'versions', v_versions,
        'total_count', v_total_count
    );
END;
$function$;
```

Run `npx supabase db push` to apply.
  </action>
  <verify>
```sql
SELECT column_name FROM information_schema.columns
WHERE table_name = 'prompt_versions'
ORDER BY ordinal_position;
```
Expected: is_consolidated and consolidation_group_id NOT in results
  </verify>
  <done>Consolidation columns dropped, RPC functions updated, consolidate function removed</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript types and adapter code</name>
  <files>src/types/supabase-generated.ts, src/types/prompt.ts, src/lib/storage/supabaseAdapter.ts</files>
  <action>
1. Regenerate Supabase types:
```bash
npx supabase gen types typescript --linked --schema public | Out-File -Encoding utf8 src/types/supabase-generated.ts
```

2. Update PromptVersion interface in src/types/prompt.ts - remove:
```typescript
isConsolidated: boolean;
consolidationGroupId: string | null;
```

3. Update VersionRow type in src/lib/storage/supabaseAdapter.ts - remove:
```typescript
is_consolidated: boolean;
consolidation_group_id: string | null;
```

4. Update mapVersionRow function in src/lib/storage/supabaseAdapter.ts - remove:
```typescript
isConsolidated: row.is_consolidated,
consolidationGroupId: row.consolidation_group_id,
```
  </action>
  <verify>npm run build (no TypeScript errors)</verify>
  <done>TypeScript types match new schema, build passes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Backfill migration applied - all prompts have version 1
- [ ] Cleanup migration applied - consolidation columns removed
- [ ] RPC functions updated - no longer return removed columns
- [ ] consolidate_prompt_versions function dropped
- [ ] TypeScript types regenerated and updated
- [ ] `npm run build` passes with no errors
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- All existing prompts have exactly one version 1 entry
- Version timestamps match original prompt created_at
- is_consolidated and consolidation_group_id columns removed from DB
- consolidate_prompt_versions function removed from DB
- TypeScript types updated (no references to removed fields)
- Build and lint pass
- Phase 8 complete - milestone finished
</success_criteria>

<output>
After completion, create `.planning/phases/08-backfill-existing-prompts-as-version-one/08-01-SUMMARY.md`:

# Phase 8 Plan 01: Backfill and Cleanup Summary

**[Substantive one-liner about what was accomplished]**

## Accomplishments

- Backfilled [N] existing prompts with version 1
- Removed unused consolidation columns (is_consolidated, consolidation_group_id)
- Removed unused consolidate_prompt_versions function
- Updated RPC functions to not return removed columns
- Updated TypeScript types to match new schema

## Files Created/Modified

- `supabase/migrations/[timestamp]_backfill_existing_prompts_version_one.sql`
- `supabase/migrations/[timestamp]_remove_consolidation_columns.sql`
- `src/types/supabase-generated.ts` - Regenerated
- `src/types/prompt.ts` - Removed consolidation fields from PromptVersion
- `src/lib/storage/supabaseAdapter.ts` - Removed consolidation fields from VersionRow and mapVersionRow

## Decisions Made

- Remove dead code rather than keep "for future use" - consolidation feature was explicitly removed from roadmap

## Issues Encountered

[Problems and resolutions, or "None"]

## Milestone Complete

Version History feature fully implemented:
- Phases 1-7: Core feature implementation
- Phase 7.1: UI enhancements
- Phase 8: Backfill existing data + cleanup dead code

All users now have complete version history for all prompts.
Schema is clean with no unused columns.
</output>
