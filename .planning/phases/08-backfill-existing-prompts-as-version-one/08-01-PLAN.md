---
phase: 08-backfill-existing-prompts-as-version-one
plan: 01
type: execute
---

<objective>
Create and apply a migration to backfill all existing prompts with version 1, ensuring users have complete version history from feature launch.

Purpose: Users with prompts created before the version history feature was deployed should see their existing prompt state as version 1, providing a consistent baseline for future edits.
Output: All 53 existing prompts have version 1 entries in prompt_versions table.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/7.1-version-history-ui-enhancements/7.1-03-FIX2-SUMMARY.md

# Key constraint from 7.1-FIX2:
**Versioning model:** "Version N = content AFTER Nth save"
- Version 1 should capture the CURRENT state of existing prompts
- This represents "the content after the initial creation/save"

# Database schema context:
@supabase/migrations/20260111152134_create_prompt_versions_table.sql
@supabase/migrations/20260112030510_update_version_functions_for_revert_tracking.sql

**Current state (verified via SQL):**
- 53 total prompts exist
- 0 prompts have version history
- All 53 prompts need backfill

**Column mapping (prompts → prompt_versions):**
- id → (new UUID generated)
- user_id → user_id
- (source id) → prompt_id
- 1 → version_number (constant)
- title → title
- body → body
- variables → variables
- false → is_consolidated
- NULL → consolidation_group_id
- NULL → reverted_from_version_id
- created_at → created_at (use prompt's original created_at)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and apply backfill migration</name>
  <files>supabase/migrations/[timestamp]_backfill_existing_prompts_version_one.sql</files>
  <action>
Create a new migration file that:
1. Inserts version 1 records for all prompts that don't already have version history
2. Uses the prompt's created_at timestamp (not NOW()) to reflect when content was first saved
3. Is idempotent - safe to run multiple times (uses NOT EXISTS check)

SQL pattern:
```sql
INSERT INTO prompt_versions (
    prompt_id,
    user_id,
    version_number,
    title,
    body,
    variables,
    is_consolidated,
    consolidation_group_id,
    reverted_from_version_id,
    created_at
)
SELECT
    p.id,
    p.user_id,
    1,
    p.title,
    p.body,
    COALESCE(p.variables, '[]'::jsonb),
    false,
    NULL,
    NULL,
    p.created_at
FROM prompts p
WHERE NOT EXISTS (
    SELECT 1 FROM prompt_versions pv
    WHERE pv.prompt_id = p.id
);
```

After creating migration:
- Run `npx supabase db push` to apply
- Migration applies to remote database immediately

IMPORTANT: Use COALESCE for variables to handle any NULL values (schema allows NULL, default is '[]').
  </action>
  <verify>
Run SQL to confirm backfill:
```sql
SELECT
    (SELECT COUNT(*) FROM prompts) as total_prompts,
    (SELECT COUNT(DISTINCT prompt_id) FROM prompt_versions) as prompts_with_versions,
    (SELECT COUNT(*) FROM prompt_versions WHERE version_number = 1) as version_one_count
```
Expected: total_prompts = prompts_with_versions = version_one_count (all equal, ~53)
  </verify>
  <done>All existing prompts have version 1 entry in prompt_versions table. Migration file committed. No prompts left without history.</done>
</task>

<task type="auto">
  <name>Task 2: Verify version history displays correctly for backfilled prompts</name>
  <files>None (verification only)</files>
  <action>
Query a sample backfilled version to confirm data integrity:
```sql
SELECT
    pv.id,
    pv.prompt_id,
    pv.version_number,
    pv.title,
    pv.created_at as version_created_at,
    p.created_at as prompt_created_at,
    p.title as current_title
FROM prompt_versions pv
JOIN prompts p ON pv.prompt_id = p.id
WHERE pv.version_number = 1
LIMIT 3;
```

Verify:
1. version_created_at matches prompt_created_at (used original timestamp)
2. title in version matches current title in prompts (snapshot is accurate)
3. All required fields populated (no NULLs in title, body)
  </action>
  <verify>Sample query returns valid data with matching timestamps and content</verify>
  <done>Backfilled versions have correct data integrity - timestamps preserved, content accurate</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Migration file exists in supabase/migrations/
- [ ] `npx supabase db push` completed successfully
- [ ] All prompts (53) now have version history
- [ ] Version 1 timestamps match prompt created_at (not migration run time)
- [ ] No duplicate version 1 entries (idempotent check worked)
</verification>

<success_criteria>

- Migration applied successfully to remote database
- All existing prompts have exactly one version 1 entry
- Version timestamps accurately reflect original prompt creation time
- Migration is idempotent (can be re-run safely)
- Phase 8 complete - milestone finished
</success_criteria>

<output>
After completion, create `.planning/phases/08-backfill-existing-prompts-as-version-one/08-01-SUMMARY.md`:

# Phase 8 Plan 01: Backfill Existing Prompts Summary

**[Substantive one-liner about what was accomplished]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `supabase/migrations/[timestamp]_backfill_existing_prompts_version_one.sql` - Backfill migration

## Decisions Made

[Any decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Milestone Complete

Version History feature fully implemented:
- Phases 1-7: Core feature implementation
- Phase 7.1: UI enhancements
- Phase 8: Backfill existing data

All users now have complete version history for all prompts.
</output>
