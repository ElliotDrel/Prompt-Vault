---
phase: 04-diff-engine-utilities
type: execute
---

<objective>
Implement word-level diffing and variable change visualization utilities for version comparison.

Purpose: Provide core computation utilities that enable version-to-version diff highlighting and variable change tracking. These utilities will be consumed by Phase 5 (Version List) and Phase 6 (Diff Display Modal) to render version history with visual indicators of what changed.

Output: Four new files: dependency update (diff package), two utility modules (diffUtils.ts, versionUtils.ts), and one React component (VariableChanges.tsx). All utilities are pure functions with TypeScript types, ready for consumption by UI components in subsequent phases.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-diff-engine-utilities/DISCOVERY.md

# Prior phase context (from frontmatter):
@.planning/phases/03-storage-adapter-integration/03-02-SUMMARY.md

# Key files from existing codebase:
@src/utils/promptUtils.ts
@src/types/prompt.ts

**Tech stack available:**
- React 18.3 with TypeScript 5.5
- date-fns 3.6 (already in package.json for date utilities)
- shadcn/ui components (Badge, Accordion available)
- lucide-react (icon library)

**Established patterns:**
- Utility functions in `src/utils/*.ts` with camelCase naming
- Pure functions with explicit TypeScript types
- React components in feature-specific directories (`src/components/version-history/`)
- Import path alias: `@/` maps to `src/`

**Constraining decisions:**
- Word-level diffing (not character-level) for better readability with prose content (from DISCOVERY.md)
- Use `diff` npm package (v8.0.2), not react-diff-viewer or other pre-built UI libraries (we control rendering)
- Time-based grouping: "Today", "Yesterday", "Last 7 Days", monthly groups (from PROJECT.md UI spec)
- Lazy diff computation pattern: compute only when needed, use memoization in consuming components (from DISCOVERY.md performance strategy)

**Issues being addressed:**
None - this phase creates new utilities, no existing issues to resolve.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install diff npm package and @types/diff</name>
  <files>package.json, package-lock.json</files>
  <action>
    Install the diff package for text comparison and its TypeScript types:

    ```bash
    npm install diff @types/diff --save
    ```

    Verify installation by checking that both packages appear in package.json dependencies and that TypeScript recognizes the module types (no import errors in IDE).

    Why these packages:
    - `diff` (v8.0.2+): Provides diffWords, diffChars, diffLines APIs for text comparison. Zero dependencies, well-maintained (7,579+ projects use it).
    - `@types/diff`: TypeScript type definitions for the diff package, ensures type safety in our utility functions.

    Do NOT install react-diff-viewer or react-diff-view - we're building custom rendering, not using pre-built UI components.
  </action>
  <verify>
    ```bash
    npm list diff @types/diff
    ```

    Both packages should be listed in the output. Also confirm no TypeScript errors when importing `diffWords` from 'diff' in a .ts file.
  </verify>
  <done>
    - diff package installed (v8.0.2 or higher)
    - @types/diff installed and TypeScript recognizes types
    - package.json and package-lock.json updated
    - No install errors or peer dependency warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Create computeDiff utility function</name>
  <files>src/utils/diffUtils.ts</files>
  <action>
    Create a new utility module for diff computation at `src/utils/diffUtils.ts`:

    ```typescript
    import { diffWords, type Change } from 'diff';

    /**
     * Computes word-level diff between two text strings.
     *
     * Returns an array of change objects where:
     * - Objects with neither `added` nor `removed` represent unchanged text
     * - Objects with `added: true` represent text added in newText
     * - Objects with `removed: true` represent text deleted from oldText
     *
     * Uses word-level diffing for better readability with prose content.
     * Whitespace is ignored when computing the diff but preserved in output.
     *
     * @param oldText - Original text (previous version)
     * @param newText - Modified text (current version)
     * @returns Array of change objects with value, added, removed properties
     *
     * @example
     * const changes = computeDiff("Hello world", "Hello everyone");
     * // Returns: [
     * //   { value: "Hello " },
     * //   { value: "world", removed: true },
     * //   { value: "everyone", added: true }
     * // ]
     */
    export function computeDiff(oldText: string, newText: string): Change[] {
      return diffWords(oldText, newText);
    }
    ```

    Key decisions:
    - Use `diffWords` (not `diffChars` or `diffLines`) per DISCOVERY.md - more readable for prompt editing use case
    - Re-export the `Change` type from 'diff' package for consuming components
    - JSDoc comments explain return format and usage pattern
    - Pure function with no side effects (memoization will be added in consuming components)

    Do NOT add rendering logic here - this is a pure utility, components in Phase 6 will handle rendering.
  </action>
  <verify>
    Create a quick test in the browser console or a test file:

    ```typescript
    import { computeDiff } from '@/utils/diffUtils';

    const changes = computeDiff("Hello world", "Hello everyone");
    console.log(changes);
    // Should output array with unchanged, removed, and added segments
    ```

    Verify:
    - Function returns array of change objects
    - Each object has `value` property (string)
    - Added/removed text has `added: true` or `removed: true` property
    - Unchanged text has neither property
    - TypeScript compilation passes with no errors
  </verify>
  <done>
    - src/utils/diffUtils.ts created with computeDiff function
    - Function uses diffWords from diff package
    - TypeScript types correct (Change[] return type)
    - JSDoc comments present explaining usage
    - Manual test confirms correct diff output format
  </done>
</task>

<task type="auto">
  <name>Task 3: Create groupVersionsByPeriod utility function</name>
  <files>src/utils/versionUtils.ts</files>
  <action>
    Create a new utility module for version grouping at `src/utils/versionUtils.ts`:

    ```typescript
    import { isToday, isYesterday, isThisWeek, format } from 'date-fns';
    import type { PromptVersion } from '@/types/prompt';

    export type GroupedVersions = {
      [period: string]: PromptVersion[];
    };

    /**
     * Groups versions by time period for time-based accordion UI.
     *
     * Versions are categorized into:
     * - "Today" - versions created today
     * - "Yesterday" - versions created yesterday
     * - "Last 7 Days" - versions created this week (excluding today/yesterday)
     * - "MMMM yyyy" - monthly groups for older versions (e.g., "December 2025")
     *
     * Input versions should be sorted by created_at DESC (newest first).
     * Output preserves sort order within each group.
     *
     * @param versions - Array of PromptVersion objects (sorted newest to oldest)
     * @returns Object with period keys and version arrays as values
     *
     * @example
     * const grouped = groupVersionsByPeriod(versions);
     * // Returns: {
     * //   "Today": [v1, v2],
     * //   "Yesterday": [v3],
     * //   "Last 7 Days": [v4, v5],
     * //   "December 2025": [v6, v7, v8]
     * // }
     */
    export function groupVersionsByPeriod(versions: PromptVersion[]): GroupedVersions {
      const groups: GroupedVersions = {};

      for (const version of versions) {
        const date = new Date(version.createdAt);

        let period: string;
        if (isToday(date)) {
          period = 'Today';
        } else if (isYesterday(date)) {
          period = 'Yesterday';
        } else if (isThisWeek(date)) {
          period = 'Last 7 Days';
        } else {
          // Monthly groups for older versions
          period = format(date, 'MMMM yyyy');
        }

        if (!groups[period]) {
          groups[period] = [];
        }
        groups[period].push(version);
      }

      return groups;
    }
    ```

    Key decisions:
    - Use date-fns functions (already in package.json, no new dependency)
    - Four time periods: Today, Yesterday, Last 7 Days, monthly groups (per PROJECT.md UI spec)
    - Preserve input sort order within groups (versions array from RPC is already sorted DESC)
    - Return object with period keys for easy iteration in UI (Accordion section headers)

    Why this grouping logic:
    - Recent versions (today/yesterday) are most important → dedicated sections
    - "Last 7 Days" catches recent history without overwhelming UI
    - Monthly groups for older versions → scannable at a glance

    Do NOT implement rendering here - Phase 5 will use this utility in VersionList component.
  </action>
  <verify>
    Create a test with mock version data:

    ```typescript
    import { groupVersionsByPeriod } from '@/utils/versionUtils';

    const mockVersions: PromptVersion[] = [
      { createdAt: new Date().toISOString(), /* other fields */ },     // Today
      { createdAt: new Date(Date.now() - 86400000).toISOString(), /* */ }, // Yesterday
      { createdAt: new Date(Date.now() - 3 * 86400000).toISOString(), /* */ }, // Last 7 days
      { createdAt: new Date('2025-11-15').toISOString(), /* */ },     // November 2025
    ];

    const grouped = groupVersionsByPeriod(mockVersions);
    console.log(Object.keys(grouped));
    // Should output: ["Today", "Yesterday", "Last 7 Days", "November 2025"]
    ```

    Verify:
    - Function returns object with period keys
    - Today's versions in "Today" group
    - Yesterday's versions in "Yesterday" group
    - Recent versions in "Last 7 Days" group
    - Older versions grouped by month name
    - TypeScript compilation passes
  </verify>
  <done>
    - src/utils/versionUtils.ts created with groupVersionsByPeriod function
    - Uses date-fns comparison functions (isToday, isYesterday, isThisWeek, format)
    - Returns GroupedVersions type (exported)
    - All time periods handled correctly
    - JSDoc comments explain grouping logic
    - Manual test confirms correct categorization
  </done>
</task>

<task type="auto">
  <name>Task 4: Build VariableChanges component</name>
  <files>src/components/version-history/VariableChanges.tsx</files>
  <action>
    Create a React component for visualizing variable additions and removals at `src/components/version-history/VariableChanges.tsx`:

    ```typescript
    import { Badge } from '@/components/ui/badge';
    import { Plus, Minus } from 'lucide-react';

    interface VariableChangesProps {
      oldVariables: string[];
      newVariables: string[];
    }

    /**
     * Displays variable additions and removals between two prompt versions.
     *
     * Renders inline badge chips:
     * - Green badges with "+" icon for variables added in newVariables
     * - Red badges with "-" icon for variables removed from oldVariables
     *
     * If no changes, renders nothing (returns null).
     */
    export function VariableChanges({ oldVariables, newVariables }: VariableChangesProps) {
      // Compute additions: variables in new but not in old
      const additions = newVariables.filter(v => !oldVariables.includes(v));

      // Compute removals: variables in old but not in new
      const removals = oldVariables.filter(v => !newVariables.includes(v));

      // No changes - render nothing
      if (additions.length === 0 && removals.length === 0) {
        return null;
      }

      return (
        <div className="flex flex-wrap gap-2">
          {removals.map((variable) => (
            <Badge key={`removed-${variable}`} variant="destructive" className="gap-1">
              <Minus className="h-3 w-3" />
              {variable}
            </Badge>
          ))}

          {additions.map((variable) => (
            <Badge key={`added-${variable}`} variant="success" className="gap-1">
              <Plus className="h-3 w-3" />
              {variable}
            </Badge>
          ))}
        </div>
      );
    }
    ```

    Key decisions:
    - Use shadcn/ui Badge component (already in codebase, consistent styling)
    - Green badges for additions (variant="success"), red for removals (variant="destructive")
    - lucide-react Plus/Minus icons for clear visual indicators
    - Return null when no changes (don't render empty div)
    - Inline layout with flex-wrap (handles long variable lists gracefully)

    Why this approach:
    - Simple array filtering logic (no complex diffing needed for variable arrays)
    - Follows existing codebase patterns (Badge component used in Dashboard for pinned prompts)
    - Accessible (icons + text, proper color contrast via shadcn/ui variants)

    Note: If "success" variant doesn't exist on Badge, use "default" with custom green className or create the variant in badge.tsx following shadcn/ui patterns.
  </action>
  <verify>
    Render the component in a test page or Storybook with sample data:

    ```typescript
    <VariableChanges
      oldVariables={['name', 'email']}
      newVariables={['name', 'phone', 'address']}
    />
    ```

    Expected output:
    - Red badge with "-" icon and "email" text (removed)
    - Green badge with "+" icon and "phone" text (added)
    - Green badge with "+" icon and "address" text (added)
    - "name" not shown (unchanged)

    Verify:
    - Component renders additions and removals correctly
    - Colors and icons display properly
    - No changes scenario renders nothing (null)
    - Component is accessible (screen reader can read badge text)
    - TypeScript compilation passes
  </verify>
  <done>
    - src/components/version-history/VariableChanges.tsx created
    - Component accepts oldVariables and newVariables props
    - Renders additions as green badges with Plus icon
    - Renders removals as red badges with Minus icon
    - Returns null when no changes
    - Uses shadcn/ui Badge and lucide-react icons
    - TypeScript types correct, no compilation errors
    - Manual test confirms correct rendering
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test` passes (if tests exist)
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes with no warnings
- [ ] All four utility files created and importable
- [ ] TypeScript compilation clean (no type errors)
- [ ] Manual tests of each utility function confirm correct behavior
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- diff and @types/diff packages installed in package.json
- computeDiff utility function works with word-level diffing
- groupVersionsByPeriod utility function categorizes versions correctly
- VariableChanges component renders additions/removals with badges
- No TypeScript errors or ESLint warnings
- Code follows established codebase conventions (file naming, imports, types)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-diff-engine-utilities/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Diff Engine & Utilities Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- Installed diff package (v8.0.2+) and TypeScript types for text comparison
- Created computeDiff utility using word-level diffing for prose content
- Created groupVersionsByPeriod utility for time-based version categorization
- Built VariableChanges component for variable addition/removal visualization

## Files Created/Modified

- `package.json` - Added diff and @types/diff dependencies
- `src/utils/diffUtils.ts` - computeDiff function with diffWords API
- `src/utils/versionUtils.ts` - groupVersionsByPeriod function with date-fns
- `src/components/version-history/VariableChanges.tsx` - Badge-based variable change component

## Decisions Made

- Chose `diff` package over react-diff-viewer (more control over rendering, smaller bundle)
- Word-level diffing for better readability (per DISCOVERY.md recommendation)
- Time grouping periods: Today, Yesterday, Last 7 Days, monthly (per PROJECT.md UI spec)
- VariableChanges uses Badge component with Plus/Minus icons (consistent with existing UI patterns)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 5 (Version List Components). All utilities and components needed for building the version history UI are now available:
- computeDiff ready for diff highlighting in VersionListItem
- groupVersionsByPeriod ready for Accordion section organization
- VariableChanges ready for embedding in version list items

No blockers identified.
</output>
