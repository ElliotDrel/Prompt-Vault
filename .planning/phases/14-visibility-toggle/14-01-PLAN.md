---
phase: 14-visibility-toggle
plan: 01
type: execute
---

<objective>
Add visibility toggle functionality to mark prompts as public or private.

Purpose: Enable users to share prompts publicly or keep them private, completing the visibility infrastructure for the Public Prompt Library feature.
Output: Working visibility toggle with storage integration and UI component.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (dependency graph):
@.planning/phases/11-database-schema/11-SUMMARY.md
@.planning/phases/12-shared-component-architecture/12-03-SUMMARY.md

# Key files to modify:
@src/lib/storage/types.ts
@src/lib/storage/supabaseAdapter.ts
@src/contexts/PromptsContext.tsx
@src/components/PromptView.tsx
@src/components/PromptCard.tsx

# Type definitions:
@src/types/prompt.ts
@src/types/supabase-generated.ts

**Tech stack available:**
- PostgreSQL `prompt_visibility` enum already exists ('private' | 'public')
- Visibility column already on prompts table (Phase 11)
- RLS policies already updated for public prompt access (Phase 11)
- TypeScript types already include visibility on Prompt interface

**Established patterns:**
- togglePinPrompt pattern in storage adapter (fetch current → update → return)
- Context methods exposed via interface with loading/error handling
- Lucide icons for action buttons (Pin, Copy, etc.)

**Constraining decisions:**
- Phase 11: All existing prompts default to 'private' (backward compatible)
- Phase 11: RLS allows reading public prompts: `(user_id = auth.uid() OR visibility = 'public')`
- Phase 12: PromptCard has `source` prop to determine ownership and available actions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update storage adapter for visibility support</name>
  <files>src/lib/storage/types.ts, src/lib/storage/supabaseAdapter.ts</files>
  <action>
  1. In types.ts:
     - Add `toggleVisibility(id: string): Promise<Prompt>` to PromptsStorageAdapter interface

  2. In supabaseAdapter.ts:
     - Add `visibility: Database["public"]["Enums"]["prompt_visibility"]` to PromptRow type
     - Update mapPromptRow to include `visibility: row.visibility ?? 'private'`
     - Add visibility to addPrompt insert payload (default to 'private', or could fetch user's default_visibility from user_settings in future)
     - Implement toggleVisibility method following togglePinPrompt pattern:
       ```typescript
       async toggleVisibility(id: string): Promise<Prompt> {
         const userId = await requireUserId();
         const currentPrompt = await fetchPromptRowById(userId, id);
         const newVisibility = currentPrompt.visibility === 'public' ? 'private' : 'public';

         const { data, error } = await supabase
           .from('prompts')
           .update({ visibility: newVisibility })
           .eq('id', id)
           .eq('user_id', userId)
           .select()
           .maybeSingle();

         // Error handling...
         return mapPromptRow(data);
       }
       ```
     - Also update fetchPromptRowById to select visibility column (change .select('*') to be explicit or ensure visibility is returned)

  Note: Visibility changes are metadata-only, so do NOT create a version snapshot (similar to pin toggle).
  </action>
  <verify>npm run build passes with no TypeScript errors. Storage adapter compiles correctly.</verify>
  <done>PromptsStorageAdapter interface has toggleVisibility method. SupabasePromptsAdapter implements it. PromptRow and mapPromptRow handle visibility column.</done>
</task>

<task type="auto">
  <name>Task 2: Expose toggleVisibility through PromptsContext</name>
  <files>src/contexts/PromptsContext.tsx</files>
  <action>
  1. Add `toggleVisibility: (id: string) => Promise<void>` to PromptsContextType interface

  2. Implement toggleVisibility method in PromptsProvider:
     - Follow togglePinPrompt pattern
     - Optimistically update local state for instant UI feedback
     - Call adapter.prompts.toggleVisibility(id)
     - Update prompts state with returned prompt
     - Handle errors with toast notification

  3. Add toggleVisibility to the context value object

  Pattern to follow (from togglePinPrompt):
  ```typescript
  const toggleVisibility = useCallback(async (promptId: string) => {
    const adapter = getAdapter();
    try {
      // Optimistic update for instant feedback
      setPrompts(prev => prev.map(p =>
        p.id === promptId
          ? { ...p, visibility: p.visibility === 'public' ? 'private' : 'public' }
          : p
      ));

      const updatedPrompt = await adapter.prompts.toggleVisibility(promptId);

      // Sync with server response
      setPrompts(prev => prev.map(p =>
        p.id === promptId ? { ...p, visibility: updatedPrompt.visibility } : p
      ));
    } catch (err) {
      // Revert optimistic update
      await loadPrompts(adapter, true);
      toast.error('Failed to update visibility');
      throw err;
    }
  }, [getAdapter, loadPrompts]);
  ```
  </action>
  <verify>npm run build passes. Context exports toggleVisibility function.</verify>
  <done>PromptsContext exposes toggleVisibility method. Components can import and use it via usePrompts hook.</done>
</task>

<task type="auto">
  <name>Task 3: Create VisibilityToggle component and integrate into UI</name>
  <files>src/components/VisibilityToggle.tsx (new), src/components/PromptView.tsx, src/components/PromptCard.tsx</files>
  <action>
  1. Create src/components/VisibilityToggle.tsx:
     - Props: `visibility: 'private' | 'public'`, `onToggle: () => Promise<void>`, `disabled?: boolean`, `size?: 'sm' | 'default'`
     - Use Globe icon for public, Lock icon for private (from lucide-react)
     - Button with tooltip showing current state
     - Loading state during toggle
     - Public = green tint, Private = default/gray

     ```typescript
     import { Globe, Lock, Loader2 } from 'lucide-react';
     import { Button } from '@/components/ui/button';
     import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';

     interface VisibilityToggleProps {
       visibility: 'private' | 'public';
       onToggle: () => Promise<void>;
       disabled?: boolean;
       size?: 'sm' | 'default';
     }
     ```

  2. Integrate into PromptView.tsx header (next to Pin button):
     - Only show for owned prompts (check if prompt.authorId matches current user or doesn't exist)
     - Add toggleVisibility import from usePrompts
     - Place before or after the Pin button in the action area

  3. Optionally add to PromptCard.tsx:
     - Only show for source='owned' (like pin button)
     - Add showVisibilityAction prop (default: true for owned, false for others)
     - Keep it subtle - small icon in card header

  UX considerations:
  - Toast confirmation when visibility changes: "Prompt is now public" / "Prompt is now private"
  - Public prompts show globe icon as indicator even when not hovering
  - Consider confirmation dialog for making public? (skip for v1 - can add later if needed)
  </action>
  <verify>
  Manual verification:
  1. Run `npm run dev`
  2. Open a prompt in PromptView
  3. Click visibility toggle - should switch between Globe (public) and Lock (private) icons
  4. Verify toast shows confirmation
  5. Refresh page - visibility state persists
  6. Check PromptCard also shows toggle (if implemented)
  </verify>
  <done>VisibilityToggle component created. Integrated into PromptView header. Optional integration in PromptCard. Toggle works end-to-end with persistence.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Visibility toggle appears in PromptView for owned prompts
- [ ] Toggle changes visibility (Globe <-> Lock icon)
- [ ] Visibility persists after page refresh
- [ ] Toast notifications show on toggle
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Visibility toggle works end-to-end (UI -> Context -> Adapter -> Database)
- State persists across page refreshes
</success_criteria>

<output>
After completion, create `.planning/phases/14-visibility-toggle/14-01-SUMMARY.md`:

# Phase 14 Plan 01: Visibility Toggle Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 15 (Public Library Page) - visibility toggle enables prompts to be marked public, which the library page will display.
</output>
