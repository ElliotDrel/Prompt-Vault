---
phase: 05-version-list-components
plan: 01
type: execute
---

<objective>
Create the usePromptVersions React Query hook and VersionListItem component for version history display.

Purpose: Establish data fetching foundation and individual version rendering before composing into the full list.
Output: Working hook that fetches paginated versions, plus a list item component showing version summary with diff preview.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (direct dependencies):
@.planning/phases/04-diff-engine-utilities/04-01-SUMMARY.md

# Key files from prior phases:
@src/types/prompt.ts
@src/lib/storage/types.ts
@src/utils/versionUtils.ts
@src/utils/diffUtils.ts
@src/components/version-history/VariableChanges.tsx

# Existing patterns to follow:
@src/hooks/useInfiniteCopyEvents.ts
@src/components/CopyEventCard.tsx

**Tech stack available:** diff, @types/diff, date-fns
**Established patterns:**
- Pure utility functions in src/utils/
- Feature-specific component directories (src/components/version-history/)
- React Query infinite queries for paginated data
- Memoized card components with formatDate helpers

**Constraining decisions:**
- Phase 4: computeDiff returns Change[] array with added/removed/value properties
- Phase 4: groupVersionsByPeriod returns GroupedVersions object keyed by period strings
- Phase 3: VersionsStorageAdapter.getVersions returns PaginatedVersions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePromptVersions React Query hook</name>
  <files>src/hooks/usePromptVersions.ts</files>
  <action>
Create a custom hook for fetching paginated prompt versions using TanStack Query.

Follow the useInfiniteCopyEvents pattern but simplified (no add/delete mutations needed - versions are immutable):
1. Accept promptId and optional limit parameters
2. Use useInfiniteQuery with queryKey ['promptVersions', userId, promptId]
3. Query function calls adapter.versions.getVersions(promptId, offset, limit)
4. getNextPageParam returns next offset if hasMore is true
5. Enable query only when adapter, userId, and promptId are all present
6. Flatten pages into single versions array
7. Export totalCount, hasMore, loading, error states
8. Include refetch function for manual refresh

Interface:
```typescript
interface UsePromptVersionsOptions {
  promptId: string;
  limit?: number;
  enabled?: boolean;
}
```

Return type:
```typescript
{
  versions: PromptVersion[];
  totalCount: number;
  loading: boolean;
  error: string | null;
  fetchNextPage: () => void;
  hasNextPage: boolean;
  isFetchingNextPage: boolean;
  refetch: () => void;
}
```

Do NOT add realtime subscription - per PROJECT.md, version list refreshes on user action only.
  </action>
  <verify>Import hook in a test component, verify no TypeScript errors with `npm run build`</verify>
  <done>Hook exports all required properties, TypeScript compiles cleanly, follows existing hook patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create VersionListItem component</name>
  <files>src/components/version-history/VersionListItem.tsx</files>
  <action>
Create a list item component for displaying a single version in the history list.

Component props:
```typescript
interface VersionListItemProps {
  version: PromptVersion;
  previousVersion?: PromptVersion; // For computing diff (undefined for oldest version)
  currentPrompt: Prompt; // For "Compare to Current" mode
  comparisonMode: 'previous' | 'current';
  onSelect: (version: PromptVersion) => void;
}
```

Layout structure (following CopyEventCard patterns):
1. Header row with version number and formatted timestamp
   - "Version {n}" on left
   - Relative time on right (use formatDistanceToNow from date-fns)
2. Summary section showing what changed:
   - Title change indicator (if title differs from comparison target)
   - Body change summary (e.g., "+5 words, -2 words" computed from diff)
   - VariableChanges component for variable additions/removals
3. Clickable container - entire item triggers onSelect

Use computeDiff from diffUtils to calculate word changes count:
- Count changes with added: true for additions
- Count changes with removed: true for removals
- Sum word counts from Change.value.split(/\s+/).length

Styling:
- Use hover:bg-muted/50 for hover state
- Rounded border with p-3 padding
- Text hierarchy: version number bold, timestamp muted, changes in normal weight

Do NOT include full diff preview in list item - that's for the modal (Phase 6).
  </action>
  <verify>Component renders without errors, shows version number and timestamp, displays change summary</verify>
  <done>VersionListItem renders version info with change summary, accepts all props, is clickable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes (only Fast Refresh warnings, acknowledged)
- [ ] `npm run build` succeeds without errors
- [ ] usePromptVersions hook is importable and type-safe
- [ ] VersionListItem component renders with mock data
- [ ] No unused imports or variables
</verification>

<success_criteria>

- Both files created and export their main functionality
- Hook follows useInfiniteCopyEvents pattern for infinite pagination
- Component follows CopyEventCard styling patterns
- All TypeScript types are properly defined
- No new dependencies needed (uses existing date-fns, diff)
</success_criteria>

<output>
After completion, create `.planning/phases/05-version-list-components/05-01-SUMMARY.md` following the summary template with:
- Frontmatter with dependency graph
- Performance metrics
- Files created
- Decisions made during implementation
- Ready for 05-02-PLAN.md
</output>
