---
phase: 15.2-rework-filter-ui
plan: 03
subsystem: data-layer
tags:
  - supabase
  - types
  - validation
  - typescript
dependency-graph:
  requires:
    - 15.2-02 (FilterSortControl UI implementation)
  provides:
    - Type-safe filter/sort DB persistence
    - createdAt field on Prompt type
    - Validated URL/DB inputs
  affects:
    - 15.2-04 (UI accessibility depends on working sorting)
    - 15.2-05 (documentation references types)
tech-stack:
  added: []
  patterns:
    - Type guard validation for URL/DB inputs
    - Mapped database fields in adapter layer
key-files:
  created: []
  modified:
    - src/types/supabase-generated.ts
    - src/hooks/useURLFilterSync.ts
    - src/types/prompt.ts
    - src/lib/storage/supabaseAdapter.ts
    - src/hooks/usePromptFilters.ts
decisions:
  - id: createdAt-mapping
    context: Date Created sort was using updatedAt as fallback
    decision: Add createdAt to Prompt type and map from database
    outcome: Correct sorting by actual creation date
  - id: validation-pattern
    context: DB/URL values could be invalid strings
    decision: Use type guard functions (isValidSortBy, isValidAuthorFilter) before setting state
    outcome: Type-safe narrowing from string to union types
metrics:
  duration: ~8 minutes
  completed: 2026-01-30
---

# Phase 15.2 Plan 03: Type Safety and createdAt Support Summary

Type-safe filter/sort with validated DB/URL inputs and actual Date Created sorting.

## Completed Tasks

| Task | Name | Commit | Key Changes |
|------|------|--------|-------------|
| 1 | Regenerate Supabase types (GAP 3) | ca30d90 | filter_visibility, filter_author, sort_by, sort_direction columns |
| 2 | Add validation for sortBy/authorFilter (GAPs 5, 6) | 75dc621 | isValidSortBy/isValidAuthorFilter validation, narrowed types |
| 3 | Add createdAt to Prompt type (GAP 7) | dc6f2f8 | Prompt.createdAt field, adapter mapping, correct sort logic |

## What Changed

### Task 1: Supabase Types Regeneration
- Regenerated `src/types/supabase-generated.ts` from remote database
- Types now include `filter_visibility`, `filter_author`, `sort_by`, `sort_direction` columns in user_settings table
- Reflects migration `20260119060449_add_filter_preferences.sql`

### Task 2: Input Validation
**useURLFilterSync.ts changes:**
- `authorFilter` type narrowed from `string | null` to `AuthorFilter | null`
- `getInitialAuthorFilter()` now validates URL values with `isValidAuthorFilter()`
- DB sortBy values validated with `isValidSortBy()` before setting state
- URL authorFilter values validated before sync

**Impact:** Invalid values from URL params or database are now safely ignored and defaults are used.

### Task 3: createdAt Field Support
**prompt.ts:**
- Added `createdAt: string` to `Prompt` interface

**supabaseAdapter.ts:**
- Added `created_at` to `PromptRow` type
- `mapPromptRow()` maps `created_at` to `createdAt`
- `mapPublicPromptRow()` maps `created_at` to `createdAt`

**usePromptFilters.ts:**
- Sort by `createdAt` now uses actual `a.createdAt` field instead of `updatedAt` fallback
- Removed TODO comment about missing field

## Gaps Closed

| Gap | Issue | Resolution |
|-----|-------|------------|
| 3 | Supabase types outdated | Regenerated with filter preference columns |
| 5 | sortBy from DB not validated | Added `isValidSortBy()` validation before setState |
| 6 | authorFilter from URL not validated | Added `isValidAuthorFilter()` validation |
| 7 | Date Created sort incorrect | Added createdAt field and proper mapping |

## Deviations from Plan

None - plan executed exactly as written.

## Technical Notes

### Type Guard Pattern
```typescript
function isValidSortBy(value: string | null): value is SortBy {
  return value !== null && VALID_SORT_BY.includes(value as SortBy);
}
```
This pattern enables TypeScript to narrow the type from `string` to the union type `SortBy` after validation.

### Database Field Mapping
The `created_at` column exists in the `prompts` table (added in original schema). The adapter now properly maps this to the frontend `createdAt` field for consistent date handling.

## Verification Results

- `npm run build` - PASSED (no TypeScript errors)
- `npm run lint` - PASSED (no linting issues)
- Supabase types include expected columns
- Validation functions used at all required locations
- createdAt mapped in both private and public prompt adapters

## Next Phase Readiness

All 4 gaps (3, 5, 6, 7) are resolved. The type system now enforces valid filter/sort values from both URL parameters and database persistence.

**Dependencies unblocked:**
- 15.2-04 can proceed with UI accessibility fixes (sorting works correctly)
- 15.2-05 can reference correct types in documentation
