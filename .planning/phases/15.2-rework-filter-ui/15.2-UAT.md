---
status: diagnosed
phase: 15.2-rework-filter-ui
source: 15.2-01-SUMMARY.md, PR #41 review comments
started: 2026-01-30T00:00:00Z
updated: 2026-01-30T00:30:00Z
---

## Current Test

[testing complete]

## Tests

### 1. FilterSortControl renders segmented bar
expected: Filter/Sort control displays as inline segmented bar with filter|sort|direction sections
result: pass

### 2. Dropdown opens on click
expected: Clicking the bar opens a two-column dropdown with filter options on left, sort options on right
result: pass

### 3. Sort direction toggle accessible
expected: Direction toggle button is directly on the bar for quick access without opening dropdown
result: pass

### 4. Filter selection works
expected: Selecting a filter option updates the display and filters prompts
result: pass

### 5. Sort selection works
expected: Selecting a sort option updates the display and sorts prompts
result: pass

### 6. URL sync on filter change
expected: Changing filters updates URL params without scrolling to top
result: pass

### 7. DB persistence of filter preferences
expected: Filter preferences persist to database and load on page refresh
result: pass

### 8. PR Review - Code Quality
expected: Code passes automated review checks for correctness, type safety, and best practices
result: issue
reported: "22 issues identified across multiple reviewers (CodeRabbit, Cursor, GitHub Copilot, Gemini) covering type safety, bugs, unused code, and missing defensive patterns"
severity: major

## Summary

total: 8
passed: 7
issues: 1
pending: 0
skipped: 0

## Gaps

- truth: "Author filter should use correct property name from AuthorInfo type"
  status: failed
  reason: "Code uses p.author?.id but AuthorInfo defines userId property - filter logic broken"
  severity: blocker
  test: 8
  root_cause: "Property name mismatch in usePromptFilters.ts lines 106, 109 - AuthorInfo has userId not id"
  artifacts:
    - path: "src/hooks/usePromptFilters.ts"
      issue: "Line 106, 109: p.author?.id should be p.author?.userId"
    - path: "src/types/prompt.ts"
      issue: "AuthorInfo interface defines userId, not id"
  missing:
    - "Change p.author?.id to p.author?.userId on lines 106 and 109"

- truth: "PublicLibrary should not apply Dashboard's visibility filter"
  status: failed
  reason: "PublicLibrary loads visibilityFilter from DB but has no UI to change it - users get trapped in empty results"
  severity: blocker
  test: 8
  root_cause: "PublicLibrary.tsx uses persistToDb: true which loads Dashboard's visibility=private setting, but doesn't expose visibility UI"
  artifacts:
    - path: "src/pages/PublicLibrary.tsx"
      issue: "Line 29: persistToDb: true loads visibility filter that can't be cleared"
    - path: "src/hooks/useURLFilterSync.ts"
      issue: "Lines 140-150: DB prefs loaded without page context awareness"
  missing:
    - "Set persistToDb: false in PublicLibrary, OR force visibilityFilter: 'all' for library context"

- truth: "Supabase generated types should match database schema"
  status: failed
  reason: "user_settings table missing filter_visibility, filter_author, sort_by, sort_direction columns in generated types"
  severity: blocker
  test: 8
  root_cause: "Types not regenerated after migration 20260119060449_add_filter_preferences.sql was applied"
  artifacts:
    - path: "src/types/supabase-generated.ts"
      issue: "Line 195+: user_settings type missing 4 filter preference columns"
    - path: "supabase/migrations/20260119060449_add_filter_preferences.sql"
      issue: "Migration applied but types not regenerated"
  missing:
    - "Run: npx supabase gen types typescript --linked --schema public | Out-File -Encoding utf8 src/types/supabase-generated.ts"

- truth: "internalAuthorFilter should be used as fallback in uncontrolled mode"
  status: failed
  reason: "internalAuthorFilter declared but never read - uncontrolled mode fallback is broken"
  severity: major
  test: 8
  root_cause: "Line 86 in usePromptFilters.ts doesn't follow same fallback pattern as other filters"
  artifacts:
    - path: "src/hooks/usePromptFilters.ts"
      issue: "Line 86: rawAuthorFilter doesn't fall back to internalAuthorFilter"
  missing:
    - "Change line 86 to: controlledState?.authorFilter ?? internalAuthorFilter"

- truth: "prefs.sortBy should be validated before casting to SortBy"
  status: failed
  reason: "Unsafe type cast prefs.sortBy as SortBy without validation - could set invalid state from corrupted DB"
  severity: major
  test: 8
  root_cause: "Line 146 casts without using existing isValidSortBy helper"
  artifacts:
    - path: "src/hooks/useURLFilterSync.ts"
      issue: "Line 146: prefs.sortBy as SortBy cast without validation"
  missing:
    - "Add isValidSortBy(prefs.sortBy) check before setting state"

- truth: "isValidAuthorFilter should be used for URL param validation"
  status: failed
  reason: "isValidAuthorFilter function defined but never called - author filter values not validated from URL"
  severity: major
  test: 8
  root_cause: "Lines 63-65 define validator, but getInitialAuthorFilter (line 103) and URL sync (line 192) don't use it"
  artifacts:
    - path: "src/hooks/useURLFilterSync.ts"
      issue: "Lines 63-65: isValidAuthorFilter defined but unused"
      issue: "Line 103: getInitialAuthorFilter doesn't validate"
      issue: "Line 192: URL sync doesn't validate author param"
  missing:
    - "Use isValidAuthorFilter in getInitialAuthorFilter and URL sync effect"
    - "Type authorFilter as AuthorFilter instead of string | null"

- truth: "setAuthorFilter should clear URL param when value is 'all'"
  status: failed
  reason: "Selecting 'all' produces ?author=all instead of clearing the param like other filters"
  severity: minor
  test: 8
  root_cause: "Line 252-256: setAuthorFilter doesn't check for default value before writing to URL"
  artifacts:
    - path: "src/hooks/useURLFilterSync.ts"
      issue: "Line 254: updateURLParams({ [authorParam]: author }) always writes value"
  missing:
    - "Change to: updateURLParams({ [authorParam]: author === 'all' ? null : author })"

- truth: "Date Created sort should use actual createdAt field"
  status: failed
  reason: "UI shows 'Date Created' but sorts by updatedAt - misleading users"
  severity: major
  test: 8
  root_cause: "Prompt type lacks createdAt field, sorting falls back to updatedAt with TODO comment"
  artifacts:
    - path: "src/hooks/usePromptFilters.ts"
      issue: "Lines 142-145: createdAt sort uses updatedAt as fallback"
    - path: "src/types/prompt.ts"
      issue: "Prompt interface missing createdAt field"
    - path: "src/components/FilterSortControl.tsx"
      issue: "Line 12: UI label says 'Date Created'"
  missing:
    - "Add createdAt: string to Prompt interface"
    - "Map created_at from database in supabaseAdapter"
    - "Use createdAt in sorting logic"

- truth: "Buttons should have explicit type='button' to prevent form submission"
  status: failed
  reason: "Multiple Button components lack type='button', defaulting to submit inside forms"
  severity: minor
  test: 8
  root_cause: "shadcn Button component doesn't set default type; multiple usages omit it"
  artifacts:
    - path: "src/components/PromptListView.tsx"
      issue: "Line 166: Clear Filters button missing type"
    - path: "src/components/FilterSortControl.tsx"
      issue: "Lines 131, 159, 193: Button components missing type"
  missing:
    - "Add type='button' to all non-submit Button usages"

- truth: "Dropdown should close after selection for better UX"
  status: failed
  reason: "Dropdown stays open after selecting filter or sort option"
  severity: minor
  test: 8
  root_cause: "Click handlers call onFilterChange/onSortByChange but don't call setIsOpen(false)"
  artifacts:
    - path: "src/components/FilterSortControl.tsx"
      issue: "Lines 166, 200: onClick doesn't close dropdown"
  missing:
    - "Add setIsOpen(false) to filter and sort option click handlers"

- truth: "Dropdown buttons should have role='menuitem' for ARIA compliance"
  status: failed
  reason: "Dropdown has role='menu' but child buttons lack role='menuitem'"
  severity: minor
  test: 8
  root_cause: "Line 146 has role='menu' but Button children don't have role='menuitem'"
  artifacts:
    - path: "src/components/FilterSortControl.tsx"
      issue: "Lines 159, 193: Button components inside role='menu' lack role='menuitem'"
  missing:
    - "Add role='menuitem' to filter and sort option Button components"

- truth: "Summary doc should reference correct filename"
  status: failed
  reason: "Doc references FilterSortPopover.tsx but actual file is FilterSortControl.tsx"
  severity: cosmetic
  test: 8
  root_cause: "Documentation not updated after component rename"
  artifacts:
    - path: ".planning/phases/15.1-visibility-filter-persistence/15.1-03-SUMMARY.md"
      issue: "Line 34: References deleted filename FilterSortPopover.tsx"
  missing:
    - "Change FilterSortPopover.tsx to FilterSortControl.tsx"
