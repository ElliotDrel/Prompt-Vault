---
phase: 15.2-rework-filter-ui
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/supabase-generated.ts
  - src/hooks/useURLFilterSync.ts
  - src/types/prompt.ts
  - src/lib/storage/supabaseAdapter.ts
  - src/hooks/usePromptFilters.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Supabase generated types include filter preference columns"
    - "sortBy values from DB are validated before casting"
    - "authorFilter values from URL are validated"
    - "Date Created sort uses actual createdAt field"
  artifacts:
    - path: "src/types/supabase-generated.ts"
      provides: "Up-to-date database types"
      contains: "filter_visibility"
    - path: "src/types/prompt.ts"
      provides: "createdAt field on Prompt interface"
      contains: "createdAt: string"
    - path: "src/lib/storage/supabaseAdapter.ts"
      provides: "createdAt mapping from database"
      contains: "createdAt: row.created_at"
    - path: "src/hooks/useURLFilterSync.ts"
      provides: "Validated sortBy and authorFilter"
      contains: "isValidSortBy"
  key_links:
    - from: "supabaseAdapter.ts"
      to: "Prompt type"
      via: "mapPromptRow function"
      pattern: "createdAt: row\\.created_at"
    - from: "usePromptFilters.ts"
      to: "Prompt.createdAt"
      via: "sort comparison"
      pattern: "sortBy === 'createdAt'"
---

<objective>
Fix type safety issues and add createdAt support (Gaps 3, 5, 6, 7)

Purpose: Ensure type safety for DB/URL values and implement proper Date Created sorting
Output: Regenerated types, validated inputs, working createdAt sort
</objective>

<execution_context>
@C:\Users\2supe\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\2supe\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.2-rework-filter-ui/15.2-UAT.md
@src/types/prompt.ts
@src/lib/storage/supabaseAdapter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate Supabase types (GAP 3)</name>
  <files>src/types/supabase-generated.ts</files>
  <action>
    Run the Supabase type generation command:

    ```
    npx supabase gen types typescript --linked --schema public | Out-File -Encoding utf8 src/types/supabase-generated.ts
    ```

    This will regenerate types from the remote database schema, including the
    filter_visibility, filter_author, sort_by, and sort_direction columns added
    in migration 20260119060449_add_filter_preferences.sql.

    IMPORTANT: Use PowerShell-safe command with Out-File -Encoding utf8 to avoid
    UTF-16 encoding that breaks ESLint parsing.
  </action>
  <verify>
    Grep supabase-generated.ts for "filter_visibility" - should find match in user_settings type
    Grep supabase-generated.ts for "sort_by" - should find match in user_settings type
    Run `npm run lint` - no parsing errors
  </verify>
  <done>supabase-generated.ts includes filter_visibility, filter_author, sort_by, sort_direction columns</done>
</task>

<task type="auto">
  <name>Task 2: Add validation for sortBy and authorFilter from DB/URL (GAPs 5, 6)</name>
  <files>src/hooks/useURLFilterSync.ts</files>
  <action>
    In useURLFilterSync.ts, add validation for values from DB and URL:

    1. Line 146 (DB load): Add sortBy validation before setting state
    Change from:
    ```
    if (!searchParams.has(sortByParam) && prefs.sortBy !== defaultSortBy) {
      setSortByState(prefs.sortBy as SortBy);
    }
    ```
    To:
    ```
    if (!searchParams.has(sortByParam) && isValidSortBy(prefs.sortBy) && prefs.sortBy !== defaultSortBy) {
      setSortByState(prefs.sortBy);
    }
    ```

    2. Line 103 (getInitialAuthorFilter): Add validation
    Change from:
    ```
    const getInitialAuthorFilter = () => searchParams.get(authorParam) ?? null;
    ```
    To:
    ```
    const getInitialAuthorFilter = (): AuthorFilter | null => {
      const value = searchParams.get(authorParam);
      return isValidAuthorFilter(value) ? value : null;
    };
    ```

    3. Line 192 (URL sync effect): Add authorFilter validation
    Change from:
    ```
    const nextAuthorFilter = searchParams.get(authorParam) ?? null;
    ```
    To:
    ```
    const authorValue = searchParams.get(authorParam);
    const nextAuthorFilter = isValidAuthorFilter(authorValue) ? authorValue : null;
    ```

    4. Update authorFilter state type from `string | null` to `AuthorFilter | null`
    Line 113: Change `useState<string | null>` to `useState<AuthorFilter | null>`
    Line 37: Update return type interface from `authorFilter: string | null` to `authorFilter: AuthorFilter | null`
    Line 44: Update setter type from `(author: string | null)` to `(author: AuthorFilter | null)`
  </action>
  <verify>
    Run `npm run build` - no TypeScript errors
    Grep useURLFilterSync.ts for "isValidSortBy(prefs.sortBy)" - should find match
    Grep useURLFilterSync.ts for "isValidAuthorFilter" - should find 2+ usages (definition + calls)
  </verify>
  <done>
    - sortBy from DB is validated with isValidSortBy before casting
    - authorFilter from URL is validated with isValidAuthorFilter
    - authorFilter type narrowed from string to AuthorFilter
  </done>
</task>

<task type="auto">
  <name>Task 3: Add createdAt to Prompt type and adapter (GAP 7)</name>
  <files>src/types/prompt.ts, src/lib/storage/supabaseAdapter.ts, src/hooks/usePromptFilters.ts</files>
  <action>
    1. In src/types/prompt.ts, add createdAt to Prompt interface:
    After line 38 (updatedAt: string;), add:
    ```
    createdAt: string;
    ```

    2. In src/lib/storage/supabaseAdapter.ts:

    a. Update PromptRow type (around line 8-17) to include created_at:
    ```
    type PromptRow = {
      id: string;
      title: string;
      body: string;
      variables: unknown;
      created_at: string;  // Add this line
      updated_at: string;
      is_pinned: boolean | null;
      times_used: number | null;
      visibility: Database["public"]["Enums"]["prompt_visibility"];
    };
    ```

    b. Update mapPromptRow (around line 50-59) to include createdAt:
    ```
    const mapPromptRow = (row: PromptRow): Prompt => ({
      id: row.id,
      title: row.title,
      body: row.body,
      variables: Array.isArray(row.variables) ? (row.variables as string[]) : [],
      createdAt: row.created_at,  // Add this line
      updatedAt: row.updated_at,
      isPinned: row.is_pinned ?? false,
      timesUsed: row.times_used ?? 0,
      visibility: row.visibility ?? 'private',
    });
    ```

    c. Update mapPublicPromptRow similarly (around line 61-75):
    Add `createdAt: row.created_at,` to the returned object

    3. In src/hooks/usePromptFilters.ts, update the createdAt sort (around lines 142-145):
    Change from:
    ```
    } else if (sortBy === 'createdAt') {
      // Note: Prompt type doesn't have createdAt field, use updatedAt as fallback
      // This will be updated when createdAt is added to the Prompt type
      comparison = new Date(a.updatedAt).getTime() - new Date(b.updatedAt).getTime();
    }
    ```
    To:
    ```
    } else if (sortBy === 'createdAt') {
      comparison = new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
    }
    ```

    Remove the TODO comment since it's now implemented.
  </action>
  <verify>
    Run `npm run build` - no TypeScript errors
    Grep prompt.ts for "createdAt: string" - should find match
    Grep supabaseAdapter.ts for "createdAt: row.created_at" - should find 2 matches (mapPromptRow, mapPublicPromptRow)
    Grep usePromptFilters.ts for "a.createdAt" - should find match in sort logic
    In browser: Sort by "Date Created" - prompts should sort by actual creation date
  </verify>
  <done>
    - Prompt interface includes createdAt field
    - supabaseAdapter maps created_at to createdAt
    - Date Created sort uses actual createdAt field
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. `npm run lint` passes
3. Supabase generated types are up to date
4. Sort by Date Created uses actual creation dates (not update dates)
5. Invalid sortBy/authorFilter values from DB/URL are handled gracefully
</verification>

<success_criteria>
- All 4 gaps (3, 5, 6, 7) resolved
- No build or lint errors
- Type safety enforced for DB/URL inputs
- Date Created sort works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/15.2-rework-filter-ui/15.2-03-SUMMARY.md`
</output>
