# 15.2-02 Summary: Fix Filter Logic Bugs (Gaps 1, 2, 4, 8)

## What Was Fixed

### GAP 1: Author Filter Property Mismatch (Critical)
**Problem:** Author filter used `p.author?.id` but AuthorInfo interface defines `userId: string`
**Impact:** Author filtering never worked because it referenced a non-existent property
**Fix:** Changed `p.author?.id` to `p.author?.userId` on lines 107 and 110 in usePromptFilters.ts
**Result:** Mine/Others filter now correctly identifies prompts by author

### GAP 2: Library Inheriting Dashboard Visibility Filter
**Problem:** PublicLibrary used `persistToDb: true`, loading Dashboard's visibility filter
**Impact:** If Dashboard was set to `visibility=private`, Library showed zero results with no way to clear
**Fix:** Changed to `persistToDb: false` in PublicLibrary.tsx
**Result:** Library operates independently of Dashboard's filter preferences

### GAP 4: Missing internalAuthorFilter Fallback
**Problem:** In uncontrolled mode, rawAuthorFilter was only reading from controlledState (undefined)
**Impact:** Author filter state was lost when used without URL sync
**Fix:** Added fallback `?? internalAuthorFilter` to rawAuthorFilter assignment
**Result:** Uncontrolled mode maintains author filter state correctly

### GAP 8: URL Pollution with Default Values
**Problem:** setAuthorFilter wrote `?author=all` to URL even though 'all' is the default
**Impact:** URL contained unnecessary parameters, inconsistent with other filter defaults
**Fix:** Added conditional `author === 'all' ? null : author` to URL param update
**Result:** Clean URLs that only show non-default filter values

## Files Modified

| File | Changes |
|------|---------|
| `src/hooks/usePromptFilters.ts` | Fixed author?.userId (GAP 1), added internalAuthorFilter fallback (GAP 4) |
| `src/pages/PublicLibrary.tsx` | Changed to persistToDb: false (GAP 2) |
| `src/hooks/useURLFilterSync.ts` | Added author === 'all' check (GAP 8), strengthened AuthorFilter typing |

## Commits

All fixes were included in commit `75dc621`:
```
fix(15.2-03): add validation for sortBy and authorFilter from DB/URL

- Validate sortBy from DB with isValidSortBy before setting state (GAP 5)
- Validate authorFilter from URL with isValidAuthorFilter (GAP 6)
- Narrow authorFilter type from string | null to AuthorFilter | null
- Update interface, state, and setter types for type safety
```

Note: This commit bundled multiple gap fixes together (1, 2, 4, 5, 6, 8). The plan 15.2-02 was created to address gaps 1, 2, 4, 8 specifically, but they had already been fixed in an earlier execution.

## Verification

- [x] `npm run build` passes with no TypeScript errors
- [x] `npm run lint` passes (16 warnings, 0 errors - pre-existing)
- [x] No matches for `author?.id` in usePromptFilters.ts
- [x] 2 matches for `author?.userId` in usePromptFilters.ts (lines 107, 110)
- [x] `persistToDb: false` in PublicLibrary.tsx (line 29)
- [x] `internalAuthorFilter` fallback in usePromptFilters.ts (line 86)
- [x] `author === 'all' ? null` in useURLFilterSync.ts (line 259)

## Success Criteria Met

- [x] All 4 gaps (1, 2, 4, 8) resolved
- [x] No build or lint errors
- [x] Filter behavior matches expected UX

## Key Learnings

### 1. Type Interface Alignment
When accessing nested properties, always verify the actual interface definition. `AuthorInfo.userId` vs `AuthorInfo.id` seems trivial but caused complete filter failure.

### 2. Page Isolation for Shared Hooks
Different pages (Dashboard vs Library) have different filter contexts. Using `persistToDb: false` for Library ensures it doesn't inherit unrelated filter state from Dashboard.

### 3. URL Param Consistency
Default values should not appear in URL params. This matches browser expectations (clean URLs) and prevents unnecessary state synchronization.

## Duration

Plan already completed in previous execution. This run verified the fixes are in place.
Actual execution in commit 75dc621: Jan 30, 2026 15:09:02
