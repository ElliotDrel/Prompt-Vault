---
phase: 15.2-rework-filter-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/usePromptFilters.ts
  - src/pages/PublicLibrary.tsx
  - src/hooks/useURLFilterSync.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Author filter correctly uses AuthorInfo.userId property"
    - "PublicLibrary does not load Dashboard's visibility filter from DB"
    - "Uncontrolled mode falls back to internalAuthorFilter"
    - "setAuthorFilter clears URL param when value is 'all'"
  artifacts:
    - path: "src/hooks/usePromptFilters.ts"
      provides: "Correct author filter property access and fallback"
      contains: "p.author?.userId"
    - path: "src/pages/PublicLibrary.tsx"
      provides: "Library-specific filter behavior"
      contains: "persistToDb: false"
    - path: "src/hooks/useURLFilterSync.ts"
      provides: "Clean URL params for default values"
      contains: "author === 'all' ? null"
  key_links:
    - from: "usePromptFilters.ts"
      to: "AuthorInfo type"
      via: "p.author?.userId property access"
      pattern: "p\\.author\\?\\.userId"
---

<objective>
Fix filter logic bugs identified in PR review (Gaps 1, 2, 4, 8)

Purpose: Resolve blockers and filter behavior issues that break author filtering and cause users to get trapped in empty results
Output: Working author filter with correct property access, Library isolation from Dashboard state, proper fallbacks
</objective>

<execution_context>
@C:\Users\2supe\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\2supe\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.2-rework-filter-ui/15.2-UAT.md
@src/types/prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix author filter property mismatch (GAP 1)</name>
  <files>src/hooks/usePromptFilters.ts</files>
  <action>
    In usePromptFilters.ts, fix the author filter property access:

    Line 106: Change `p.author?.id` to `p.author?.userId`
    Line 109: Change `p.author?.id` to `p.author?.userId`

    The AuthorInfo interface in src/types/prompt.ts defines `userId: string`, not `id`.
    The current code references a non-existent property, causing author filtering to always fail.
  </action>
  <verify>
    Run `npm run build` - no TypeScript errors
    Grep for `author?.id` in usePromptFilters.ts - should find no matches
    Grep for `author?.userId` in usePromptFilters.ts - should find 2 matches
  </verify>
  <done>Author filter uses correct AuthorInfo.userId property on lines 106 and 109</done>
</task>

<task type="auto">
  <name>Task 2: Isolate PublicLibrary from Dashboard visibility filter (GAP 2)</name>
  <files>src/pages/PublicLibrary.tsx</files>
  <action>
    In PublicLibrary.tsx, change the useURLFilterSync config to prevent loading Dashboard's visibility filter:

    Line 29: Change `persistToDb: true` to `persistToDb: false`

    Rationale: PublicLibrary has no visibility filter UI (all prompts are public). Loading Dashboard's
    visibility=private setting traps users in empty results with no way to clear.

    Alternative considered but rejected: Force visibilityFilter: 'all' - this would still save sort
    preferences to DB and potentially overwrite Dashboard's visibility setting.

    The cleaner solution is to make Library completely independent of DB filter persistence.
    Sort preferences will use defaults but that's acceptable for Library context.
  </action>
  <verify>
    Open Library page in browser while Dashboard has visibility=private
    Library should show all public prompts (not empty)
    Grep PublicLibrary.tsx for "persistToDb" - should show false
  </verify>
  <done>PublicLibrary uses persistToDb: false, isolating it from Dashboard's filter state</done>
</task>

<task type="auto">
  <name>Task 3: Fix internalAuthorFilter fallback and setAuthorFilter URL clearing (GAPs 4, 8)</name>
  <files>src/hooks/usePromptFilters.ts, src/hooks/useURLFilterSync.ts</files>
  <action>
    In usePromptFilters.ts:
    Line 86 currently reads:
    ```
    const rawAuthorFilter = controlledState?.authorFilter;
    ```
    This doesn't fall back to internalAuthorFilter when controlledState is undefined.

    Change to:
    ```
    const rawAuthorFilter = controlledState?.authorFilter ?? internalAuthorFilter;
    ```

    In useURLFilterSync.ts:
    Line 252-256, setAuthorFilter callback currently writes author value to URL even when it's 'all'.

    Change line 254 from:
    ```
    updateURLParams({ [authorParam]: author });
    ```
    To:
    ```
    updateURLParams({ [authorParam]: author === 'all' ? null : author });
    ```

    Add comment: "// Only show in URL if not default (matching other filters)"
  </action>
  <verify>
    Run `npm run build` - no TypeScript errors
    Grep usePromptFilters.ts for "internalAuthorFilter" - should appear in fallback expression
    Grep useURLFilterSync.ts for "author === 'all'" - should find the conditional
    In browser: Select author filter "All" - URL should not contain ?author=all
  </verify>
  <done>
    - internalAuthorFilter is used as fallback in uncontrolled mode (line 86)
    - setAuthorFilter clears URL param when value is 'all' (line 254)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. `npm run lint` passes
3. Author filter works in Library (Mine/Others correctly filter prompts)
4. Library shows all prompts regardless of Dashboard visibility setting
5. Selecting "All" in author filter removes ?author param from URL
</verification>

<success_criteria>
- All 4 gaps (1, 2, 4, 8) resolved
- No build or lint errors
- Filter behavior matches expected UX
</success_criteria>

<output>
After completion, create `.planning/phases/15.2-rework-filter-ui/15.2-02-SUMMARY.md`
</output>
