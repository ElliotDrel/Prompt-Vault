---
phase: 07-revert-integration
plan: 01
type: execute
---

<objective>
Implement revert handler with auto-save and AlertDialog confirmation.

Purpose: Create the core revert logic that auto-saves current prompt state before reverting to ensure nothing is lost.
Output: useRevertToVersion hook with confirmation dialog that other components can use.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/03-storage-adapter-integration/03-02-SUMMARY.md
@.planning/phases/06-diff-display-modal/06-02-SUMMARY.md

# Key files:
@src/components/version-history/VersionHistoryModal.tsx
@src/contexts/PromptsContext.tsx
@src/lib/storage/supabaseAdapter.ts

**Tech stack available:** React Query, shadcn/ui AlertDialog, Supabase adapter
**Established patterns:** Context-based operations, toast notifications for feedback, AlertDialog for confirmations

**Constraining decisions:**
- Auto-save before revert (PROJECT.md: "ensures no data loss")
- Save OLD state on edit, not new state (current prompt always "live")
- Graceful version error handling (Phase 3: failures log but don't block)

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useRevertToVersion hook</name>
  <files>src/hooks/useRevertToVersion.ts</files>
  <action>
Create a custom hook that handles the revert workflow:

1. Hook signature: `useRevertToVersion({ promptId, currentPrompt, onSuccess? })`

2. State management:
   - `isReverting: boolean` - tracks operation in progress
   - `pendingVersion: PromptVersion | null` - version awaiting confirmation

3. Core functions:
   - `requestRevert(version: PromptVersion)` - sets pendingVersion (triggers confirmation dialog)
   - `confirmRevert()` - executes the actual revert:
     a. First call updatePrompt with CURRENT prompt data (this triggers version snapshot via adapter)
     b. Then call updatePrompt with version's title/body/variables
     c. Toast success: "Reverted to version {versionNumber}"
     d. Call onSuccess callback if provided
   - `cancelRevert()` - clears pendingVersion

4. Error handling:
   - Wrap in try/catch
   - Toast error on failure: "Failed to revert. Please try again."
   - Always reset isReverting state in finally

5. Return: `{ isReverting, pendingVersion, requestRevert, confirmRevert, cancelRevert }`

Import updatePrompt from usePrompts context. The adapter already handles version creation on update (Phase 3), so auto-save happens automatically when we update with current state.
  </action>
  <verify>npm run lint passes, TypeScript compiles without errors</verify>
  <done>Hook exported, all functions implemented, proper typing</done>
</task>

<task type="auto">
  <name>Task 2: Create RevertConfirmDialog component</name>
  <files>src/components/version-history/RevertConfirmDialog.tsx, src/components/version-history/index.ts</files>
  <action>
Create a reusable confirmation dialog for revert operations:

1. Props interface:
   ```typescript
   interface RevertConfirmDialogProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
     versionNumber: number;
     onConfirm: () => void;
     onCancel: () => void;
     isReverting: boolean;
   }
   ```

2. Use shadcn/ui AlertDialog components (already imported in codebase)

3. Dialog content:
   - Title: "Revert to Version {versionNumber}?"
   - Description: "Your current changes will be saved as a new version before reverting. You can always restore them later."
   - Cancel button: "Cancel" (calls onCancel)
   - Confirm button: "Revert" with RotateCcw icon (calls onConfirm)
   - Disable confirm button when isReverting is true, show spinner/loading state

4. Add export to barrel file (src/components/version-history/index.ts)

Follow existing AlertDialog patterns from PromptView.tsx and PromptEditor.tsx for consistency.
  </action>
  <verify>npm run lint passes, npm run build succeeds</verify>
  <done>RevertConfirmDialog renders, exported in barrel file, follows codebase patterns</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds without errors
- [ ] useRevertToVersion hook is properly typed
- [ ] RevertConfirmDialog component renders confirmation UI
- [ ] Both files follow established code conventions
</verification>

<success_criteria>
- useRevertToVersion hook created with requestRevert, confirmRevert, cancelRevert functions
- RevertConfirmDialog component created with proper AlertDialog structure
- Auto-save logic implemented (update with current state before reverting)
- Loading states handled (isReverting flag)
- Both components exported and importable
</success_criteria>

<output>
After completion, create `.planning/phases/07-revert-integration/07-01-SUMMARY.md`
</output>
