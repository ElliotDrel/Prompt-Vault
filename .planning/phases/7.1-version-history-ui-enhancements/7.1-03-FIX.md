---
phase: 7.1-version-history-ui-enhancements
plan: 7.1-03-FIX
type: fix
---

<objective>
Fix 10 UAT issues from plan 7.1-03.

Source: 7.1-03-ISSUES.md
Priority: 1 blocker, 5 major, 3 minor, 1 cosmetic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/7.1-version-history-ui-enhancements/7.1-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/7.1-version-history-ui-enhancements/7.1-03-PLAN.md

**Key components:**
@src/components/version-history/VersionHistoryModal.tsx
@src/components/version-history/VersionList.tsx
@src/components/version-history/VersionListItem.tsx
@src/hooks/usePromptVersions.ts
@src/utils/diffUtils.ts
</context>

<tasks>
<task type="auto">
  <name>Fix UAT-009: revertedFromVersionId data flow (BLOCKER)</name>
  <files>
    src/hooks/usePromptVersions.ts
    src/components/version-history/VersionHistoryModal.tsx
    src/components/version-history/VersionList.tsx
  </files>
  <action>
Investigate and fix the data flow issue where revertedFromVersionId is available in VersionListItem but not in the modal detail view.

Investigation steps:
1. Check usePromptVersions hook - verify revertedFromVersionId is being fetched from database
2. Trace data flow through VersionHistoryModal → VersionList → detail view rendering
3. Verify the selected version object passed to detail view includes revertedFromVersionId

Likely root cause: The detail view is using prompt_versions query result but the version object passed isn't complete OR the detail view component isn't accessing the field.

Fix approach:
- Ensure usePromptVersions returns revertedFromVersionId in version objects
- Pass complete version object to detail view rendering
- Verify VersionDetail component (or equivalent) accesses revertedFromVersionId field
  </action>
  <verify>
In dev mode:
1. Create a revert (revert prompt to any previous version)
2. Open version history modal
3. Select the version that was created by the revert
4. Verify detail view shows "This version was created by reverting to Version X"
  </verify>
  <done>revertedFromVersionId flows from database query through to both list item AND detail view display</done>
</task>

<task type="auto">
  <name>Fix UAT-001: Version count excludes "Current" entry</name>
  <files>src/components/version-history/VersionList.tsx</files>
  <action>
The version count header currently shows "{total} versions total" where total includes the "Current" entry. This is misleading because Current is not a saved snapshot.

Fix: Update version count calculation to exclude the "Current" entry:
- In VersionList component, count only the actual saved versions (versions array length)
- Do NOT add 1 for the "Current" entry
- Display count as "{versions.length} version(s) total"

Example:
- If there's only Version 1 saved → show "1 version total"
- If there are 5 versions → show "5 versions total"
  </action>
  <verify>
1. Open version history for prompt with only 1 saved version
2. Verify header shows "1 version total" (not "2 versions total")
3. Open version history for prompt with 5 versions
4. Verify shows "5 versions total"
  </verify>
  <done>Version count excludes the "Current" entry and only counts saved snapshots</done>
</task>

<task type="auto">
  <name>Fix UAT-005, UAT-002, UAT-003, UAT-004: Current/V1 separation logic</name>
  <files>
    src/components/version-history/VersionHistoryModal.tsx
    src/components/version-history/VersionList.tsx
    src/utils/diffUtils.ts
  </files>
  <action>
Root cause: When Current matches the latest version (Version N), they're shown as separate entities causing multiple issues:
- UAT-005: Illusion of 2 distinct versions
- UAT-002: "Compare to Previous" available for V1 (first version)
- UAT-003: Revert button shown when Current = selected version
- UAT-004: False diff when V1 content = Current content

Fix approach - implement smart comparison logic:

1. **Detect unsaved changes:**
   - Compare current prompt (title, body, variables) with latest version content
   - If identical → hasUnsavedChanges = false
   - If different → hasUnsavedChanges = true

2. **Conditional "Current" entry display:**
   - Only show "Current (Live)" entry when hasUnsavedChanges = true
   - When no unsaved changes, don't add separate "Current" entry to timeline

3. **Comparison mode availability:**
   - Disable "Compare to Previous" button when viewing Version 1 (versionNumber === 1)
   - Show message: "No previous version to compare" or hide button entirely

4. **Revert button logic:**
   - Disable revert button when selected version content = current prompt content
   - Compare title, body, and variables arrays
   - If identical, hide or disable revert button

5. **Diff computation:**
   - When comparing Version N to Current and they're identical, return empty diff
   - Ensure getComparisonPair handles this case properly
   - No word count changes, no highlighting when content matches

Implementation details:
- Create utility function: arePromptsIdentical(prompt1, prompt2) that deep-compares title, body, variables
- Use in VersionHistoryModal to determine hasUnsavedChanges on mount
- Pass hasUnsavedChanges to VersionList to control "Current" entry rendering
- Add isFirstVersion check in comparison mode toggle rendering
- Add isMatchingCurrent check in revert button rendering
- Update diff computation to return empty result when contents match
  </action>
  <verify>
Test scenario 1 - No unsaved changes:
1. Create prompt, open history (only Version 1 exists, no edits since)
2. Verify: NO separate "Current" entry in timeline
3. Verify: "Compare to Previous" button is disabled/hidden for Version 1
4. Verify: No revert button shown (Current = Version 1)
5. Verify: No diff highlighting (content is identical)

Test scenario 2 - With unsaved changes:
1. Edit the prompt without saving
2. Open history
3. Verify: "Current (Live)" entry appears at top
4. Verify: Diff shows actual changes between Current and Version 1
5. Verify: Revert button available for Version 1

Test scenario 3 - Multiple versions, viewing latest:
1. Create prompt, edit twice (Version 1 and Version 2 exist)
2. No edits since Version 2
3. Open history, select Version 2
4. Verify: No separate Current entry OR Current indicates it matches V2
5. Verify: "Compare to Previous" works (compares V2 to V1)
6. Verify: No revert button for Version 2 (already at this state)
  </verify>
  <done>
- "Current" entry only shown when there are actual unsaved changes
- "Compare to Previous" disabled for Version 1
- Revert button hidden when selected version matches Current
- No false diffs when content is identical
  </done>
</task>

<task type="auto">
  <name>Fix UAT-006: Show revert info in historical version detail view</name>
  <files>src/components/version-history/VersionHistoryModal.tsx</files>
  <action>
When viewing a version that was created by reverting (has revertedFromVersionId), the detail view should display this information below the timestamp.

Fix:
1. In the detail view section (right side of modal when version selected), add conditional rendering
2. Check if selectedVersion.revertedFromVersionId exists
3. If yes, display below timestamp: "This version was created by reverting to Version X" where X is the version number

Styling:
- Use muted text color (text-muted-foreground)
- Small text size (text-sm)
- Icon: RotateCcw from lucide-react
- Format: "↺ This version was created by reverting to Version X"

Location: After the timestamp line in the version detail header.
  </action>
  <verify>
1. Create a revert (revert prompt to Version 2)
2. Open history, the revert creates Version 3
3. Select Version 3 in the list
4. Verify detail view shows: "↺ This version was created by reverting to Version 2"
5. Verify text is muted and properly styled
  </verify>
  <done>Historical version detail view displays revert source info when applicable</done>
</task>

<task type="auto">
  <name>Fix UAT-007: Show revert info in Current tab when applicable</name>
  <files>src/components/version-history/VersionHistoryModal.tsx</files>
  <action>
When viewing the "Current" tab and the current prompt state was created by reverting, show revert tracking information.

Implementation:
1. Check latest version in versions array for revertedFromVersionId
2. If Current content matches latest version AND latest version has revertedFromVersionId
3. Display in Current detail view: "Current state was restored from Version X"

Styling:
- Same as historical version revert info
- Icon: RotateCcw
- Format: "↺ Current state was restored from Version X"
- Location: Below the "Live" badge in Current detail view

Edge case: Only show if Current actually matches the version that has revertedFromVersionId (no edits since the revert).
  </action>
  <verify>
1. Revert prompt to Version 2 (creates Version 3)
2. Don't make any edits after revert
3. Open history modal, view "Current" tab
4. Verify shows: "↺ Current state was restored from Version 2"
5. Make an edit, re-open history
6. Verify revert info is NOT shown (Current has been modified since revert)
  </verify>
  <done>Current detail view shows revert source info when current state matches a version created by revert</done>
</task>

<task type="auto">
  <name>Fix UAT-008: Right-align comparison mode buttons</name>
  <files>src/components/version-history/VersionHistoryModal.tsx</files>
  <action>
The modal header contains comparison mode buttons ("Compare to Previous", "Compare to Current", "Hide Diff"). Currently left-aligned, should be right-aligned for better visual balance.

Fix:
- Locate the button group container in VersionHistoryModal header
- Add className="ml-auto" or "justify-end" to position buttons at right side
- Maintain spacing between buttons (gap-2 or similar)
- Ensure responsive behavior on smaller screens

Visual goal: Title on left, buttons on right, similar to typical modal header patterns.
  </action>
  <verify>
1. Open version history modal
2. Verify comparison buttons are positioned on the right side of the header
3. Verify buttons maintain proper spacing
4. Resize window, verify buttons stay right-aligned on smaller screens
  </verify>
  <done>Comparison mode buttons are right-aligned in modal header</done>
</task>

<task type="auto">
  <name>Fix UAT-009: Hide Diff toggle affects variable changes</name>
  <files>src/components/version-history/VersionHistoryModal.tsx</files>
  <action>
When "Hide Diff" toggle is enabled (showHighlighting = false), the title and body diff highlighting disappears but variable change badges (green +/red - indicators) remain visible.

Fix: Pass showHighlighting prop to variable changes display:
1. Find where VariableChangesDisplay or variable badges are rendered in detail view
2. Add conditional rendering based on showHighlighting prop
3. When showHighlighting is false, render variables as plain list without Added/Removed badges

Implementation options:
A) Hide the entire "Variables Changed" section when showHighlighting = false
B) Show variable names but without styling/badges (e.g., "prompt_name, context_length" as plain text)

Recommended: Option B - show that variables changed but remove the visual diff indicators.
  </action>
  <verify>
1. Open version history for prompt with variable changes between versions
2. Initially verify variable badges show (green + for added, red - for removed)
3. Click "Hide Diff" button
4. Verify variable badges/colors disappear
5. Verify variable names still visible as plain text OR section hidden
6. Toggle "Show Diff" back on
7. Verify badges reappear
  </verify>
  <done>"Hide Diff" toggle removes all diff indicators including variable change styling</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] All critical issues fixed (UAT-009 blocker)
- [ ] All major issues fixed (UAT-001, 002, 003, 004, 005)
- [ ] Minor issues fixed (UAT-006, 007, 009)
- [ ] Cosmetic issue fixed (UAT-008)
- [ ] Original acceptance criteria from issues met
- [ ] No regressions in existing version history features
</verification>

<success_criteria>
- All 10 UAT issues from 7.1-03-ISSUES.md addressed
- Version history UX is no longer confusing when Current = latest version
- Revert tracking displays correctly in all views
- Hide Diff toggle affects all diff indicators consistently
- Tests pass
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/7.1-version-history-ui-enhancements/7.1-03-FIX-SUMMARY.md`
</output>
