---
phase: 7.1-version-history-ui-enhancements
plan: 01
subsystem: database
tags: [supabase, migrations, typescript, versions, revert-tracking]

# Dependency graph
requires:
  - phase: 07-revert-integration
    provides: Revert flow with auto-save and version creation
provides:
  - reverted_from_version_id column for tracking revert source
  - RPC functions updated to handle revert tracking
  - TypeScript types for revertedFromVersionId field
  - Hook integration to pass version ID on revert
affects: [7.1-02, 7.1-03]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - UpdatePromptOptions interface for passing metadata through update chain

key-files:
  created:
    - supabase/migrations/20260112025930_add_revert_tracking.sql
    - supabase/migrations/20260112030510_update_version_functions_for_revert_tracking.sql
  modified:
    - src/types/prompt.ts
    - src/lib/storage/types.ts
    - src/lib/storage/supabaseAdapter.ts
    - src/contexts/PromptsContext.tsx
    - src/hooks/useRevertToVersion.ts
    - src/types/supabase-generated.ts

key-decisions:
  - "Self-referential FK with ON DELETE SET NULL for reverted_from_version_id"
  - "Partial index on non-null values to optimize filtered queries"
  - "UpdatePromptOptions interface to thread metadata through update chain"
  - "Version snapshot records revert source, not the content being restored"

patterns-established:
  - "Optional metadata parameter on updatePrompt for version tracking context"

issues-created: []

# Metrics
duration: 8min
completed: 2026-01-12
---

# Phase 7.1 Plan 01: Revert Tracking Database Column Summary

**Database infrastructure for tracking which version a revert was based on, enabling "Reverted from Version X" UI indicators**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-12T02:59:00Z
- **Completed:** 2026-01-12T03:07:00Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments

- Added reverted_from_version_id UUID column to prompt_versions table with self-referential FK
- Updated create_prompt_version and get_prompt_versions RPC functions to handle new field
- Extended TypeScript types (PromptVersion, VersionRow, VersionsStorageAdapter, UpdatePromptOptions)
- Threaded revertedFromVersionId through PromptsContext.updatePrompt() chain
- Updated useRevertToVersion hook to pass version ID when executing reverts

## Task Commits

Each task was committed atomically:

1. **Task 1: Add reverted_from_version_id column via migration** - `af4bf4f` (feat)
2. **Task 2: Update TypeScript types and adapter to record revert source** - `b695d30` (feat)

## Files Created/Modified

- `supabase/migrations/20260112025930_add_revert_tracking.sql` - Schema migration adding column and index
- `supabase/migrations/20260112030510_update_version_functions_for_revert_tracking.sql` - RPC function updates
- `src/types/supabase-generated.ts` - Regenerated with new column
- `src/types/prompt.ts` - Added revertedFromVersionId to PromptVersion interface
- `src/lib/storage/types.ts` - Added UpdatePromptOptions interface, updated adapter signatures
- `src/lib/storage/supabaseAdapter.ts` - Updated VersionRow, mapVersionRow, createVersion, updatePrompt
- `src/contexts/PromptsContext.tsx` - Thread UpdatePromptOptions through updatePrompt
- `src/hooks/useRevertToVersion.ts` - Pass version ID when reverting

## Decisions Made

- **Self-referential FK**: reverted_from_version_id references prompt_versions(id) with ON DELETE SET NULL to handle deleted versions gracefully
- **Partial index**: Created index only on non-null values for query efficiency
- **Options pattern**: Used UpdatePromptOptions interface rather than additional parameters to keep API clean and extensible
- **Snapshot semantics**: The version snapshot (OLD state before update) records the revertedFromVersionId, showing "this snapshot was created by reverting to version X"

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

- Database schema extended and migrations applied
- TypeScript types updated and build passes
- Adapter and context plumbed to record revert source
- Ready for Plan 7.1-02: Layout flip and diff toggle implementation
- Ready for Plan 7.1-03: Current version diff display and revert tracking UI

---
*Phase: 7.1-version-history-ui-enhancements*
*Completed: 2026-01-12*
