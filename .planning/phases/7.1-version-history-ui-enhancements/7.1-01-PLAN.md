---
phase: 7.1-version-history-ui-enhancements
plan: 01
type: execute
---

<objective>
Add database infrastructure for tracking which version was reverted to, enabling the UI to show "Reverted from Version X" indicators.

Purpose: Enable users to see when a version was created as a result of reverting, and which version was reverted to.
Output: Database column for revert tracking, updated TypeScript types, and adapter changes to record revert source.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-revert-integration/07-01-SUMMARY.md

**Current schema (prompt_versions):**
- id, prompt_id, user_id, version_number, title, body, variables, is_consolidated, consolidation_group_id, created_at
- Missing: reverted_from_version_id to track revert source

**Key files:**
@src/types/prompt.ts
@src/lib/storage/supabaseVersionsAdapter.ts
@src/hooks/useRevertToVersion.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reverted_from_version_id column via migration</name>
  <files>supabase/migrations/[timestamp]_add_revert_tracking.sql</files>
  <action>
Create a new migration that:
1. Adds `reverted_from_version_id UUID REFERENCES prompt_versions(id) ON DELETE SET NULL` column to prompt_versions table
2. Column is nullable (most versions are not reverts)
3. Self-referential foreign key to same table
4. Add index on reverted_from_version_id for query performance
5. Run `npx supabase db push` to apply migration
6. Regenerate TypeScript types with `npx supabase gen types typescript --linked --schema public | Out-File -Encoding utf8 src/types/supabase-generated.ts`
  </action>
  <verify>
- `npx supabase migration list` shows new migration as applied
- Query `SELECT column_name FROM information_schema.columns WHERE table_name = 'prompt_versions' AND column_name = 'reverted_from_version_id'` returns result
- Generated types include reverted_from_version_id field
  </verify>
  <done>Column exists in database, migration applied, types regenerated</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types and adapter to record revert source</name>
  <files>src/types/prompt.ts, src/lib/storage/supabaseVersionsAdapter.ts, src/hooks/useRevertToVersion.ts</files>
  <action>
1. Update PromptVersion interface in src/types/prompt.ts:
   - Add `revertedFromVersionId: string | null` field

2. Update SupabaseVersionsAdapter.createVersion():
   - Add optional `revertedFromVersionId?: string` parameter
   - Include in insert when provided, null otherwise
   - Update return type mapping to include revertedFromVersionId

3. Update SupabaseVersionsAdapter.getVersions():
   - Include reverted_from_version_id in select
   - Map to revertedFromVersionId in returned objects

4. Update useRevertToVersion hook:
   - When reverting, call createVersion with the version.id as revertedFromVersionId
   - This records "this new version was reverted from version X"

Note: The revert flow creates a new version capturing the OLD state before applying the revert. The revertedFromVersionId should point to the VERSION BEING REVERTED TO (the historical version user selected), not the version being replaced.
  </action>
  <verify>
- TypeScript compiles without errors: `npx tsc --noEmit`
- Build passes: `npm run build`
- Lint passes: `npm run lint`
  </verify>
  <done>PromptVersion type updated, adapter handles revertedFromVersionId, hook passes version ID when reverting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration applied successfully
- [ ] TypeScript types include revertedFromVersionId
- [ ] Adapter createVersion accepts and stores revertedFromVersionId
- [ ] Adapter getVersions returns revertedFromVersionId
- [ ] useRevertToVersion passes version ID when creating revert snapshot
- [ ] `npm run build` passes
- [ ] `npm run lint` passes
</verification>

<success_criteria>
- Database schema extended with reverted_from_version_id column
- TypeScript interfaces updated with revertedFromVersionId field
- Adapter methods handle the new field
- Revert hook records which version was reverted to
- All type checks and builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/7.1-version-history-ui-enhancements/7.1-01-SUMMARY.md`
</output>
