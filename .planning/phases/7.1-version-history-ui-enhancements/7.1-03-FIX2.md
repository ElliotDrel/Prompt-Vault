---
phase: 7.1-version-history-ui-enhancements
plan: 7.1-03-FIX2
type: fix
---

<objective>
Fix 4 UAT issues from plan 7.1-03 (re-test round).

Source: 7.1-03-ISSUES.md
Priority: 1 Blocker, 2 Major, 1 Minor

Key changes:
1. UAT-011 (Blocker): Versioning captures OLD state instead of NEW state
2. UAT-012 (Major): Remove separate "Current" entry - merge with latest version
3. UAT-013 (Major): Remove "Unsaved changes" messaging
4. UAT-014 (Minor): Remove arePromptsIdentical comparisons (cleanup)

**Correct Versioning Model:**
- Version N = content AFTER the Nth save (not before)
- Version 1 = initial creation content
- Latest version = Current (always, no separate "Current" concept)
- There are never "unsaved changes"
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/7.1-version-history-ui-enhancements/7.1-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/7.1-version-history-ui-enhancements/7.1-03-PLAN.md

**Key source files:**
@src/lib/storage/supabaseAdapter.ts (lines 190-210)
@src/components/version-history/VersionList.tsx
@src/components/version-history/VersionHistoryModal.tsx
@src/components/version-history/VersionListItem.tsx
@src/utils/diffUtils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-011 - Version should capture NEW state, not OLD state</name>
  <files>src/lib/storage/supabaseAdapter.ts</files>
  <action>
In updatePrompt method around line 198-205, the version snapshot currently uses OLD content:
```typescript
title: oldPromptRow.title,    // WRONG - OLD content
body: oldPromptRow.body,      // WRONG - OLD content
variables: oldPromptRow.variables,
```

Change to use NEW content (promptData) being saved:
```typescript
title: promptData.title,      // CORRECT - NEW content
body: promptData.body,        // CORRECT - NEW content
variables: promptData.variables ?? [],
```

This ensures Version N contains the content AFTER the Nth save:
- Version 1 = initial creation content
- Version 2 = content after first edit
- etc.

Note: Keep revertedFromVersionId from options as-is.
  </action>
  <verify>
- Build passes: `npm run build`
- Manual test: Create prompt, edit it, check database - version content should match the NEW content
  </verify>
  <done>Version snapshots contain the NEW content being saved, not the OLD content</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-012/013/014 - Remove separate "Current" entry and unsaved changes logic</name>
  <files>src/components/version-history/VersionList.tsx, src/components/version-history/VersionListItem.tsx</files>
  <action>
**VersionList.tsx changes:**

1. Remove the `arePromptsIdentical` import (UAT-014)

2. Remove the `hasUnsavedChanges` useMemo (UAT-014):
```typescript
// DELETE this entire useMemo
const hasUnsavedChanges = useMemo(() => {...}, [...]);
```

3. Remove the "Current" entry button entirely (UAT-012):
```typescript
// DELETE this entire block
{onCurrentSelect && hasUnsavedChanges && (
  <button>...</button>
)}
```

4. Update the version count comment - it's now always accurate since there's no separate "Current"

5. Remove props that are no longer needed from interface:
- Keep `onCurrentSelect` temporarily for modal compatibility
- Remove `isCurrentSelected` - no longer needed

**VersionListItem.tsx changes:**

1. Add `isLatest?: boolean` prop to VersionListItem interface

2. When `isLatest` is true, display "(Current)" badge next to version number:
```typescript
<span className="font-semibold">
  Version {version.versionNumber}
  {isLatest && (
    <span className="ml-2 text-xs bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 px-2 py-0.5 rounded">
      Current
    </span>
  )}
</span>
```

**VersionList.tsx - pass isLatest to first item:**

Update the VersionListItem mapping to pass `isLatest={versions[0]?.id === version.id}`:
```typescript
<VersionListItem
  key={version.id}
  version={version}
  isLatest={versions[0]?.id === version.id}
  ...
/>
```

This accomplishes:
- UAT-012: Latest version shows as "Version N (Current)" with badge
- UAT-013: No "unsaved changes" messaging anywhere
- UAT-014: arePromptsIdentical no longer used for Current/version comparison
  </action>
  <verify>
- Build passes: `npm run build`
- Lint passes: `npm run lint`
  </verify>
  <done>Separate "Current" entry removed, latest version shows "(Current)" badge, no unsaved changes messaging</done>
</task>

<task type="auto">
  <name>Task 3: Update VersionHistoryModal to match new model</name>
  <files>src/components/version-history/VersionHistoryModal.tsx</files>
  <action>
**Major refactor to remove "Current" as separate selection:**

1. Remove `isCurrentSelected` state - no longer needed

2. Remove `handleCurrentSelect` function

3. Update `useEffect` - always select latest version when opening:
```typescript
useEffect(() => {
  if (open && versions.length > 0 && !selectedVersion) {
    setSelectedVersion(versions[0]);
  }
}, [open, versions, selectedVersion]);
```

4. Remove the entire "Current prompt selected" section (`{isCurrentSelected && (...)}`)
   - The latest version IS current, so the historical version view handles it

5. Update revert button visibility (UAT-003 fix update):
   - Instead of checking `arePromptsIdentical`, check if this is the LATEST version
   - Latest version = versions[0], so hide revert when `selectedVersion?.id === versions[0]?.id`
   - This makes more sense: can't revert to what you're already at

6. When latest version is selected, show special metadata in detail view:
   - "This is the current version" message
   - If it was created by revert, show that info
   - If it's also Version 1, indicate "This is the initial version"

7. Remove `arePromptsIdentical` import and related usages:
   - `selectedVersionMatchesCurrent` - replace with `isLatestVersion`
   - `currentMatchesLatest` - remove
   - `currentRevertedFromVersionNumber` - the latest version will show this naturally

8. Update VersionList props - remove `onCurrentSelect` and `isCurrentSelected`:
```typescript
<VersionList
  promptId={prompt.id}
  currentPrompt={prompt}
  comparisonMode={comparisonMode}
  onVersionSelect={handleVersionSelect}
/>
```
  </action>
  <verify>
- Build passes: `npm run build`
- Lint passes: `npm run lint`
- TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Modal no longer has separate "Current" selection, uses latest version as current</done>
</task>

<task type="auto">
  <name>Task 4: Clean up arePromptsIdentical usage</name>
  <files>src/utils/diffUtils.ts</files>
  <action>
Keep the `arePromptsIdentical` function in diffUtils.ts - it's still useful for actual diff comparison purposes (determining if there are changes to show).

However, add a comment clarifying its purpose:
```typescript
/**
 * Compares two prompt-like objects to check if their content is identical.
 * Used for diff visualization (to show "no changes" message), not for UI flow control.
 *
 * Note: This should NOT be used to determine whether to show a "Current" entry
 * or control revert button visibility - those decisions are based on version position,
 * not content comparison.
 */
export function arePromptsIdentical(...) { ... }
```

Also verify it's not imported in VersionList.tsx or VersionHistoryModal.tsx after the refactor (should have been removed in Tasks 2-3).
  </action>
  <verify>
- Build passes: `npm run build`
- Grep for arePromptsIdentical: should only be in diffUtils.ts and not in VersionList/VersionHistoryModal
  </verify>
  <done>arePromptsIdentical documented and verified not used for UI flow control</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Fixed 4 UAT issues:
1. Versioning now captures NEW state (the content being saved)
2. Removed separate "Current" entry - latest version shows "(Current)" badge
3. Removed "unsaved changes" messaging
4. Cleaned up arePromptsIdentical usage

**New version history model:**
- Latest version IS current (no separate concept)
- Version N = content AFTER Nth save
- Revert button hidden on latest version (can't revert to what you're at)
  </what-built>
  <how-to-verify>
**Test 1: Version content is correct (UAT-011)**
1. Run: `npm run dev`
2. Create a new prompt with title "Test v1" and body "First version"
3. Save it
4. Edit title to "Test v2" and save
5. Open Version History
6. Select Version 1 - should show "Test v1" / "First version"
7. Select Version 2 (Current) - should show "Test v2" / body unchanged
8. Verify in database if needed: version content should match what was saved

**Test 2: No separate "Current" entry (UAT-012)**
1. In the version history modal
2. Version list should show "Version 2 (Current)" with green badge
3. There should NOT be a separate "Current" entry above the version list
4. Version 1 should be in the accordion, Version 2 (Current) should be in Today

**Test 3: No "unsaved changes" messaging (UAT-013)**
1. Search the entire modal for any text about "unsaved"
2. Should find none

**Test 4: Revert button visibility (UAT-003 rework)**
1. Select Version 2 (Current) - Revert button should be HIDDEN
2. Select Version 1 - Revert button should be visible
3. If you revert to Version 1, a new Version 3 (Current) is created
4. Select Version 3 (Current) - Revert should be hidden
5. Select Version 2 or 1 - Revert should be visible

**Test 5: Revert tracking (existing feature)**
1. After reverting, the new version should show "Reverted to V1" indicator
2. Detail view should show "This version was created by reverting to Version 1"
  </how-to-verify>
  <resume-signal>Type "approved" if all fixes work correctly, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-011: Version content is NEW state (verified in database)
- [ ] UAT-012: No separate "Current" entry, latest version has "(Current)" badge
- [ ] UAT-013: No "unsaved changes" text anywhere
- [ ] UAT-014: arePromptsIdentical not used for UI flow control
- [ ] Revert button correctly hidden on latest version
- [ ] Human verification passed
- [ ] `npm run build` passes
- [ ] `npm run lint` passes
</verification>

<success_criteria>
- All 4 UAT issues from re-test fixed
- Versioning model is correct (NEW state saved)
- UI reflects that latest version = current
- Ready for final UAT verification
</success_criteria>

<output>
After completion, create `.planning/phases/7.1-version-history-ui-enhancements/7.1-03-FIX2-SUMMARY.md`

Update STATE.md with fix completion.
</output>
