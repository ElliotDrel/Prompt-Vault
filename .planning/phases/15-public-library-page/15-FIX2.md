---
phase: 15-public-library-page
plan: 15-FIX2
type: fix
---

<objective>
Fix UAT-006: Public Library realtime subscription for cross-user updates.

Source: 15-UAT-ISSUES.md
Priority: 1 major issue

**Root Cause (from debugging session):**
The postgres_changes approach with RLS doesn't work for cross-user visibility updates because Supabase evaluates UPDATE events against the OLD row state. When a prompt changes from private→public, other users couldn't SELECT the old (private) row, so they never receive the event.

**Solution:**
Use Supabase Broadcast instead of postgres_changes for public prompt notifications. Broadcast bypasses RLS by sending direct client-to-client messages, while the actual data fetch still goes through RLS for security.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issue being fixed:**
@.planning/phases/15-public-library-page/15-UAT-ISSUES.md (UAT-006)

**Key files:**
- src/lib/storage/supabaseAdapter.ts (realtime subscription logic)
- src/hooks/usePublicPrompts.ts (library data hook)
- src/lib/storage/types.ts (storage adapter interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace postgres_changes with broadcast channel</name>
  <files>src/lib/storage/supabaseAdapter.ts</files>
  <action>
Replace the current postgres_changes public channel with a Supabase Broadcast channel:

1. Rename `publicChannel` property to `broadcastChannel` in class properties
2. In `setupSubscription()`:
   - Remove the postgres_changes listener for public prompts
   - Create a broadcast channel: `supabase.channel('public_prompts_broadcast')`
   - Listen for `public_prompt_changed` event
   - Call `this.notifySubscribers('publicPrompts')` when received
3. Update teardown logic to handle `broadcastChannel` instead of `publicChannel`

**Key insight:** The channel name `public_prompts_broadcast` should be the SAME for all users so everyone receives broadcasts. Unlike the broken approach with unique IDs, broadcast requires a shared channel name.
  </action>
  <verify>
- broadcastChannel property exists
- setupSubscription creates broadcast listener
- teardownChannel cleans up broadcastChannel
- No TypeScript errors
  </verify>
  <done>Broadcast channel subscription replaces broken postgres_changes approach</done>
</task>

<task type="auto">
  <name>Task 2: Add broadcast helper method</name>
  <files>src/lib/storage/supabaseAdapter.ts</files>
  <action>
Create a private helper method to send broadcast notifications:

```typescript
/**
 * Broadcast a notification that a public prompt has changed.
 * This notifies all users viewing the library to refresh their data.
 */
private async broadcastPublicPromptChange(): Promise<void> {
  try {
    await supabase.channel('public_prompts_broadcast').send({
      type: 'broadcast',
      event: 'public_prompt_changed',
      payload: {},
    });
  } catch (err) {
    // Non-critical: broadcast failure shouldn't break the main operation
    console.error('Failed to broadcast public prompt change:', err);
  }
}
```

Place this method near other private helper methods (after `notifySubscribers`).
  </action>
  <verify>
- Helper method exists with proper error handling
- Method sends to correct channel with correct event name
- No TypeScript errors
  </verify>
  <done>Broadcast helper method added</done>
</task>

<task type="auto">
  <name>Task 3: Send broadcast on visibility toggle</name>
  <files>src/lib/storage/supabaseAdapter.ts</files>
  <action>
In `toggleVisibility()` method, after successful database update:

```typescript
// Broadcast to notify all users viewing the library
// Handles both private→public and public→private transitions
void this.broadcastPublicPromptChange();
```

This ensures the Library page updates for:
- New public prompts appearing
- Prompts being removed from public view
  </action>
  <verify>
- toggleVisibility calls broadcastPublicPromptChange after success
- Uses `void` prefix to avoid unhandled promise warning
  </verify>
  <done>Visibility toggle triggers broadcast</done>
</task>

<task type="auto">
  <name>Task 4: Send broadcast on public prompt updates</name>
  <files>src/lib/storage/supabaseAdapter.ts</files>
  <action>
Add broadcast calls to methods that modify public prompts:

1. **updatePrompt()**: After successful update, if prompt is public:
   ```typescript
   if (updatedPrompt.visibility === 'public') {
     void this.broadcastPublicPromptChange();
   }
   ```

2. **deletePrompt()**: Before deletion, fetch prompt to check visibility, then broadcast if public:
   ```typescript
   const prompt = await fetchPromptRowById(userId, id);
   // ... delete logic ...
   if (prompt.visibility === 'public') {
     void this.broadcastPublicPromptChange();
   }
   ```

3. **incrementPromptUsage()**: After successful increment, if prompt is public:
   ```typescript
   if (updatedPrompt.visibility === 'public') {
     void this.broadcastPublicPromptChange();
   }
   ```
  </action>
  <verify>
- updatePrompt broadcasts for public prompts
- deletePrompt broadcasts for deleted public prompts
- incrementPromptUsage broadcasts for public prompts
  </verify>
  <done>All public prompt mutations trigger broadcast</done>
</task>

<task type="auto">
  <name>Task 5: Build verification and lint</name>
  <files>N/A</files>
  <action>
Run build and lint to ensure no errors:

```bash
npm run lint
npm run build
```

Fix any TypeScript or ESLint errors that arise.
  </action>
  <verify>
- `npm run lint` passes (warnings OK)
- `npm run build` succeeds
  </verify>
  <done>Code compiles and lints cleanly</done>
</task>

<task type="human">
  <name>Task 6: Manual testing - two-session realtime</name>
  <files>N/A</files>
  <action>
Test realtime updates across two browser sessions:

**Test 1: Private → Public**
1. Tab A: Open /library
2. Tab B: Toggle a prompt from private to public
3. Tab A: Should see prompt appear (no refresh needed)

**Test 2: Public → Private**
1. Tab A: Open /library (see the public prompt)
2. Tab B: Toggle same prompt from public to private
3. Tab A: Prompt should disappear (no refresh needed)

**Test 3: Edit public prompt**
1. Tab A: Open /library
2. Tab B: Edit a public prompt's title
3. Tab A: Should see title update (no refresh needed)

**Test 4: Cross-user (if possible)**
Repeat tests with two different user accounts.
  </action>
  <verify>
- All 4 test scenarios pass
- Library updates in real-time without manual refresh
- Console shows no errors
  </verify>
  <done>Realtime updates working for all visibility change scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Broadcast channel replaces broken postgres_changes
- [ ] All public prompt mutations trigger broadcasts
- [ ] Two-session testing confirms realtime works
- [ ] Build and lint pass
</verification>

<success_criteria>
- UAT-006 resolved: Library page receives realtime updates for cross-user changes
- No regression in existing functionality
- Ready for re-verification with /gsd:verify-work
</success_criteria>

<output>
After completion, create `.planning/phases/15-public-library-page/15-FIX2-SUMMARY.md`
</output>
