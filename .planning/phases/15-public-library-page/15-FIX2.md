---
phase: 15-public-library-page
plan: 15-FIX2
type: fix
---

<objective>
Fix 5 UAT issues from Phase 15 Round 2 testing.

Source: 15-UAT-ISSUES.md (UAT-006 through UAT-010)
Priority: 2 major, 3 minor

Purpose: Address realtime sync, author attribution, and UX consistency issues.
Output: All issues resolved, ready for Phase 16.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/15-public-library-page/15-UAT-ISSUES.md

**Key files to modify:**
@src/lib/storage/supabaseAdapter.ts
@src/hooks/usePublicPrompts.ts
@src/components/PromptCard.tsx
@src/components/PromptView.tsx
@src/components/VisibilityToggle.tsx
@src/components/PromptListView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-006 - Add realtime subscription for public prompts</name>
  <files>
    - src/lib/storage/supabaseAdapter.ts
    - src/lib/storage/types.ts
    - src/hooks/usePublicPrompts.ts
  </files>
  <action>
1. Update types.ts:
   - Add 'publicPrompts' to the subscriber callback event types

2. Update supabaseAdapter.ts setupSubscription():
   - Add a second subscription channel for public prompts:
     ```typescript
     .on('postgres_changes', {
       event: '*',
       schema: 'public',
       table: 'prompts',
       filter: `visibility=eq.public`
     }, (payload) => {
       this.notifySubscribers('publicPrompts', payload);
     })
     ```

3. Update usePublicPrompts.ts:
   - Add useEffect to subscribe to storage adapter events
   - When 'publicPrompts' event received, invalidate the query
   - Clean up subscription on unmount
  </action>
  <verify>
    - npm run build passes
    - Open Library in Tab A
    - In Tab B, toggle a prompt to public
    - Tab A updates without manual refresh
  </verify>
  <done>
    - Realtime subscription working for public prompts
    - Cross-user and same-user updates reflect immediately
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-008 - Display actual author name instead of "Anonymous"</name>
  <files>
    - src/lib/storage/supabaseAdapter.ts
    - src/components/PromptCard.tsx
  </files>
  <action>
1. Update supabaseAdapter.ts getPublicPrompts():
   - Create a database view or use a join to get user display names
   - Option A: Query auth.users directly (if RLS allows)
   - Option B: Create profiles table with trigger on auth.users insert
   - Option C: Use raw_user_meta_data->>'full_name' in query

   For simplest approach (Option C via SQL function):
   - Create an RPC function that returns prompts with author names
   - Or use a view that joins prompts with auth.users

2. Update mapRowToPublicPrompt():
   - Set displayName from the joined data
   - If no name available, use truncated userId as fallback

3. Update PromptCard.tsx:
   - Change fallback from 'Anonymous' to truncated userId
   - Format: first 8 chars of UUID (e.g., "44f2ca5f")
  </action>
  <verify>
    - npm run build passes
    - Go to /library
    - Cards show actual author name or truncated ID (not "Anonymous")
  </verify>
  <done>
    - Author names display correctly
    - Fallback shows truncated user ID
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-007 - Reposition visibility toggle in PromptView</name>
  <files>
    - src/components/PromptView.tsx
    - src/components/VisibilityToggle.tsx
  </files>
  <action>
1. Update PromptView.tsx:
   - Move VisibilityToggle to the header row (same row as back button)
   - Position it on the right side of the header
   - Layout: [Back button] ... [Visibility Toggle]

2. Update VisibilityToggle.tsx:
   - Restructure layout so label is ABOVE the toggle switch
   - Center the label over the toggle
   - Layout:
     ```
        Private
     [Lock] [===] [Globe]
     ```
  </action>
  <verify>
    - Open a prompt in detail view
    - Toggle is in header row, right-aligned
    - Label ("Private" or "Public") is centered above the toggle
  </verify>
  <done>
    - Toggle repositioned to header row
    - Label centered above toggle
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix UAT-009 - Show public icon on Library cards</name>
  <files>
    - src/components/PromptCard.tsx
  </files>
  <action>
1. Update PromptCard.tsx:
   - Remove the condition `effectiveSource === 'owned'` for visibility icon
   - Show globe icon on ALL cards that have visibility='public'
   - Keep tooltip: "Public - visible in the Prompt Library"
   - For Library cards (source='public'), always show globe icon
  </action>
  <verify>
    - Go to /library
    - All cards show globe icon with tooltip
    - Dashboard cards still show appropriate lock/globe icons
  </verify>
  <done>
    - Library cards show globe icon consistently
    - Tooltip works on hover
  </done>
</task>

<task type="auto">
  <name>Task 5: Fix UAT-010 - Update search placeholder to hint at scope</name>
  <files>
    - src/components/PromptListView.tsx
  </files>
  <action>
1. Update PromptListView.tsx:
   - Add a searchPlaceholder prop (optional)
   - Default: "Search prompts..."
   - For Library: "Search title, content, author..."
   - For Dashboard: "Search prompts..."

2. Update PublicLibrary.tsx to pass custom placeholder:
   - searchPlaceholder="Search title, content, author..."
  </action>
  <verify>
    - Go to /library - placeholder shows "Search title, content, author..."
    - Go to /dashboard - placeholder shows "Search prompts..."
  </verify>
  <done>
    - Search placeholder hints at searchable fields
    - Different placeholders per page context
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>All 5 UAT issues fixed: realtime subscription, author names, toggle position, library icons, search placeholder</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. **Realtime test**: Open Library in 2 tabs, toggle visibility in one - other updates automatically
    3. **Author test**: Library cards show actual names or truncated IDs (not "Anonymous")
    4. **Toggle test**: Open prompt detail - toggle in header row, label above switch
    5. **Icon test**: Library cards show globe icons with tooltips
    6. **Search test**: Library search placeholder says "Search title, content, author..."
  </how-to-verify>
  <resume-signal>Type "approved" or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 5 issues fixed (UAT-006 through UAT-010)
- [ ] npm run build passes
- [ ] npm run lint passes (or only pre-existing warnings)
- [ ] All verification steps pass
</verification>

<success_criteria>
- Realtime subscription works for public prompts
- Author names display correctly (name or truncated ID)
- Visibility toggle repositioned with label above
- Library cards show globe icons
- Search placeholder hints at scope
- Ready for Phase 16: Add to Vault
</success_criteria>

<output>
After completion, create `.planning/phases/15-public-library-page/15-FIX2-SUMMARY.md`
</output>
