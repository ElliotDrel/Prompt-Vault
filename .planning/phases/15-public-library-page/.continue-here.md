---
phase: 15-public-library-page
plan: 15-FIX2
task: 6
total_tasks: 6
status: pending_manual_testing
last_updated: 2026-01-17
---

<current_state>
UAT-006 fix implementation complete. All code changes committed. Awaiting manual testing to verify Supabase Broadcast works for cross-user Library updates.
</current_state>

<completed_work>
- Task 1: Replace postgres_changes with broadcast channel - Done (commit fb9b706)
- Task 2: Add broadcast helper method - Done (commit fb9b706)
- Task 3: Send broadcast on visibility toggle - Done (commit fb9b706)
- Task 4: Send broadcast on public prompt updates - Done (commit fb9b706)
- Task 5: Build verification and lint - Done (build passes, pre-existing lint warnings only)
</completed_work>

<remaining_work>
- Task 6: Manual testing - two-session realtime verification
  - Test 1: Private -> Public (prompt appears in other tab's Library)
  - Test 2: Public -> Private (prompt disappears from Library)
  - Test 3: Edit public prompt (title update visible in Library)
  - Test 4: Cross-user testing (different accounts if possible)
</remaining_work>

<decisions_made>
- Used Supabase Broadcast instead of postgres_changes because RLS evaluates against OLD row state, making cross-user visibility changes invisible
- Moved broadcast helper to module scope (not class method) since it doesn't depend on instance state and is called from SupabasePromptsAdapter
- Fire-and-forget pattern with `void` prefix - broadcast failure logged but doesn't break main operation
- Shared channel name `public_prompts_broadcast` for all users (unlike user-specific postgres_changes channels)
</decisions_made>

<blockers>
None. Implementation complete and builds cleanly.
</blockers>

<context>
The root cause of UAT-006 was that postgres_changes with RLS doesn't work for cross-user visibility updates. When a prompt changes from private->public, other users couldn't SELECT the old (private) row, so they never receive the postgres_changes event.

The fix uses Supabase Broadcast - a client-to-client messaging system that bypasses RLS for notifications. The actual data fetch (React Query refetch) still uses RLS for security. This is a proven pattern for cross-user notifications.

Key files modified:
- `src/lib/storage/supabaseAdapter.ts` - broadcast channel setup, helper function, mutation hooks
</context>

<next_action>
Run manual testing (Task 6):
1. Open two browser tabs (or two different browsers)
2. Tab A: Navigate to /library
3. Tab B: Navigate to /dashboard, toggle a prompt from private to public
4. Tab A: Verify the prompt appears in Library WITHOUT manual refresh

If tests pass, run `/gsd:verify-work` to complete UAT and close the phase.
If tests fail, debug the broadcast subscription and sender.
</next_action>
