---
phase: 15-public-library-page
plan: 15-FIX2
task: 6
total_tasks: 6
status: broken_fix_needed
last_updated: 2026-01-17
---

<current_state>
Attempted to fix broadcast issues but made things worse. Need to revert and try different approach.

The original issues were:
1. Broadcast channel teardown killing receive subscription
2. Broadcast sends without subscribing (REST fallback warnings)
3. Public prompt creation doesn't trigger broadcast
4. increment_prompt_usage RPC missing visibility column (copy doesn't trigger Library update)

The attempted fixes introduced new problems - user reports "this made it worse" but didn't provide specific console logs before pausing.
</current_state>

<completed_work>
- Task 1-5: Original 15-FIX2 implementation complete (commit fb9b706, 3240015)
- Task 6: Manual testing revealed issues
- Analysis: Identified 4 issues from console logs
- Migration: Applied 20260117135801_add_visibility_to_increment_prompt_usage.sql (already on remote)
</completed_work>

<remaining_work>
- Revert the broken adapter changes OR debug what went wrong
- Get console logs from user to understand what "made it worse" means
- Re-implement broadcast fix with correct approach
- Complete manual testing
- Run /gsd:verify-work to close phase
</remaining_work>

<decisions_made>
- Used module-level persistent channel for broadcast sending (may be wrong approach)
- Added async subscription before send (may be causing issues)
- Added broadcast in addPrompt for public prompts
- Migration adds visibility to increment_prompt_usage RPC return type
</decisions_made>

<blockers>
- Unknown: User said fixes "made it worse" but no console logs provided
- Need to understand what specifically broke before proceeding
</blockers>

<context>
The core problem is that Supabase Broadcast requires careful channel management:
1. Send and receive must use same channel name for messages to arrive
2. Calling removeChannel() on send channel was killing receive subscription
3. Attempted fix: persistent module-level channel with subscription before send
4. This approach may have introduced new timing/state issues

Alternative approaches to consider:
- Use httpSend() explicitly instead of subscribing then sending
- Share the SupabaseAdapter's broadcastChannel for both send/receive
- Investigate if supabase.channel() returns same instance for same name

Files modified (uncommitted):
- src/lib/storage/supabaseAdapter.ts - broadcast channel changes
- supabase/migrations/20260117135801_add_visibility_to_increment_prompt_usage.sql - new migration
</context>

<next_action>
1. Get console logs from user to understand what broke
2. Consider reverting adapter changes: git checkout src/lib/storage/supabaseAdapter.ts
3. Try simpler fix: just remove the removeChannel() call without adding subscription logic
4. Or try httpSend() approach which doesn't require subscription
</next_action>
