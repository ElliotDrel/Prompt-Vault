---
phase: 15-public-library-page
plan: 01
type: execute
---

<objective>
Add storage adapter method and React Query hook for fetching public prompts with author metadata.

Purpose: Enable the Public Library page to fetch all public prompts across users with proper author attribution.
Output: `getPublicPrompts()` storage method, `usePublicPrompts` hook, TypeScript types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency graph):
@.planning/phases/11-database-schema/11-SUMMARY.md
@.planning/phases/14-visibility-toggle/14-01-SUMMARY.md

# Key source files:
@src/lib/storage/types.ts
@src/lib/storage/supabaseAdapter.ts
@src/types/prompt.ts
@src/hooks/usePromptVersions.ts

**Tech stack available:**
- PostgreSQL enum `prompt_visibility` with 'private' | 'public'
- RLS policy: `(user_id = auth.uid() OR visibility = 'public')` on prompts table
- TanStack Query for server state caching
- Storage adapter pattern (interface + Supabase implementation)

**Established patterns:**
- Storage adapter methods return typed data, throw on error
- React Query hooks wrap adapter calls with caching
- Never call storage directly from components - use hooks

**Constraining decisions:**
- Phase 11: RLS already allows reading public prompts from any authenticated user
- Phase 14: Visibility toggle sets visibility = 'public' for shared prompts

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getPublicPrompts to storage adapter</name>
  <files>src/lib/storage/types.ts, src/lib/storage/supabaseAdapter.ts</files>
  <action>
1. In `types.ts`, add to `PromptsStorageAdapter` interface:
   ```typescript
   getPublicPrompts(): Promise<PublicPrompt[]>;
   ```
   Import `PublicPrompt` from `@/types/prompt`.

2. In `supabaseAdapter.ts`, implement `getPublicPrompts()`:
   - Query `prompts` table WHERE `visibility = 'public'`
   - Do NOT filter by `user_id` - we want ALL public prompts from all users
   - SELECT columns: id, user_id (as authorId), title, body, variables, updated_at, times_used, visibility
   - Order by updated_at DESC (most recently updated first)
   - Map rows to PublicPrompt type with:
     - `authorId: row.user_id`
     - `author: { userId: row.user_id, displayName: undefined }` (future: profile lookup)
     - `visibility: 'public'`
   - Return typed `PublicPrompt[]`

Note: This does NOT require auth.uid() check since RLS already handles visibility filtering. The RLS policy `(user_id = auth.uid() OR visibility = 'public')` allows any authenticated user to read public prompts.
  </action>
  <verify>TypeScript compiles with no errors: `npm run build`</verify>
  <done>
- `getPublicPrompts()` method exists in interface and implementation
- Returns PublicPrompt[] with authorId and author fields populated
- Build passes with no type errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usePublicPrompts hook</name>
  <files>src/hooks/usePublicPrompts.ts</files>
  <action>
Create new hook following the pattern from `usePromptVersions.ts`:

```typescript
import { useQuery } from '@tanstack/react-query';
import { useStorageAdapter } from '@/contexts/StorageAdapterContext';
import type { PublicPrompt } from '@/types/prompt';

interface UsePublicPromptsReturn {
  prompts: PublicPrompt[];
  loading: boolean;
  error: Error | null;
  refetch: () => Promise<void>;
}

export function usePublicPrompts(): UsePublicPromptsReturn {
  const adapter = useStorageAdapter();

  const {
    data,
    isLoading,
    error,
    refetch: queryRefetch,
  } = useQuery({
    queryKey: ['publicPrompts'],
    queryFn: async () => {
      if (!adapter) throw new Error('Storage adapter not available');
      return adapter.prompts.getPublicPrompts();
    },
    enabled: !!adapter,
    staleTime: 30000, // 30 seconds cache
  });

  const refetch = async () => {
    await queryRefetch();
  };

  return {
    prompts: data ?? [],
    loading: isLoading,
    error: error instanceof Error ? error : null,
    refetch,
  };
}
```

Key points:
- Uses TanStack Query for caching (30s stale time like other queries)
- Enabled only when adapter is available
- Returns empty array while loading (consistent with other hooks)
- Exposes refetch for manual refresh
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. Lint passes: `npm run lint`
  </verify>
  <done>
- `usePublicPrompts` hook exists in `src/hooks/usePublicPrompts.ts`
- Returns `{ prompts, loading, error, refetch }`
- Uses TanStack Query with 30s cache
- Build and lint pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] `getPublicPrompts()` method in storage adapter interface
- [ ] `getPublicPrompts()` implementation in Supabase adapter
- [ ] `usePublicPrompts` hook created
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Storage adapter extended with public prompt fetching
- Hook ready for use in PublicLibrary page (Plan 15-02)
</success_criteria>

<output>
After completion, create `.planning/phases/15-public-library-page/15-01-SUMMARY.md`
</output>
