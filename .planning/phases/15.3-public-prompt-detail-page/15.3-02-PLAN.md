---
phase: 15.3-public-prompt-detail-page
plan: 02
type: execute
wave: 2
depends_on: ["15.3-01"]
files_modified:
  - src/pages/PublicPromptDetail.tsx
  - src/components/PromptView.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /library/prompt/:promptId and see the public prompt"
    - "Non-owners see prompt without Edit, Delete, or Version History buttons"
    - "Owners see 'You're viewing this as others see it' banner with 'View in Dashboard' button"
    - "Missing/private prompts show 404 page with 'Back to Library' link"
    - "Dashboard view of public prompts shows 'View Public Version' button"
    - "Back button navigates to /library"
  artifacts:
    - path: "src/pages/PublicPromptDetail.tsx"
      provides: "Public prompt detail page component"
      exports: ["default"]
    - path: "src/components/PromptView.tsx"
      provides: "Enhanced with conditional props for public context"
      contains: "showVersionHistory"
    - path: "src/App.tsx"
      provides: "Route registration for /library/prompt/:promptId"
      contains: "/library/prompt/:promptId"
  key_links:
    - from: "src/pages/PublicPromptDetail.tsx"
      to: "usePublicPrompt"
      via: "hook import"
      pattern: "usePublicPrompt\\(promptId\\)"
    - from: "src/App.tsx"
      to: "PublicPromptDetail"
      via: "route element"
      pattern: "path=\"/library/prompt/:promptId\""
---

<objective>
Create PublicPromptDetail page and enhance PromptView with conditional rendering for public context.

Purpose: Resolve UAT-011 critical bug - clicking prompt cards in Public Library no longer 404s. Users can view, fill variables, and copy public prompts. Owners see a banner explaining they're viewing their prompt as others see it.

Output: Working /library/prompt/:promptId route with appropriate permissions-based UI.
</objective>

<execution_context>
@C:\Users\2supe\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\2supe\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.3-public-prompt-detail-page/15.3-CONTEXT.md
@.planning/phases/15.3-public-prompt-detail-page/15.3-RESEARCH.md
@.planning/phases/15.3-public-prompt-detail-page/15.3-01-SUMMARY.md
@src/pages/PromptDetail.tsx
@src/components/PromptView.tsx
@src/App.tsx
@src/hooks/usePublicPrompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance PromptView with Conditional Props</name>
  <files>src/components/PromptView.tsx</files>
  <action>
Modify PromptView to support public prompt context via optional props:

1. Update PromptViewProps interface:
```typescript
interface PromptViewProps {
  prompt: Prompt;
  onEdit?: () => void;        // undefined = hide Edit button (existing pattern)
  onDelete?: (promptId: string) => Promise<void>; // undefined = hide Delete
  onNavigateBack: () => void;
  backLabel?: string;         // NEW: "Back to Dashboard" vs "Back to Library"
  backRoute?: string;         // NEW: route for back navigation
  showVersionHistory?: boolean;  // NEW: defaults to true, hide for non-owners
  showVisibilityToggle?: boolean; // NEW: defaults to true, hide for non-owners

  // Owner viewing public prompt banner
  isOwnerViewingPublic?: boolean; // NEW: show "viewing as others see it" banner
  onViewInDashboard?: () => void; // NEW: action for "View in Dashboard" button

  // Dashboard symmetric navigation
  showViewPublicButton?: boolean; // NEW: show "View Public Version" button on dashboard
  onViewPublicVersion?: () => void; // NEW: action for public version button
}
```

2. Add conditional rendering for Version History button (around line 257):
```typescript
{(showVersionHistory ?? true) && (
  <Button variant="outline" onClick={() => setHistoryModalOpen(true)}>
    <History className="h-4 w-4 mr-2" />
    History
  </Button>
)}
```

3. Add conditional rendering for Edit button:
```typescript
{onEdit && (
  <Button onClick={onEdit} className="bg-primary hover:bg-primary/90">
    <Edit className="h-4 w-4 mr-2" />
    Edit
  </Button>
)}
```

4. Add owner banner above main content (after header row, before main card):
```typescript
{isOwnerViewingPublic && onViewInDashboard && (
  <div className="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-400 p-4 mb-6 rounded-r-lg">
    <div className="flex items-center justify-between flex-wrap gap-4">
      <p className="text-sm text-blue-700 dark:text-blue-300">
        You're viewing this as others see it
      </p>
      <Button
        variant="outline"
        size="sm"
        onClick={onViewInDashboard}
      >
        View in Dashboard
      </Button>
    </div>
  </div>
)}
```

5. Add "View Public Version" button for dashboard (near other action buttons):
```typescript
{showViewPublicButton && onViewPublicVersion && (
  <Button variant="outline" onClick={onViewPublicVersion}>
    <Globe className="h-4 w-4 mr-2" />
    View Public Version
  </Button>
)}
```

6. Update back button to use backLabel and backRoute props:
```typescript
<Button variant="ghost" className="-ml-2" asChild>
  <NavLink to={backRoute ?? DASHBOARD_ROUTE} onNavigate={onNavigateBack}>
    <ArrowLeft className="h-4 w-4 mr-2" />
    {backLabel ?? 'Back to Dashboard'}
  </NavLink>
</Button>
```

7. Conditionally render VisibilityToggle:
```typescript
{(showVisibilityToggle ?? true) && (
  <VisibilityToggle
    visibility={prompt.visibility ?? 'private'}
    onToggle={handleVisibilityToggle}
  />
)}
```

8. Conditionally render Delete button in footer (wrap existing AlertDialog):
```typescript
{onDelete && (
  <AlertDialog>
    ...existing delete dialog...
  </AlertDialog>
)}
```

9. Add Globe import at top:
```typescript
import { ArrowLeft, Edit, Pin, Trash2, Copy, Check, ChevronDown, ChevronRight, History, Globe } from 'lucide-react';
```

10. Also update the Version History modal rendering to respect showVersionHistory:
```typescript
{(showVersionHistory ?? true) && (
  <>
    <VersionHistoryModal ... />
    <RevertConfirmDialog ... />
  </>
)}
```

IMPORTANT: Keep all existing functionality intact. Only add conditional rendering. Default behavior should match current behavior (all features shown for owned prompts).
  </action>
  <verify>
- `npm run build` passes
- Existing PromptDetail page still shows all buttons (Edit, Delete, History, Visibility)
- No TypeScript errors about missing props (all new props are optional with defaults)
  </verify>
  <done>PromptView supports conditional rendering via optional props, defaults maintain current behavior</done>
</task>

<task type="auto">
  <name>Task 2: Create PublicPromptDetail Page</name>
  <files>src/pages/PublicPromptDetail.tsx</files>
  <action>
Create new page component as thin wrapper around PromptView:

```typescript
import React from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Loader2, AlertCircle, Globe } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import { usePrompts } from '@/contexts/PromptsContext';
import { Navigation } from '@/components/Navigation';
import { PromptView } from '@/components/PromptView';
import { Button } from '@/components/ui/button';
import { NavLink } from '@/components/ui/NavLink';
import { usePublicPrompt } from '@/hooks/usePublicPrompt';
import { LIBRARY_ROUTE } from '@/config/routes';

export default function PublicPromptDetail() {
  const { promptId } = useParams<{ promptId: string }>();
  const navigate = useNavigate();
  const { user } = useAuth();
  const { prompt, loading, error } = usePublicPrompt(promptId);
  const { togglePinPrompt, incrementCopyCount, incrementPromptUsage } = usePrompts();

  // Determine if current user is the owner of this public prompt
  const isOwner = prompt && prompt.authorId === user?.id;

  // Handle navigation back to library
  const handleNavigateBack = () => {
    navigate(LIBRARY_ROUTE);
  };

  // Handle navigation to dashboard view (for owner)
  const handleViewInDashboard = () => {
    if (promptId) {
      navigate(`/dashboard/prompt/${promptId}`);
    }
  };

  // Loading state
  if (loading) {
    return (
      <>
        <Navigation />
        <div className="min-h-screen flex items-center justify-center">
          <div className="text-center">
            <Loader2 className="h-12 w-12 animate-spin mx-auto mb-4 text-primary" />
            <p className="text-lg text-muted-foreground">Loading prompt...</p>
          </div>
        </div>
      </>
    );
  }

  // Error state or prompt not found
  if (error || !prompt) {
    return (
      <>
        <Navigation />
        <div className="min-h-screen flex items-center justify-center">
          <div className="text-center max-w-md">
            <AlertCircle className="h-16 w-16 mx-auto mb-4 text-muted-foreground" />
            <h2 className="text-2xl font-semibold mb-2">Prompt Not Found</h2>
            <p className="text-muted-foreground mb-6">
              This prompt doesn't exist or isn't publicly available.
            </p>
            <Button asChild className="bg-primary hover:bg-primary/90">
              <NavLink to={LIBRARY_ROUTE}>
                Back to Library
              </NavLink>
            </Button>
          </div>
        </div>
      </>
    );
  }

  return (
    <>
      <Navigation />
      <PromptView
        prompt={prompt}
        onEdit={undefined}           // Hide edit for public view
        onDelete={undefined}         // Hide delete for public view
        onNavigateBack={handleNavigateBack}
        backLabel="Back to Library"
        backRoute={LIBRARY_ROUTE}
        showVersionHistory={isOwner} // Only owner sees version history
        showVisibilityToggle={false} // Never show visibility toggle in public view
        isOwnerViewingPublic={isOwner}
        onViewInDashboard={isOwner ? handleViewInDashboard : undefined}
      />
    </>
  );
}
```

Key decisions:
- Uses usePublicPrompt hook for data fetching
- Hides Edit, Delete, Version History, Visibility Toggle for all viewers
- Shows owner banner only for owner (isOwner check)
- 404 page uses same message for both "not found" and "not public" (security)
- Back button goes to /library
  </action>
  <verify>
- `npm run build` passes
- File exports default component
- Uses LIBRARY_ROUTE constant (add to routes.ts if missing)
  </verify>
  <done>PublicPromptDetail.tsx exists with owner detection, conditional UI, and 404 handling</done>
</task>

<task type="auto">
  <name>Task 3: Register Route and Update Dashboard PromptView</name>
  <files>src/App.tsx, src/config/routes.ts, src/pages/PromptDetail.tsx</files>
  <action>
1. Add LIBRARY_ROUTE constant to config/routes.ts (if not exists):
```typescript
export const LIBRARY_ROUTE = '/library';
```

2. Add route to App.tsx (inside protected routes, after /library route):
```typescript
import PublicPromptDetail from "./pages/PublicPromptDetail";

// Add after the /library route:
<Route
  path="/library/prompt/:promptId"
  element={
    <RequireAuth>
      <PublicPromptDetail />
    </RequireAuth>
  }
/>
```

3. Update PromptDetail.tsx to add "View Public Version" button for public prompts:

Add navigate import usage and handler:
```typescript
// Add after handleNavigateBack:
const handleViewPublicVersion = () => {
  if (promptId) {
    navigate(`/library/prompt/${promptId}`);
  }
};
```

Update PromptView rendering to include new props:
```typescript
<PromptView
  prompt={prompt}
  onEdit={() => setIsEditing(true)}
  onDelete={handleDelete}
  onNavigateBack={handleNavigateBack}
  showViewPublicButton={prompt.visibility === 'public'}
  onViewPublicVersion={prompt.visibility === 'public' ? handleViewPublicVersion : undefined}
/>
```

This enables symmetrical navigation: Dashboard public prompts can navigate to Library view, and Library view can navigate back to Dashboard (if owner).
  </action>
  <verify>
- `npm run build` passes
- Route /library/prompt/:promptId is registered in App.tsx
- Navigating to /library/prompt/some-id loads PublicPromptDetail component
- Dashboard view of public prompts shows "View Public Version" button
  </verify>
  <done>Route registered, symmetric navigation works between Dashboard and Library views</done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `npm run lint` passes without errors
3. Navigate to /library/prompt/:validPublicId - shows prompt with no Edit/Delete buttons
4. Navigate to /library/prompt/:invalidId - shows 404 page with "Back to Library" link
5. Owner views their public prompt via Library - sees banner with "View in Dashboard" button
6. Owner views their public prompt via Dashboard - sees "View Public Version" button
7. Click "View in Dashboard" navigates to /dashboard/prompt/:id
8. Click "View Public Version" navigates to /library/prompt/:id
9. Back button on public prompt detail navigates to /library
</verification>

<success_criteria>
- UAT-011 resolved: Clicking prompt cards in Library opens detail page instead of 404
- Non-owners can view, fill variables, and copy public prompts
- Non-owners cannot edit, delete, or see version history
- Owners see "viewing as others see it" banner with navigation to Dashboard
- Dashboard shows "View Public Version" for public prompts
- Symmetric navigation between workspace and community views
</success_criteria>

<output>
After completion, create `.planning/phases/15.3-public-prompt-detail-page/15.3-02-SUMMARY.md`
</output>
