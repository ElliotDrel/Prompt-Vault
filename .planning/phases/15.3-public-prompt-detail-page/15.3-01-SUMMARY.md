---
phase: 15.3
plan: 01
subsystem: data-layer
tags: [supabase, react-query, storage-adapter, hooks, public-prompts]
requires: [15-public-library-page]
provides:
  - getPublicPromptById storage method
  - usePublicPrompt React hook
affects: [15.3-02-public-prompt-detail-component]
tech-stack:
  added: []
  patterns: [single-item-fetch-with-cache, realtime-invalidation]
decisions:
  - id: public-prompt-security
    choice: Return null for both non-existent and private prompts
    rationale: Same behavior prevents revealing existence of private prompts
  - id: query-key-isolation
    choice: Include promptId in query key ['publicPrompt', promptId]
    rationale: Proper cache isolation per prompt ID
key-files:
  created:
    - src/hooks/usePublicPrompt.ts
  modified:
    - src/lib/storage/types.ts
    - src/lib/storage/supabaseAdapter.ts
metrics:
  duration: 3 minutes
  tasks: 2
  commits: 2
completed: 2026-01-31
---

# Phase 15.3 Plan 01: Data Layer for Public Prompt Detail Summary

**One-liner:** Storage adapter method and React hook for fetching single public prompts with author info, caching, and realtime updates.

## What Was Built

Added data layer infrastructure for fetching individual public prompts by ID:

1. **Storage Adapter Method**: `getPublicPromptById(promptId: string): Promise<PublicPrompt | null>`
   - Added to PromptsStorageAdapter interface
   - Implemented in SupabasePromptsAdapter
   - Filters by both `id` AND `visibility='public'` for security
   - Returns null for non-existent or private prompts (same behavior)
   - Uses existing `mapPublicPromptRow` to include author metadata

2. **React Hook**: `usePublicPrompt(promptId: string | undefined)`
   - TanStack Query integration with 30 second stale time
   - Conditional fetching (enabled when adapter and promptId exist)
   - Realtime subscription to publicPrompts events
   - Query key isolation: `['publicPrompt', promptId]`
   - Returns `{ prompt, loading, error, refetch }`

## Task Breakdown

### Task 1: Add getPublicPromptById to Storage Adapter
- **Commit**: `7c53cce` - feat(15.3-01): add getPublicPromptById storage method
- **Files**: `src/lib/storage/types.ts`, `src/lib/storage/supabaseAdapter.ts`
- **Changes**:
  - Added method signature to interface
  - Implemented method with security-conscious filtering
  - Uses `.maybeSingle()` to return null when not found

### Task 2: Create usePublicPrompt Hook
- **Commit**: `4b70ce3` - feat(15.3-01): create usePublicPrompt hook
- **Files**: `src/hooks/usePublicPrompt.ts`
- **Changes**:
  - Created hook following usePublicPrompts.ts pattern
  - TanStack Query with enabled flag for conditional fetching
  - Realtime subscription for cache invalidation
  - Proper TypeScript typing and JSDoc documentation

## Technical Decisions Made

### 1. Security-First Null Return
**Decision**: Return `null` for both "not found" AND "not public" prompts.

**Rationale**: Prevents leaking information about existence of private prompts. An attacker shouldn't be able to distinguish between "this prompt doesn't exist" and "this prompt exists but is private."

**Implementation**: Filter by both `id` AND `visibility='public'` in the query.

### 2. Query Key Isolation
**Decision**: Include `promptId` in the query key: `['publicPrompt', promptId]`

**Rationale**: TanStack Query needs unique keys per resource to cache correctly. Without the promptId in the key, all prompt detail pages would share the same cache entry.

**Benefit**: Proper cache isolation, navigation between prompts works correctly, back/forward browser buttons leverage cached data.

### 3. Realtime Subscription Pattern
**Decision**: Subscribe to `publicPrompts` events and invalidate specific prompt query.

**Rationale**: When ANY public prompt changes, invalidate the cache for this specific prompt. Ensures the detail page shows up-to-date data when navigating from Library after a broadcast.

**Trade-off**: Slightly over-aggressive (invalidates even if this specific prompt didn't change), but simpler than tracking per-prompt updates.

## Patterns Established

### Single-Item Fetch with Cache
Pattern for fetching individual resources with TanStack Query:
```typescript
useQuery({
  queryKey: ['resourceType', resourceId],
  queryFn: async () => adapter.getResourceById(resourceId),
  enabled: !!adapter && !!resourceId,
  staleTime: 30000,
})
```

Benefits:
- Conditional fetching (waits for adapter and ID)
- Proper cache isolation per resource
- Consistent stale time across similar queries

### Realtime Invalidation for Single Items
Pattern for invalidating cached resources on realtime updates:
```typescript
useEffect(() => {
  if (!adapter?.subscribe || !resourceId) return;
  const unsubscribe = adapter.subscribe((type) => {
    if (type === 'resourceType') {
      void queryClient.invalidateQueries({ queryKey: ['resourceType', resourceId] });
    }
  });
  return () => unsubscribe();
}, [adapter, resourceId, queryClient]);
```

Benefits:
- Automatic cache updates when data changes
- Works across browser tabs/windows
- No manual refetch coordination needed

## Deviations from Plan

None - plan executed exactly as written.

## Testing & Verification

### Build Verification
```bash
npm run build
# ✓ 2540 modules transformed
# ✓ built in 23-25s
```

### Lint Verification
```bash
npm run lint
# ✓ 0 errors, 16 pre-existing Fast Refresh warnings (acknowledged)
```

### Type Safety
- PromptsStorageAdapter interface enforces method signature
- TypeScript ensures all implementations match interface
- Return type `PublicPrompt | null` enforced at compile time

## Integration Points

### Upstream Dependencies
- **Phase 15**: Public Library infrastructure (PublicPrompt type, mapPublicPromptRow helper)
- **Supabase RLS**: Policy allows authenticated users to read public prompts

### Downstream Consumers
- **Plan 15.3-02**: PublicPromptDetail component will use `usePublicPrompt` hook
- **Future plans**: Any component needing single public prompt data

### API Surface
Exported for use in components:
```typescript
// src/hooks/usePublicPrompt.ts
export function usePublicPrompt(promptId: string | undefined): UsePublicPromptReturn
```

## Next Phase Readiness

### What's Ready
- Data layer complete for fetching single public prompts
- Hook provides proper loading/error/data states
- Realtime updates configured
- Security model implemented (null for private/missing)

### What's Next (Plan 15.3-02)
- Create PublicPromptDetail.tsx component
- Use usePublicPrompt hook to fetch data
- Display prompt with author info (read-only)
- Handle loading, error, and not-found states
- Add "Copy" and "Add to Vault" actions

### Blockers/Concerns
None. All dependencies satisfied, implementation clean and tested.

## Lessons Learned

### What Went Well
1. **Pattern Reuse**: Following usePublicPrompts.ts pattern made implementation straightforward
2. **Security Conscious**: Considered information leakage from the start
3. **Type Safety**: Strong typing caught potential issues early
4. **Realtime Ready**: Infrastructure supports live updates out of the box

### What to Watch
1. **Over-invalidation**: Realtime subscription invalidates on any public prompt change, not just this specific prompt. Monitor if this causes performance issues at scale.
2. **Cache Duration**: 30 second stale time might be too long if prompts update frequently. Adjust if needed.

## Stats

- **Duration**: 3 minutes
- **Tasks**: 2 of 2 completed
- **Commits**: 2
- **Files Created**: 1 (usePublicPrompt.ts)
- **Files Modified**: 2 (types.ts, supabaseAdapter.ts)
- **Lines Added**: ~100
- **Build Time**: 23-25 seconds
- **Lint**: Clean (0 errors)
