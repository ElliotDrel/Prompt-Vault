---
phase: 03-storage-adapter-integration
plan: 01
type: execute
---

<objective>
Create SupabaseVersionsAdapter class implementing version CRUD operations and wire it into the main SupabaseAdapter.

Purpose: Establish the storage layer foundation for version tracking, providing methods to create, retrieve, and consolidate version snapshots through Supabase RPC functions.
Output: Working SupabaseVersionsAdapter class integrated into SupabaseAdapter with realtime subscription support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-functions-types/02-04-SUMMARY.md
@src/lib/storage/types.ts
@src/lib/storage/supabaseAdapter.ts
@src/types/prompt.ts

**Tech stack available:**
- Supabase client with RPC function support
- TypeScript interfaces (PromptVersion, PaginatedVersions, VersionsStorageAdapter)
- Existing adapter patterns (SupabasePromptsAdapter, SupabaseCopyEventsAdapter, SupabaseStatsAdapter)

**Established patterns:**
- Adapter classes implement specific storage interfaces
- Row mapping functions transform database snake_case to camelCase
- requireUserId() for authentication checks
- Error handling with descriptive messages
- Composition pattern: SupabaseAdapter contains sub-adapters

**Constraining decisions:**
- Version numbers controlled by application, not database (Phase 1)
- Immutable snapshots stored in prompt_versions table (Phase 1)
- RPC functions handle version CRUD: create_prompt_version, get_prompt_versions, consolidate_prompt_versions (Phase 2)
- Realtime publication enabled for prompt_versions table (Phase 1)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SupabaseVersionsAdapter class</name>
  <files>src/lib/storage/supabaseAdapter.ts</files>
  <action>
Create SupabaseVersionsAdapter class implementing VersionsStorageAdapter interface. Add three methods:

1. **createVersion**: Call create_prompt_version RPC with snake_case params (prompt_id, version_number, title, body, variables). Map result to PromptVersion interface using mapVersionRow helper. Include userId from requireUserId() for validation context.

2. **getVersions**: Call get_prompt_versions RPC with prompt_id and optional offset/limit. Map results to PaginatedVersions with versions array (using mapVersionRow), hasMore flag, totalCount. Default pagination: offset=0, limit=25.

3. **consolidateVersions**: Call consolidate_prompt_versions RPC with prompt_id. Return count of consolidated versions.

Add mapVersionRow helper function that transforms database row (id, prompt_id, user_id, version_number, title, body, variables, is_consolidated, consolidation_group_id, created_at) to PromptVersion interface (camelCase properties).

Follow existing adapter patterns: async/await, error handling with descriptive messages, requireUserId() for auth checks. Place class definition after SupabaseStatsAdapter, before SupabaseAdapter.
  </action>
  <verify>TypeScript compilation succeeds with no errors. Class implements VersionsStorageAdapter interface correctly. All methods return properly typed Promises.</verify>
  <done>SupabaseVersionsAdapter class exists with createVersion, getVersions, consolidateVersions methods and mapVersionRow helper. Methods match RPC function signatures. Error handling consistent with existing adapters.</done>
</task>

<task type="auto">
  <name>Task 2: Wire SupabaseVersionsAdapter into SupabaseAdapter</name>
  <files>src/lib/storage/supabaseAdapter.ts</files>
  <action>
Add versions property to SupabaseAdapter class:

1. Add `public versions: VersionsStorageAdapter;` property declaration after stats property.

2. In constructor, initialize: `this.versions = new SupabaseVersionsAdapter();`

3. Update realtime subscription in setupSubscription method to listen for prompt_versions table changes:
   - Add third `.on('postgres_changes', ...)` block for prompt_versions table
   - Filter: `user_id=eq.${userId}`
   - Events: '*' (INSERT, UPDATE, DELETE)
   - Callback: Currently no 'versions' event type in subscribe callback signature, so comment noting future support or trigger 'prompts' refresh (versions affect prompt context)

Do NOT modify subscribe callback signature (that's a breaking change for contexts). For now, trigger 'prompts' event when versions change to refresh prompt data in contexts. Future phases will add dedicated version refresh logic.
  </action>
  <verify>TypeScript compilation succeeds. SupabaseAdapter has versions property. Constructor initializes SupabaseVersionsAdapter. Realtime subscription includes prompt_versions table (verify with grep for 'prompt_versions').</verify>
  <done>SupabaseAdapter.versions property exists and is initialized. Realtime subscription monitors prompt_versions table. StorageAdapter interface contract satisfied (versions property required).</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] SupabaseVersionsAdapter class implements all three required methods
- [ ] mapVersionRow helper correctly maps database columns to camelCase
- [ ] SupabaseAdapter has versions property initialized in constructor
- [ ] Realtime subscription includes prompt_versions table monitoring
</verification>

<success_criteria>

- All tasks completed
- TypeScript compilation passes
- SupabaseVersionsAdapter class follows existing adapter patterns
- Integration into SupabaseAdapter maintains composition pattern
- No breaking changes to existing contexts or components
</success_criteria>

<output>
After completion, create `.planning/phases/03-storage-adapter-integration/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Create SupabaseVersionsAdapter Summary

**[Substantive one-liner - what shipped, not "plan complete"]**

## Accomplishments

- Created SupabaseVersionsAdapter class with three methods
- Added mapVersionRow helper for database-to-interface transformation
- Wired versions property into SupabaseAdapter composition
- Extended realtime subscription to monitor prompt_versions table

## Files Created/Modified

- `src/lib/storage/supabaseAdapter.ts` - Added SupabaseVersionsAdapter class, wired into SupabaseAdapter, updated realtime subscription

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-02-PLAN.md (Integrate version tracking into CRUD operations)
</output>
