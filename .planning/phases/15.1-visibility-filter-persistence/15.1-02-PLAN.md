---
phase: 15.1-visibility-filter-persistence
plan: 02
type: execute
---

<objective>
Extend filter hooks with visibility filtering and persistence logic.

Purpose: Connect UI state to database persistence and add visibility filtering capability.
Output: useURLFilterSync and usePromptFilters extended with visibility filter support and DB persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.1-visibility-filter-persistence/15.1-CONTEXT.md
@.planning/phases/15.1-visibility-filter-persistence/15.1-RESEARCH.md
@.planning/phases/15.1-visibility-filter-persistence/15.1-01-SUMMARY.md

**Key files:**
@src/hooks/useURLFilterSync.ts
@src/hooks/usePromptFilters.ts
@src/lib/storage/types.ts
@src/types/prompt.ts

**Constraining decisions:**
- Phase 13: Controlled mode support via controlledState prop
- Phase 15-FIX: Unified search pattern already working
- RESEARCH: URL-first, DB-second update pattern
- Issue 10: Author click should use author filter state without overwriting search (ensure hooks support this)

**From 15.1-01:**
- FilterPreferences type available from storage/types.ts
- getFilterPreferences() and updateFilterPreferences() available on adapter
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useURLFilterSync with visibility filter and persistence</name>
  <files>src/hooks/useURLFilterSync.ts</files>
  <action>
1. Add visibility filter state and URL param sync:
```typescript
// Import types from storage/types.ts
import { VisibilityFilter, SortBy, SortDirection } from '@/lib/storage/types';

// Add to state
const [visibilityFilter, setVisibilityFilterState] = useState<VisibilityFilter>(() => {
  const param = searchParams.get('visibility');
  if (param === 'public' || param === 'private') return param;
  return 'all';
});

// Sync to URL (only show non-default values)
useEffect(() => {
  if (visibilityFilter !== 'all') {
    searchParams.set('visibility', visibilityFilter);
  } else {
    searchParams.delete('visibility');
  }
  // ... existing URL update logic
}, [visibilityFilter]);
```

2. Add persistence integration (optional hook parameter):
```typescript
interface UseURLFilterSyncOptions {
  debounceMs?: number;
  persistToDb?: boolean;  // NEW: Enable DB persistence
  adapter?: StatsStorageAdapter;  // Pass adapter for persistence
}
```

3. Load initial values from DB when available:
```typescript
// On mount, if persistToDb is true, load from DB
useEffect(() => {
  if (persistToDb && adapter) {
    adapter.getFilterPreferences().then(prefs => {
      // Only apply DB values if URL doesn't have explicit values
      if (!searchParams.has('visibility')) setVisibilityFilterState(prefs.filterVisibility);
      if (!searchParams.has('sort')) setSortByState(prefs.sortBy);
      if (!searchParams.has('dir')) setSortDirectionState(prefs.sortDirection);
    });
  }
}, []);
```

4. Persist on change (debounced):
```typescript
const debouncedPersist = useMemo(() =>
  debounce((prefs: Partial<FilterPreferences>) => {
    if (persistToDb && adapter) {
      adapter.updateFilterPreferences(prefs).catch(console.error);
    }
  }, 500),
  [persistToDb, adapter]
);

const setVisibilityFilter = useCallback((v: VisibilityFilter) => {
  setVisibilityFilterState(v);
  debouncedPersist({ filterVisibility: v });
}, [debouncedPersist]);
```

5. Return new values in hook interface:
```typescript
return {
  // ... existing
  visibilityFilter,
  setVisibilityFilter,
};
```

AVOID: Blocking UI on DB load - use URL params immediately, then overlay DB values if no URL params present.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Existing tests/pages still work (no breaking changes to existing return values).
  </verify>
  <done>
- useURLFilterSync has visibilityFilter state
- URL param ?visibility= syncs correctly
- DB persistence loads on mount (when enabled)
- DB persistence saves on change (debounced)
- Existing API preserved (non-breaking)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend usePromptFilters with visibility filtering logic</name>
  <files>src/hooks/usePromptFilters.ts, src/types/prompt.ts</files>
  <action>
1. Update types in prompt.ts if needed:
```typescript
// Ensure Prompt type has visibility field (should exist from Phase 14)
export interface Prompt {
  // ... existing fields
  visibility: 'public' | 'private';
}
```

2. Extend controlledState interface in usePromptFilters:
```typescript
interface ControlledFilterState {
  // ... existing
  visibilityFilter?: VisibilityFilter;
  setVisibilityFilter?: (v: VisibilityFilter) => void;
}
```

3. Add visibility filtering in the memoized filter chain:
```typescript
const filteredPrompts = useMemo(() => {
  let result = prompts;

  // Visibility filter (NEW - apply first)
  if (visibilityFilter && visibilityFilter !== 'all') {
    result = result.filter(p => p.visibility === visibilityFilter);
  }

  // Search filter (existing)
  if (searchTerm) {
    const lower = searchTerm.toLowerCase();
    result = result.filter(p =>
      p.title.toLowerCase().includes(lower) ||
      p.body.toLowerCase().includes(lower) ||
      p.author?.displayName?.toLowerCase().includes(lower)
    );
  }

  // Sort (existing)
  // ...

  return result;
}, [prompts, visibilityFilter, searchTerm, sortBy, sortDirection, pinFirst]);
```

4. Expose visibility filter in return value:
```typescript
return {
  // ... existing
  visibilityFilter,
  setVisibilityFilter,
};
```

5. Add createdAt sort option (from CONTEXT.md requirements):
```typescript
// In sort logic
if (sortBy === 'createdAt') {
  comparison = new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
}
```

AVOID: Breaking existing search/sort behavior - visibility filter is additive, applied before other filters.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Run app, verify existing filter behavior unchanged on Dashboard.
  </verify>
  <done>
- usePromptFilters accepts visibilityFilter in controlledState
- Visibility filtering works (all/public/private)
- createdAt sort option works
- Existing search and sort behavior preserved
- Hook returns visibilityFilter state
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Dashboard still works with existing filters
- [ ] No regressions in search/sort behavior
</verification>

<success_criteria>
- useURLFilterSync has visibility filter with URL sync + DB persistence
- usePromptFilters filters by visibility when provided
- createdAt sort option added
- All changes are non-breaking to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/15.1-visibility-filter-persistence/15.1-02-SUMMARY.md`
</output>
