---
phase: 15.1-visibility-filter-persistence
plan: 01
type: execute
---

<objective>
Add filter preference columns to database and storage adapter methods for persistence.

Purpose: Establish the data layer for persisting user filter/sort preferences across sessions.
Output: Database schema extended, adapter methods for reading/writing preferences.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.1-visibility-filter-persistence/15.1-CONTEXT.md
@.planning/phases/15.1-visibility-filter-persistence/15.1-RESEARCH.md
@.planning/phases/15-public-library-page/15-FIX-SUMMARY.md

**Key files:**
@src/lib/storage/types.ts
@src/lib/storage/supabaseAdapter.ts
@supabase/migrations/

**Constraining decisions:**
- Phase 15-FIX: Unified search over URL filters (simpler UX)
- Phase 13: Controlled mode support in usePromptFilters for external state management
- user_settings table already exists with RLS policies

**From RESEARCH.md:**
- Extend user_settings table with filter columns
- Follow StatsStorageAdapter pattern for reading preferences
- Add mutation method for updating preferences
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter preference columns to user_settings</name>
  <files>supabase/migrations/[timestamp]_add_filter_preferences.sql</files>
  <action>
Create migration to add filter preference columns to user_settings table:

```sql
ALTER TABLE public.user_settings
ADD COLUMN IF NOT EXISTS filter_visibility TEXT NOT NULL DEFAULT 'all',
ADD COLUMN IF NOT EXISTS filter_author TEXT NOT NULL DEFAULT 'all',
ADD COLUMN IF NOT EXISTS sort_by TEXT NOT NULL DEFAULT 'lastUpdated',
ADD COLUMN IF NOT EXISTS sort_direction TEXT NOT NULL DEFAULT 'desc';

-- Add CHECK constraints for valid values
ALTER TABLE public.user_settings
ADD CONSTRAINT filter_visibility_check CHECK (filter_visibility IN ('all', 'public', 'private')),
ADD CONSTRAINT filter_author_check CHECK (filter_author IN ('all', 'mine', 'others')),
ADD CONSTRAINT sort_by_check CHECK (sort_by IN ('name', 'lastUpdated', 'createdAt', 'usage')),
ADD CONSTRAINT sort_direction_check CHECK (sort_direction IN ('asc', 'desc'));
```

Run `npx supabase db push` to apply migration to remote database.

AVOID: Creating a separate table for filter preferences - extend user_settings to keep all user preferences together.
  </action>
  <verify>
Run: `npx supabase db push`
Query via MCP: `SELECT column_name, data_type, column_default FROM information_schema.columns WHERE table_name = 'user_settings' AND table_schema = 'public';`
Verify 4 new columns exist with correct defaults.
  </verify>
  <done>
- Migration applied successfully
- user_settings has filter_visibility, filter_author, sort_by, sort_direction columns
- CHECK constraints prevent invalid values
- Existing rows have default values
  </done>
</task>

<task type="auto">
  <name>Task 2: Add filter preference methods to storage adapter</name>
  <files>src/lib/storage/types.ts, src/lib/storage/supabaseAdapter.ts</files>
  <action>
1. Add FilterPreferences type to types.ts:
```typescript
export type VisibilityFilter = 'all' | 'public' | 'private';
export type AuthorFilter = 'all' | 'mine' | 'others';
export type SortBy = 'name' | 'lastUpdated' | 'createdAt' | 'usage';
export type SortDirection = 'asc' | 'desc';

export interface FilterPreferences {
  filterVisibility: VisibilityFilter;
  filterAuthor: AuthorFilter;
  sortBy: SortBy;
  sortDirection: SortDirection;
}
```

2. Extend StatsStorageAdapter interface with filter methods:
```typescript
export interface StatsStorageAdapter {
  getStats(): Promise<{ ... }>;
  getFilterPreferences(): Promise<FilterPreferences>;
  updateFilterPreferences(prefs: Partial<FilterPreferences>): Promise<void>;
}
```

3. Implement in SupabaseStatsAdapter:
- getFilterPreferences(): Query user_settings, return defaults if no row
- updateFilterPreferences(): Upsert to user_settings with only changed fields

Follow existing pattern from getStats() for defaults when no data.

AVOID: Creating a separate adapter class - keep filter preferences with stats adapter since both read from user_settings.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Manually test by adding temporary console.log and calling getFilterPreferences() after auth.
  </verify>
  <done>
- FilterPreferences type exported from types.ts
- StatsStorageAdapter interface has getFilterPreferences and updateFilterPreferences
- SupabaseStatsAdapter implements both methods
- getFilterPreferences returns correct defaults for new users
- updateFilterPreferences successfully updates user_settings
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx supabase db push` succeeded
- [ ] `npx tsc --noEmit` passes
- [ ] user_settings table has 4 new columns via MCP query
- [ ] Adapter methods compile without errors
</verification>

<success_criteria>
- Database schema extended with filter preference columns
- Storage adapter can read and write filter preferences
- Existing users get default values
- TypeScript types properly defined
</success_criteria>

<output>
After completion, create `.planning/phases/15.1-visibility-filter-persistence/15.1-01-SUMMARY.md`
</output>
