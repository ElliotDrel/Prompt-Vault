# Phase 15.1: Visibility Filter Persistence - Research

**Researched:** 2026-01-16
**Domain:** Internal codebase patterns (filter system extension)
**Confidence:** HIGH

## Summary

Researched the existing codebase architecture for extending the filter/sort system. The architecture is well-established with clear patterns to follow. Key insight: the filter system uses a controlled component pattern where `useURLFilterSync` owns state and passes it to `usePromptFilters` via `controlledState` prop.

**Primary recommendation:** Extend existing hooks and components rather than creating new ones. Add visibility/author filters to `useURLFilterSync`, extend filtering logic in `usePromptFilters`, add chip UI to `PromptListView`, and persist preferences to `user_settings` table.

## Existing Architecture

### Filter System Flow
```
Page (Dashboard/PublicLibrary)
├── useURLFilterSync()           # URL params + initial state
│   └── returns state + setters
├── usePromptFilters({ controlledState })  # Filter logic
│   └── memoized filtering/sorting
└── PromptListView               # UI rendering
    ├── Search input
    ├── Sort buttons
    └── Grid of cards
```

### Current Hook Interfaces

**useURLFilterSync returns:**
```typescript
{
  searchTerm: string;
  sortBy: SortBy;                    // 'name' | 'lastUpdated' | 'usage'
  sortDirection: SortDirection;      // 'asc' | 'desc'
  authorFilter: string | null;       // Already exists, not fully used
  setSearchTerm, setSortBy, setSortDirection, setAuthorFilter, toggleSortDirection, clearFilters
}
```

**usePromptFilters returns:**
```typescript
{
  filteredPrompts: Prompt[];
  searchTerm, sortBy, sortDirection;
  setSearchTerm, setSortBy, setSortDirection, toggleSortDirection;
  hasResults, isEmpty, isFiltered;
}
```

### user_settings Table
```sql
CREATE TABLE user_settings (
    user_id UUID PRIMARY KEY REFERENCES auth.users(id),
    time_saved_multiplier INTEGER NOT NULL DEFAULT 5,
    default_visibility prompt_visibility NOT NULL DEFAULT 'private',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

## Extension Points

### 1. Database Schema Extension
Add columns to `user_settings`:
```sql
ALTER TABLE user_settings
ADD COLUMN filter_visibility TEXT DEFAULT 'all',      -- 'all' | 'public' | 'private'
ADD COLUMN filter_author TEXT DEFAULT 'all',          -- 'all' | 'mine' | 'others'
ADD COLUMN sort_by TEXT DEFAULT 'lastUpdated',        -- 'name' | 'lastUpdated' | 'createdAt' | 'usage'
ADD COLUMN sort_direction TEXT DEFAULT 'desc';        -- 'asc' | 'desc'
```

### 2. Storage Adapter Extension
Add to `StatsStorageAdapter` or create new `SettingsStorageAdapter`:
```typescript
interface FilterPreferences {
  filterVisibility: 'all' | 'public' | 'private';
  filterAuthor: 'all' | 'mine' | 'others';
  sortBy: SortBy;
  sortDirection: SortDirection;
}

// Methods to add:
getFilterPreferences(): Promise<FilterPreferences>;
updateFilterPreferences(prefs: Partial<FilterPreferences>): Promise<void>;
```

### 3. Hook Extensions

**useURLFilterSync** - Add visibility filter:
```typescript
// New state
visibilityFilter: VisibilityFilter;           // 'all' | 'public' | 'private'
setVisibilityFilter: (v: VisibilityFilter) => void;

// New URL param: ?visibility=public
```

**usePromptFilters** - Add visibility filtering logic:
```typescript
// In memoized filter logic
if (visibilityFilter !== 'all') {
  filtered = filtered.filter(p => p.visibility === visibilityFilter);
}
```

### 4. PromptListView Extension
Add filter chips above or alongside search:
```tsx
<div className="flex gap-2">
  {/* Visibility chips */}
  <ChipGroup
    options={['all', 'public', 'private']}
    selected={visibilityFilter}
    onChange={onVisibilityChange}
  />

  {/* Author chips (only on Library page) */}
  {showAuthorFilter && (
    <ChipGroup
      options={['all', 'mine', 'others']}
      selected={authorFilter}
      onChange={onAuthorChange}
    />
  )}
</div>
```

## Patterns to Follow

### 1. Controlled Component Pattern
Always pass external state through `controlledState`:
```typescript
const urlFilters = useURLFilterSync({ ... });
const { ... } = usePromptFilters({
  prompts,
  controlledState: urlFilters  // External state wins
});
```

### 2. URL-First, DB-Second
Update both URL (for UX) and database (for persistence) on filter change:
```typescript
const handleVisibilityChange = async (v: VisibilityFilter) => {
  setVisibilityFilter(v);              // Updates URL immediately
  await saveFilterPreference({ visibilityFilter: v }); // Persists to DB
};
```

### 3. Default Values Pattern
Follow existing pattern from `getStats()`:
```typescript
if (!data) {
  return {
    filterVisibility: 'all',
    filterAuthor: 'all',
    sortBy: 'lastUpdated',
    sortDirection: 'desc',
  };
}
```

### 4. RLS Isolation
All user_settings queries already have RLS:
- SELECT: `auth.uid() = user_id`
- UPDATE: `auth.uid() = user_id`

## Sort Options

### Current
- `name` - alphabetical by title
- `lastUpdated` - by updatedAt timestamp
- `usage` - by timesUsed count

### To Add
- `createdAt` - by createdAt timestamp

### Implementation
```typescript
// Extend SortBy type
type SortBy = 'name' | 'lastUpdated' | 'createdAt' | 'usage';

// In sort logic
if (sortBy === 'createdAt') {
  comparison = new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
}
```

## UI Patterns

### Chip Styling (from existing Button patterns)
```tsx
// Selected chip
<Button variant="default" size="sm" className="rounded-full">
  {label}
</Button>

// Unselected chip
<Button variant="outline" size="sm" className="rounded-full">
  {label}
</Button>
```

### Icons Available
- `Globe` - public visibility
- `Lock` - private visibility
- `User` - mine filter
- `Users` - all/others filter

## Key Files to Modify

| File | Changes |
|------|---------|
| `supabase/migrations/` | New migration for filter columns |
| `src/types/prompt.ts` | New filter types |
| `src/lib/storage/types.ts` | Extend adapter interface |
| `src/lib/storage/supabaseAdapter.ts` | Add filter preference methods |
| `src/hooks/useURLFilterSync.ts` | Add visibility filter state |
| `src/hooks/usePromptFilters.ts` | Add visibility filtering logic |
| `src/components/PromptListView.tsx` | Add filter chip UI |
| `src/components/Dashboard.tsx` | Wire up new filters |
| `src/pages/PublicLibrary.tsx` | Wire up new filters |

## What Already Exists

| Component | Status | Notes |
|-----------|--------|-------|
| `usePromptFilters` hook | Ready to extend | Controlled pattern established |
| `useURLFilterSync` hook | Ready to extend | Has authorFilter (unused) |
| `PromptListView` component | Ready for chips | Has search + sort UI |
| `user_settings` table | Ready to extend | Has RLS, auto-triggers |
| `StatsStorageAdapter` | Pattern to follow | Read pattern established |
| Button/Input components | Ready | shadcn/ui + Tailwind |
| Lucide icons | Ready | All needed icons available |

## Open Questions Resolved

1. **Author filter on Dashboard**: Hide it - Dashboard only shows user's own prompts
2. **Chip styling**: Use rounded-full buttons with default/outline variants
3. **URL params for shareable views**: Already supported via useURLFilterSync pattern
4. **Persistence timing**: Update DB on change (not on page unload)

## Sources

- `src/hooks/usePromptFilters.ts` - Filter logic implementation
- `src/hooks/useURLFilterSync.ts` - URL sync implementation
- `src/components/PromptListView.tsx` - Filter UI implementation
- `src/lib/storage/supabaseAdapter.ts` - Adapter patterns
- `supabase/migrations/20260104000001_*.sql` - user_settings schema

---

*Phase: 15.1-visibility-filter-persistence*
*Research completed: 2026-01-16*
*Ready for planning: yes*
