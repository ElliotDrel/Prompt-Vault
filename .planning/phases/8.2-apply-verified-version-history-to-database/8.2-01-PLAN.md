---
phase: 8.2-apply-verified-version-history-to-database
plan: 01
type: execute
---

<objective>
Insert user-verified historical versions from Phase 8.1 into the prompt_versions table, renumbering existing backfill versions appropriately.

Purpose: Populate complete version history for prompts that had copy events, enabling users to see how their prompts evolved over time.
Output: ~60 historical versions inserted, existing v1 entries renumbered to highest version per prompt.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/8.1-discover-version-history-from-copy-events/DISCOVERED-VERSIONS-FINAL.md
@.planning/phases/8.1-discover-version-history-from-copy-events/8.1-01-SUMMARY.md
@.planning/phases/08-backfill-existing-prompts-as-version-one/08-01-SUMMARY.md

**Database schema:**
- `prompt_versions` table: id (uuid), prompt_id (uuid), user_id (uuid), version_number (int), title (text), body (text), variables (jsonb), created_at (timestamptz), reverted_from_version_id (uuid nullable)
- 53 prompts currently have version 1 entries (from Phase 8 backfill)
- User ID: `a39a8008-3fb2-4f56-b336-c08f082ff670`

**Version numbering strategy from Phase 8.1:**
- Discovered historical versions: 0, 1, 2, ... (oldest to newest)
- Existing backfill v1 becomes highest version number for each prompt
- Example: If prompt has 3 discovered versions (0, 1, 2), existing backfill becomes v3

**Key constraint:**
- Remote-only Supabase development (no Docker)
- Migrations applied via `npx supabase db push`
- Never edit applied migrations - create new ones for fixes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migration to insert discovered versions</name>
  <files>supabase/migrations/[timestamp]_insert_discovered_historical_versions.sql</files>
  <action>
Create a migration that:

1. **For each of the 26 prompts with discovered versions**, update existing v1 to new version number:
   - Calculate: new_version = count of discovered versions for that prompt
   - UPDATE prompt_versions SET version_number = [new_version] WHERE prompt_id = '[id]' AND version_number = 1

2. **Insert all discovered versions** from DISCOVERED-VERSIONS-FINAL.md:
   - Parse each prompt's version table carefully
   - Body text must be properly escaped (use $$ delimiters for bodies with single quotes)
   - Variables as proper JSONB arrays
   - Timestamps from the "created_at" column in the discovered data

3. **Structure the migration as:**
   - Transaction wrapper (BEGIN; ... COMMIT;)
   - First: UPDATE statements to renumber existing v1 entries
   - Second: INSERT statements for discovered versions
   - Include comments explaining the source (Phase 8.1 discovery)

**CRITICAL escaping rules:**
- Use $$body$$ for body text (handles single quotes, double quotes safely)
- Escape any $$ inside body text as $body$ ... $body$
- Variables array: CAST('[...]' AS jsonb)

**Verification in migration:**
- Add a final SELECT to verify expected count inserted
  </action>
  <verify>
`npx supabase db push --dry-run` shows the migration without errors
`npx supabase db push` applies successfully
Query `SELECT prompt_id, COUNT(*) FROM prompt_versions GROUP BY prompt_id HAVING COUNT(*) > 1 ORDER BY COUNT(*) DESC LIMIT 10;` shows prompts with multiple versions
  </verify>
  <done>
- Migration file created with correct SQL syntax
- All 26 prompts have their v1 renumbered
- ~60 discovered versions inserted
- No SQL syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify version history integrity and update STATE.md</name>
  <files>.planning/STATE.md</files>
  <action>
Run verification queries to confirm data integrity:

1. **Count verification:**
   - Total versions should be ~113 (53 original + ~60 discovered)
   - 26 prompts should have multiple versions

2. **Version number integrity:**
   - For each prompt, version numbers should be sequential (0, 1, 2, ...)
   - No gaps, no duplicates

3. **Sample spot-check:**
   - Check "Identify Status and Next Steps from Plan" has 9 versions (8 discovered + 1 current)
   - Check "Commit Update Chunks to GIT" has 7 versions (6 discovered + 1 current)

4. **Update STATE.md:**
   - Mark Phase 8.2 complete
   - Update progress to 100%
   - Note the milestone is complete

5. **Update ROADMAP.md:**
   - Mark Phase 8.2 complete with date
  </action>
  <verify>
SQL query: `SELECT COUNT(*) FROM prompt_versions;` returns ~113
SQL query: `SELECT prompt_id, MIN(version_number) as min_v, MAX(version_number) as max_v, COUNT(*) as cnt FROM prompt_versions GROUP BY prompt_id HAVING COUNT(*) > 1;` shows correct ranges
  </verify>
  <done>
- All verification queries pass
- STATE.md updated with completion status
- ROADMAP.md updated with Phase 8.2 completion
- Milestone complete
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Migration applied without errors
- [ ] ~60 discovered versions inserted (verify count)
- [ ] 26 prompts have multiple versions
- [ ] Version numbers are sequential per prompt (no gaps)
- [ ] "Identify Status and Next Steps" has 9 versions
- [ ] STATE.md and ROADMAP.md updated
</verification>

<success_criteria>

- Migration applied successfully to remote database
- Historical version data matches DISCOVERED-VERSIONS-FINAL.md
- Version numbering is correct (discovered versions are 0, 1, 2...; backfill is highest)
- All 26 prompts with discovered versions now show complete history in UI
- Phase 8.2 marked complete in STATE.md and ROADMAP.md
- Milestone: Version History feature fully complete
  </success_criteria>

<output>
After completion, create `.planning/phases/8.2-apply-verified-version-history-to-database/8.2-01-SUMMARY.md`:

# Phase 8.2 Plan 01: Apply Historical Versions Summary

**[Substantive one-liner]**

## Accomplishments

- Inserted ~60 historical versions across 26 prompts
- Renumbered existing backfill versions appropriately
- Complete version history now available in UI

## Files Created/Modified

- `supabase/migrations/[timestamp]_insert_discovered_historical_versions.sql` - Historical version data

## Decisions Made

[Any decisions during execution]

## Issues Encountered

[Problems and resolutions, or "None"]

## Milestone Complete

Version History feature fully implemented:
- Phases 1-7: Core feature (schema, RPC, adapter, diff, components, revert)
- Phase 7.1: UI enhancements
- Phase 8: Backfill existing prompts
- Phase 8.1: Discover historical versions from copy events
- Phase 8.2: Apply discovered versions to database

Total versions in database: ~113
Prompts with complete history: 26 (from copy event analysis)
All users can now see full edit history for their prompts.
</output>
