---
phase: 8.1-discover-version-history-from-copy-events
plan: 01
type: execute
---

<objective>
Analyze copy_events table to discover historical prompt versions and output findings for user verification.

Purpose: Recover version history data captured in copy_events before the version tracking feature existed. Each copy event contains a snapshot of the prompt at that moment (title + body with variables substituted).

Output: DISCOVERED-VERSIONS.md report listing all discovered versions per prompt, with diffs between consecutive states, ready for user verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning\phases\8.1-discover-version-history-from-copy-events\8.1-CONTEXT.md

**Data context:**
- 707 copy events across 40 prompts
- All prompts already have version 1 from Phase 8 backfill
- Copy events span Sept 2025 - Jan 2026
- 7-8 prompts have documented title changes in history

**Algorithm for template reconstruction:**
1. No-variable prompts: `copied_text` IS the exact body (nothing to reconstruct)
2. Variable prompts:
   - Variable values stored in `variable_values` JSON object
   - `copied_text` contains body with values wrapped in XML: `<VariableName>value</VariableName>`
   - Reconstruct by replacing `<VarName>value</VarName>` with `{{VarName}}`
   - Sort replacements by value length (longest first) to avoid partial matches

**Change detection:**
- Compare consecutive copy events for same prompt (ordered by created_at)
- Title change: `prompt_title` differs from previous event
- Body change: reconstructed template differs from previous
- Variable change: extracted variable names differ from previous

**Version creation rules:**
- First copy event for a prompt = potential version (compare to current v1)
- Subsequent events only create version if title/body/variables changed
- Use copy event timestamp as version created_at
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze copy_events and generate DISCOVERED-VERSIONS.md</name>
  <files>.planning/phases/8.1-discover-version-history-from-copy-events/DISCOVERED-VERSIONS.md</files>
  <action>
Query all copy_events with prompts data. For each prompt with copy history:

1. **Fetch data:**
   - Query copy_events ordered by prompt_id, created_at ASC
   - Include current prompt state for comparison with v1

2. **Reconstruct templates:**
   - For each copy event, reconstruct the template body:
     - If variable_values is empty: copied_text IS the body
     - If variable_values exists: Replace each `<VarName>value</VarName>` with `{{VarName}}`
     - Sort replacements by value length DESC to avoid partial matches
     - Extract variable names from the JSON keys

3. **Detect versions:**
   - Compare each event to previous event for same prompt
   - Track: title, reconstructed body, variable names array
   - Mark as "new version" if ANY of these differ
   - First event: compare to existing v1 to check if different

4. **Generate report:**
   Write DISCOVERED-VERSIONS.md with structure:
   ```markdown
   # Discovered Version History from Copy Events

   Analysis date: [timestamp]
   Total prompts analyzed: X
   Prompts with discovered versions: Y
   Total new versions found: Z

   ## Summary

   | Prompt | Events | Discovered Versions | Title Changes |
   |--------|--------|---------------------|---------------|
   | [title] | N | M | yes/no |

   ## Detailed Findings

   ### [Prompt Title] (prompt_id: uuid)

   **Current v1:** [timestamp from prompt_versions]
   **Copy history:** [first_copy] to [last_copy] (N events)
   **Discovered versions:** M

   #### Version 0 (discovered) - [timestamp]
   - **Title:** [title if different from v1]
   - **Body changes:** +X/-Y words from v1
   - **Variables:** [list] (added/removed from v1)

   [Show first 200 chars of body or diff summary]

   #### Version X (discovered) - [timestamp]
   ...

   ---
   ```

5. **Handle edge cases:**
   - Prompts with only 1 copy event: compare to existing v1
   - Prompts where all events match v1: note "No historical versions discovered"
   - Title-only changes: still count as version
   - Very long variable values: may have XML-like content, be careful with replacement

Use MCP Supabase tools for queries. Process one prompt at a time to avoid context overflow.
  </action>
  <verify>
- DISCOVERED-VERSIONS.md exists in phase directory
- File contains summary table with all 40 prompts
- File contains detailed findings for prompts with discovered versions
- No errors in console during generation
  </verify>
  <done>
- DISCOVERED-VERSIONS.md generated with complete analysis
- Summary shows prompts analyzed, versions discovered, title changes
- Each discovered version has timestamp, title/body/variable changes noted
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Generated DISCOVERED-VERSIONS.md with historical version analysis from copy_events</what-built>
  <how-to-verify>
    1. Open `.planning/phases/8.1-discover-version-history-from-copy-events/DISCOVERED-VERSIONS.md`
    2. Review the summary table - does the count of discovered versions seem reasonable?
    3. For prompts you know changed over time, verify the discovered versions match your memory
    4. Check a few "discovered version" entries:
       - Does the reconstructed body look correct ({{variables}} restored)?
       - Do the timestamps make sense?
       - Are title changes correctly identified?
    5. Mark any issues or corrections needed

    **What to look for:**
    - False positives: versions detected that aren't real changes
    - Missing versions: changes you remember that aren't detected
    - Reconstruction errors: {{variable}} placeholders not restored correctly
    - Timestamp accuracy: versions dated correctly
  </how-to-verify>
  <resume-signal>
Type "approved" if the discovered versions look correct and ready for Phase 8.2.
Or describe any issues found (e.g., "Prompt X is missing a version from October" or "Reconstruction failed for prompt Y").
  </resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] DISCOVERED-VERSIONS.md exists and is well-formatted
- [ ] All 40 prompts with copy history analyzed
- [ ] Summary table shows accurate counts
- [ ] User has reviewed and approved the findings
</verification>

<success_criteria>
- DISCOVERED-VERSIONS.md generated with complete analysis
- User has verified the discovered versions are accurate
- Report is ready for Phase 8.2 consumption
</success_criteria>

<output>
After user approval, create `.planning/phases/8.1-discover-version-history-from-copy-events/8.1-01-SUMMARY.md`:

# Phase 8.1 Plan 01: Discover Version History Summary

**[Substantive one-liner about what was discovered]**

## Accomplishments

- Analyzed X copy events across Y prompts
- Discovered Z historical versions predating version tracking
- Identified N title changes across M prompts
- Generated verified DISCOVERED-VERSIONS.md for Phase 8.2

## Files Created/Modified

- `.planning/phases/8.1-discover-version-history-from-copy-events/DISCOVERED-VERSIONS.md` - Complete analysis report

## Decisions Made

[Any decisions about edge cases or reconstruction approach]

## Issues Encountered

[Any prompts that couldn't be reconstructed or anomalies found]

## Next Step

Ready for Phase 8.2: Apply Verified Version History to Database
</output>
