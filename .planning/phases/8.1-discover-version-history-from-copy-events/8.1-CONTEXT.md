# Version History Archaeology: Implementation Plan

## Executive Summary

**Goal:** Reconstruct version history for existing prompts by mining the `copy_events` table.

**Data Available:**
- 707 total copy events across 40 prompts
- 170 events have variable values, 537 don't
- 7 prompts have documented title changes
- Data spans from 2025-09-29 to 2026-01-12 (3.5 months)

**Key Insight:** Every copy event is a snapshot of what the prompt looked like at that moment:
- `prompt_title` = exact title at copy time
- `variable_values` = variables that existed (keys = variable names)
- `copied_text` = prompt body with variables substituted

---

## Data Model Understanding

### What We Have (copy_events)
```sql
copy_events:
  - id: uuid
  - prompt_id: uuid (FK to prompts)
  - prompt_title: text (title AT TIME OF COPY)
  - variable_values: jsonb ({"var_name": "filled_value"})
  - copied_text: text (body WITH variables substituted)
  - created_at: timestamptz
```

### What We Need (prompt_versions)
```sql
prompt_versions:
  - id: uuid
  - prompt_id: uuid
  - user_id: uuid
  - version_number: integer
  - title: text
  - body: text (TEMPLATE with {{placeholders}})
  - variables: jsonb (["var1", "var2"])
  - created_at: timestamptz
```

### The Reconstruction Challenge

**For prompts WITHOUT variables:**
- `copied_text` = exact prompt body (no transformation needed)
- Direct comparison between events detects changes

**For prompts WITH variables:**
- Need to reverse-engineer template by replacing values with placeholders
- Algorithm: Replace each `value` in `copied_text` with `{{variable_name}}`
- Challenge: Overlapping values, multiple occurrences, special characters

---

## Architecture: Sub-Agent Approach

### Why Sub-Agents?
1. **Context isolation:** Each prompt investigation is independent
2. **Parallelization:** Can process multiple prompts simultaneously
3. **Failure isolation:** One prompt's issues don't block others
4. **Main agent verification:** Main agent validates all sub-agent work

### Agent Hierarchy

```
Main Agent (Coordinator)
    |
    +-- Sub-Agent 1: Prompt A investigation
    |
    +-- Sub-Agent 2: Prompt B investigation
    |
    +-- Sub-Agent 3: Prompt C investigation
    |
    ... (one per prompt)
    |
    +-- Verification Phase (Main Agent)
    |
    +-- Migration Generation (Main Agent)
```

---

## Detailed Algorithm

### Phase 1: Data Extraction (Per Prompt)

For each prompt with copy history:

```sql
SELECT
    prompt_id,
    prompt_title,
    variable_values,
    copied_text,
    created_at
FROM copy_events
WHERE prompt_id = '{prompt_id}'
ORDER BY created_at ASC;
```

### Phase 2: Template Reconstruction

**Step 2a: Extract Variable Names**
```javascript
const variableNames = Object.keys(event.variable_values);
// e.g., ["Comments To Implement", "All Comments"]
```

**Step 2b: Reverse Substitution (if variables exist)**
```javascript
function reconstructTemplate(copiedText, variableValues) {
    let template = copiedText;

    // Sort by value length DESC to avoid partial matches
    const sortedEntries = Object.entries(variableValues)
        .sort((a, b) => b[1].length - a[1].length);

    for (const [varName, varValue] of sortedEntries) {
        // Escape special regex characters in the value
        const escapedValue = escapeRegex(varValue);
        // Replace all occurrences with placeholder
        template = template.replaceAll(varValue, `{{${varName}}}`);
    }

    return template;
}
```

**Step 2c: Handle Edge Cases**
- Empty variable values: Skip replacement
- Overlapping values: Longer values replaced first
- XML-wrapped values: Handle `<VarName>value</VarName>` pattern
- Special characters: Escape regex properly

### Phase 3: Change Detection

Compare consecutive events to detect actual changes:

```javascript
function detectChanges(event1, event2) {
    return {
        titleChanged: event1.prompt_title !== event2.prompt_title,
        bodyChanged: event1.reconstructedBody !== event2.reconstructedBody,
        variablesChanged: !arraysEqual(
            Object.keys(event1.variable_values),
            Object.keys(event2.variable_values)
        )
    };
}
```

### Phase 4: Version Timeline Construction

Group consecutive identical states, create version for each distinct state:

```javascript
function buildVersionTimeline(events) {
    const versions = [];
    let currentVersion = null;
    let versionNumber = 1;

    for (const event of events) {
        const state = {
            title: event.prompt_title,
            body: reconstructTemplate(event.copied_text, event.variable_values),
            variables: Object.keys(event.variable_values)
        };

        if (!currentVersion || stateChanged(currentVersion.state, state)) {
            versions.push({
                versionNumber: versionNumber++,
                ...state,
                firstSeen: event.created_at,
                lastSeen: event.created_at
            });
            currentVersion = { state, version: versions[versions.length - 1] };
        } else {
            currentVersion.version.lastSeen = event.created_at;
        }
    }

    return versions;
}
```

---

## Execution Plan

### Stage 1: Investigation (Sub-Agents in Parallel)

**For each of the 40 prompts with history:**

1. **Data Pull:** Get all copy events for prompt
2. **Reconstruction:** Attempt template reconstruction for each event
3. **Analysis:** Identify distinct versions and their timestamps
4. **Report:** Generate structured report:
   ```json
   {
     "prompt_id": "...",
     "prompt_title": "...",
     "total_copy_events": 114,
     "versions_discovered": [
       {
         "version_number": 1,
         "title": "Original Title",
         "body_preview": "First 200 chars...",
         "variables": ["var1"],
         "first_seen": "2025-09-29T...",
         "last_seen": "2025-10-15T...",
         "copy_count": 45
       },
       // ... more versions
     ],
     "confidence": "HIGH|MEDIUM|LOW",
     "issues": ["any reconstruction problems"]
   }
   ```

### Stage 2: Verification (Main Agent)

For each sub-agent report:
1. **Validate reconstructions:** Check that reconstructed templates make sense
2. **Cross-reference:** Ensure version timelines are chronologically consistent
3. **Spot-check:** Manually verify a sample of reconstructions
4. **Flag issues:** Mark any prompts needing manual review

### Stage 3: Migration Generation (Main Agent)

Generate SQL migration to insert discovered versions:

```sql
-- Archaeology-based version history backfill
-- Generated: {timestamp}
-- Prompts processed: 40
-- Versions discovered: {count}

INSERT INTO prompt_versions (
    prompt_id, user_id, version_number, title, body, variables, created_at
) VALUES
-- Prompt: "Clear, Install, Build, Everything Else, and Dev"
('2f1b06b6-...', 'user-id', 1, 'Title v1', 'Body v1', '[]', '2025-09-29T...'),
('2f1b06b6-...', 'user-id', 2, 'Title v2', 'Body v2', '[]', '2025-10-15T...'),
-- ... more versions
;
```

### Stage 4: Cleanup & Documentation

1. Remove or update the simple backfill migration (Phase 8 plan)
2. Document the archaeology process
3. Update STATE.md with results

---

## Prompts to Process (Priority Order)

### High Priority (Most History)
| Prompt ID | Title | Copy Events |
|-----------|-------|-------------|
| 2f1b06b6-... | Clear, Install, Build, Everything Else, and Dev | 114 |
| d13b8a53-... | Implement Features Step by Step for CC | 75 |
| 2f73cbba-... | Commit Update Chunks to GIT | 75 |
| 1f147e58-... | Self reflection | 67 |
| 2b9ec168-... | make code review changes (codex) | 45 |

### Medium Priority (Some History)
| Prompt ID | Title | Copy Events |
|-----------|-------|-------------|
| 1ef4db0d-... | Identify Status and Next Steps from Plan | 38 |
| e3af62de-... | code review - uncommited | 36 |
| 80996ca1-... | PR Comment Review | 25 |
| 447ccbbe-... | code review - in this chat | 21 |
| 7c2bdfed-... | Create an Implementation Plan based on planning files | 17 |

### Known Title Changes (Priority Verification)
| Prompt ID | Title Variants |
|-----------|----------------|
| 1ef4db0d-... | 3 variants: "Codebase Status...", "IDENIFY CODEBASE...", "Identify Status..." |
| 2b9ec168-... | 2 variants: "Make Changes After Code Review", "make code review changes..." |
| e3af62de-... | 2 variants: "code review - uncommited", "Code Review for Uncommitted Changes" |
| d13b8a53-... | 2 variants: spacing difference |

---

## Risk Mitigation

### Reconstruction Accuracy
- **Risk:** Variable value replacement might be imprecise
- **Mitigation:** Sort by length, escape regex, verify reconstructions

### Missing History
- **Risk:** Some prompts have no copy history
- **Mitigation:** 13 prompts without history get current-state-as-v1 (original plan)

### Edge Cases
- **Risk:** Very long variable values (seen: multi-paragraph code review comments)
- **Mitigation:** Test with longest values first, handle memory efficiently

### Duplicate Versions
- **Risk:** Minor whitespace differences creating false versions
- **Mitigation:** Normalize whitespace before comparison

---

## Success Criteria

1. **All 40 prompts with history** processed by sub-agents
2. **Version timelines** constructed for each prompt
3. **Main agent verification** passes for all reconstructions
4. **Migration generated** and ready to apply
5. **No data loss:** Current prompt state preserved
6. **Audit trail:** Documentation of what was discovered

---

## Estimated Scope

| Stage | Effort | Parallelizable |
|-------|--------|----------------|
| Sub-agent investigation (40 prompts) | ~2-3 min each | Yes (batches of 5-10) |
| Main agent verification | ~15 min | No |
| Migration generation | ~10 min | No |
| Testing & cleanup | ~10 min | No |

**Total estimated time:** 45-60 minutes

---

## Output File

**DISCOVERED-VERSIONS.md** - Updated incrementally as each prompt is analyzed

This file tracks:
- Which prompts have been analyzed
- Discovered versions for each prompt (with full body text)
- Change summaries between versions
- Analysis log

Phase 8.2 will read from this file to generate the database migration.

---

## Next Steps

1. **Begin Stage 1:** Launch sub-agents for first batch of prompts
2. **Update DISCOVERED-VERSIONS.md** as each prompt completes
3. **User verifies** discovered versions are accurate
4. **Phase 8.2:** Sync verified versions to database

---

*Plan created: 2026-01-12*
*Author: Claude (Main Agent)*
