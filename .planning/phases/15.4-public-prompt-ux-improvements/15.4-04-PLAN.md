---
phase: 15.4-public-prompt-ux-improvements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/PublicPreviewModal.tsx
  - src/components/PromptView.tsx
  - src/pages/PromptDetail.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard prompt detail has 'Preview as Public' button next to visibility toggle"
    - "Preview modal shows exactly what non-owners see (read-only, no controls)"
    - "Preview modal displays note 'This is how others see your public prompt'"
  artifacts:
    - path: "src/components/PublicPreviewModal.tsx"
      provides: "Modal component showing public prompt preview"
      contains: "This is how others see your public prompt"
      min_lines: 50
    - path: "src/components/PromptView.tsx"
      provides: "Preview as Public button integration"
      contains: "showPreviewButton"
  key_links:
    - from: "src/pages/PromptDetail.tsx"
      to: "src/components/PublicPreviewModal.tsx"
      via: "Renders modal with open state and prompt data"
      pattern: "PublicPreviewModal.*open"
---

<objective>
Add "Preview as Public" functionality to Dashboard prompt detail view, allowing owners to see exactly what non-owners will see when viewing their public prompt.

Purpose: Help prompt authors understand the public experience before sharing. Shows the read-only view with no edit controls, no version history, no pin/delete buttons - just the prompt content and copy button.

Output: New PublicPreviewModal component, button integration in PromptView, state management in PromptDetail
</objective>

<execution_context>
@C:\Users\2supe\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\2supe\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/components/PromptView.tsx
@src/pages/PromptDetail.tsx
@src/pages/PublicPromptDetail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PublicPreviewModal component</name>
  <files>src/components/PublicPreviewModal.tsx</files>
  <action>
Create a new modal component that shows exactly what non-owners see when viewing a public prompt.

The modal should display:
- Prompt title
- Prompt body (with variable highlighting using HighlightedPromptBody)
- Variables section (variable chips if any)
- Copy button (functional - should actually copy)
- Usage stats (times used, time saved)
- Info banner: "This is how others see your public prompt"

The modal should NOT display:
- Edit button
- Delete button
- Pin button
- Visibility toggle
- Version History button
- Usage History accordion

Use shadcn Dialog component for the modal.

```tsx
import React, { useState, useMemo } from 'react';
import { Copy, Check, X } from 'lucide-react';
import { Prompt, VariableValues } from '@/types/prompt';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { HighlightedPromptBody } from '@/components/HighlightedPromptBody';
import { usePrompts } from '@/contexts/PromptsContext';
import { buildPromptPayload, copyToClipboard } from '@/utils/promptUtils';
import { sanitizeVariables } from '@/utils/variableUtils';
import toast from 'react-hot-toast';

interface PublicPreviewModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  prompt: Prompt;
}

export function PublicPreviewModal({ open, onOpenChange, prompt }: PublicPreviewModalProps) {
  const { stats, incrementCopyCount, incrementPromptUsage } = usePrompts();
  const [variableValues, setVariableValues] = useState<VariableValues>({});
  const [isCopied, setIsCopied] = useState(false);

  const sanitizedVariables = useMemo(() => sanitizeVariables(prompt.variables), [prompt.variables]);
  const sanitizedPrompt = useMemo(
    () => ({ ...prompt, variables: sanitizedVariables }),
    [prompt, sanitizedVariables]
  );

  const handleVariableChange = (variable: string, value: string) => {
    setVariableValues((prev) => ({
      ...prev,
      [variable]: value,
    }));
  };

  const handleCopy = async () => {
    try {
      const payload = buildPromptPayload(sanitizedPrompt, variableValues);
      const success = await copyToClipboard(payload);

      if (!success) {
        toast.error('Failed to copy to clipboard');
        return;
      }

      // Still track usage even in preview mode
      await Promise.all([
        incrementCopyCount(),
        incrementPromptUsage(prompt.id),
      ]);

      setIsCopied(true);
      setTimeout(() => setIsCopied(false), 1500);
      toast.success('Copied');
    } catch (err) {
      toast.error('Failed to copy');
    }
  };

  const formatTime = (minutes: number) => {
    if (minutes < 60) return `${minutes}m`;
    const hours = Math.floor(minutes / 60);
    const remainingMinutes = minutes % 60;
    return remainingMinutes > 0 ? `${hours}h ${remainingMinutes}m` : `${hours}h`;
  };

  const totalTimeSavedMinutes = (prompt.timesUsed || 0) * stats.timeSavedMultiplier;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-2xl max-h-[85vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-2xl">{prompt.title}</DialogTitle>
        </DialogHeader>

        {/* Info banner */}
        <div className="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-400 p-3 rounded-r-md">
          <p className="text-sm text-blue-700 dark:text-blue-300">
            This is how others see your public prompt
          </p>
        </div>

        <div className="space-y-6">
          {/* Variable inputs */}
          {sanitizedVariables.length > 0 && (
            <div className="space-y-3">
              <Label className="text-sm font-medium">Fill Variables</Label>
              {sanitizedVariables.map((variable) => (
                <div key={variable} className="space-y-1">
                  <Label
                    htmlFor={`preview-${prompt.id}-${variable}`}
                    className="text-sm text-muted-foreground"
                  >
                    {variable}
                  </Label>
                  <Input
                    id={`preview-${prompt.id}-${variable}`}
                    type="text"
                    placeholder={`Enter ${variable}...`}
                    value={variableValues[variable] || ''}
                    onChange={(e) => handleVariableChange(variable, e.target.value)}
                    className="text-sm"
                  />
                </div>
              ))}
            </div>
          )}

          {/* Copy button */}
          <Button onClick={handleCopy} className="w-full font-medium">
            {isCopied ? (
              <>
                <Check className="h-4 w-4 mr-2" />
                Copied!
              </>
            ) : (
              <>
                <Copy className="h-4 w-4 mr-2" />
                {sanitizedVariables.length > 0 ? 'Copy with Variables' : 'Copy'}
              </>
            )}
          </Button>

          {/* Prompt body */}
          <div className="space-y-2">
            <Label className="text-sm font-medium">Prompt</Label>
            <div className="bg-muted/50 rounded-md p-4 font-mono">
              <HighlightedPromptBody
                value={prompt.body}
                variables={sanitizedVariables}
                className="whitespace-pre-wrap break-all"
              />
            </div>
          </div>

          {/* Prompt Information (read-only stats) */}
          <div className="pt-4 border-t space-y-3">
            <Label className="text-sm font-medium">Prompt Information</Label>
            <div className="flex justify-between text-sm text-muted-foreground">
              <span>Times used:</span>
              <span className="font-medium text-foreground">{prompt.timesUsed || 0}</span>
            </div>
            <div className="flex justify-between text-sm text-muted-foreground">
              <span>Time saved:</span>
              <span className="font-medium text-foreground">{formatTime(totalTimeSavedMinutes)}</span>
            </div>
          </div>
        </div>

        {/* Close button in footer */}
        <div className="flex justify-end pt-4 border-t">
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Close Preview
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>
Component file created at src/components/PublicPreviewModal.tsx with all required elements:
- Info banner with preview explanation
- Variable inputs
- Copy button (functional)
- Prompt body with highlighting
- Stats section
- Close button
- NO edit/delete/pin/history controls
  </verify>
  <done>PublicPreviewModal component created with read-only public view</done>
</task>

<task type="auto">
  <name>Task 2: Add Preview button and wire up modal in PromptView/PromptDetail</name>
  <files>src/components/PromptView.tsx, src/pages/PromptDetail.tsx</files>
  <action>
Add "Preview as Public" button to PromptView and manage modal state in PromptDetail.

In PromptView.tsx:
1. Add new optional props:
```tsx
/** Show "Preview as Public" button (for public prompts on Dashboard) */
showPreviewButton?: boolean;
/** Callback when preview button is clicked */
onPreview?: () => void;
```

2. Add the button next to the visibility toggle in the top-right header (near where View Public Version button was placed in Plan 02). The button should only show when `showPreviewButton && onPreview` is truthy:

```tsx
<div className="flex items-center gap-3">
  {showPreviewButton && onPreview && (
    <Button variant="outline" size="sm" onClick={onPreview}>
      <Eye className="h-4 w-4 mr-2" />
      Preview as Public
    </Button>
  )}
  {showViewPublicButton && onViewPublicVersion && (
    <Button variant="outline" size="sm" onClick={onViewPublicVersion}>
      <Globe className="h-4 w-4 mr-2" />
      View Public Version
    </Button>
  )}
  {(showVisibilityToggle ?? true) && (
    <VisibilityToggle ... />
  )}
</div>
```

Import Eye from lucide-react.

In PromptDetail.tsx:
1. Import PublicPreviewModal
2. Add state for preview modal: `const [previewOpen, setPreviewOpen] = useState(false);`
3. Pass props to PromptView:
```tsx
<PromptView
  prompt={prompt}
  // ... existing props ...
  showPreviewButton={prompt.visibility === 'public'}
  onPreview={prompt.visibility === 'public' ? () => setPreviewOpen(true) : undefined}
/>
```

4. Render the modal:
```tsx
{/* Public Preview Modal */}
{prompt && prompt.visibility === 'public' && (
  <PublicPreviewModal
    open={previewOpen}
    onOpenChange={setPreviewOpen}
    prompt={prompt}
  />
)}
```

Decision: Show "Preview as Public" button ONLY when the prompt is already public. For private prompts, the user should make it public first to preview it (or we could allow preview of what it WOULD look like - but keeping it simple).
  </action>
  <verify>
1. Go to Dashboard -> click a PUBLIC prompt
2. Should see "Preview as Public" button in the top-right area next to visibility toggle
3. Click the button -> modal opens showing read-only public view
4. Modal should NOT have Edit, Delete, Pin, History buttons
5. Copy button in modal should work
6. Close button should dismiss modal
7. For PRIVATE prompts, the Preview button should NOT appear
  </verify>
  <done>"Preview as Public" button appears on Dashboard for public prompts, opens modal with public view</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- `npm run lint` passes
- Preview button appears only for public prompts on Dashboard
- Modal shows read-only view matching what non-owners see
- Copy functionality works in preview modal
- Modal can be closed
</verification>

<success_criteria>
- "Preview as Public" button visible in top-right area on Dashboard (public prompts only)
- Modal displays exact view non-owners would see
- Info banner clearly states "This is how others see your public prompt"
- No owner-only controls (Edit, Delete, Pin, History) visible in preview
- Copy button functional with proper stats tracking
</success_criteria>

<output>
After completion, create `.planning/phases/15.4-public-prompt-ux-improvements/15.4-04-SUMMARY.md`
</output>
