# Phase 15.4 UAT Issues - PR #41 Review Comments

**Source:** PR #41 automated review comments from gemini-code-assist, coderabbitai, chatgpt-codex-connector, GitHub Copilot
**Reviewed:** 2026-02-03
**Status:** OPEN - Requires gap closure plan

---

## Summary

| Status | Count | Description |
|--------|-------|-------------|
| IMPLEMENT NOW | 14 | Must fix before merge |
| CONDITIONAL | 6 | Fix if specific condition applies |
| LATER | 2 | Valid but lower priority |
| IGNORE | 3 | False positives or not applicable |

---

## IMPLEMENT NOW - Must Fix

These issues require resolution before the PR can be merged. The planning agent should create a gap closure plan addressing ALL of these.

---

### UAT-041-01: Missing `created_at` in Public Prompts Query (CRITICAL)

**File:** `src/lib/storage/supabaseAdapter.ts`
**Lines:** 205, 68
**Severity:** HIGH - Functional bug

**Problem:**
`getPublicPrompts()` at line 205 selects columns without `created_at`:
```typescript
.select('id, user_id, title, body, variables, updated_at, is_pinned, times_used, visibility')
```

But `mapPublicPromptRow()` at line 68 reads it:
```typescript
createdAt: row.created_at,
```

**Impact:**
- `createdAt` is always `undefined` for public prompts in Library
- Sorting by "Created" date produces `NaN` comparisons
- Sort order becomes unstable/random when users select "Created" sort

**Fix Required:**
Add `created_at` to the select statement in `getPublicPrompts()` to match `getPublicPromptById()` which correctly includes it.

**Verification:**
1. Go to Library page
2. Select "Created" sort
3. Prompts should sort by creation date, not randomly

---

### UAT-041-02: CopyHistory Loading Race Condition (HIGH)

**File:** `src/pages/CopyHistory.tsx`
**Lines:** 50-53
**Severity:** HIGH - Incorrect UI during load

**Problem:**
```typescript
const { prompts, incrementCopyCount, incrementPromptUsage } = usePrompts();
const ownedPromptIds = useMemo(() => new Set(prompts.map(p => p.id)), [prompts]);
```

The component derives `ownedPromptIds` from `prompts` without checking the `loading` state from `usePrompts()`. During initial app load:
1. `prompts` is an empty array `[]`
2. `ownedPromptIds` becomes an empty Set
3. All copy events render with `isPublicPrompt={!ownedPromptIds.has(event.promptId)}` = `true`
4. ALL events incorrectly display as "public" until prompts finish loading

**Impact:**
- Brief but visible misclassification of owned prompts as public
- Green "Public" badges flash on all events during load
- Confusing user experience on slow networks

**Fix Required:**
Either:
1. Destructure `loading` from `usePrompts()` and show loading state until `!loading`
2. Initialize `ownedPromptIds` conditionally after prompts are loaded
3. Pass `loading` state and show skeleton/placeholder for isPublicPrompt during load

**Verification:**
1. Clear browser cache
2. Load /history page on throttled network (slow 3G)
3. Owned prompts should NOT flash green "Public" badges

---

### UAT-041-03: Optional `onDelete` Called Without Guard (MEDIUM)

**File:** `src/components/PromptView.tsx`
**Lines:** 57, 161-169

**Problem:**
```typescript
// Line 57 - prop is optional
onDelete?: (promptId: string) => Promise<void>;

// Lines 161-169 - no null check
const handleDelete = async () => {
  try {
    await onDelete(prompt.id);  // Can crash if onDelete is undefined
    toast.success('Prompt deleted');
    onNavigateBack();
  } catch (err) {
    // ...
  }
};
```

The delete button at line 422 is conditionally rendered (`{onDelete && ...}`), but `handleDelete` itself has no guard. If called through any other means (keyboard binding, ref, future refactor), it will crash.

**Impact:**
- Potential runtime crash: "onDelete is not a function"
- Fragile code that breaks on refactoring

**Fix Required:**
Add early return guard in `handleDelete`:
```typescript
const handleDelete = async () => {
  if (!onDelete) return;
  // ... rest of function
};
```

**Verification:**
1. Confirm PromptView renders without crash when onDelete is undefined
2. Confirm delete works normally when onDelete is provided

---

### UAT-041-04: Unused `usePrompts()` Destructuring (LOW)

**File:** `src/pages/PublicPromptDetail.tsx`
**Line:** 18
**Also:** Duplicate comments 16, 20, 21, 22

**Problem:**
```typescript
const { togglePinPrompt, incrementCopyCount, incrementPromptUsage } = usePrompts();
```

These three functions are destructured but never used anywhere in the component. `PromptView` has its own internal `usePrompts()` call.

**Impact:**
- Dead code clutters the file
- Misleads future maintainers about component responsibilities
- Minor: unnecessary context subscription

**Fix Required:**
Remove the entire line 18. The import of `usePrompts` from line 5 can also be removed if nothing else uses it.

**Verification:**
1. `npm run build` passes
2. `npm run lint` passes (no unused variable warnings)
3. PublicPromptDetail page still functions correctly

---

### UAT-041-05: Circular TypeScript Constraint in Debounce (MEDIUM)

**File:** `src/hooks/useURLFilterSync.ts`
**Line:** 68

**Problem:**
```typescript
function debounce<T extends (...args: Parameters<T>) => void>(fn: T, ms: number): T {
```

The generic constraint `T extends (...args: Parameters<T>) => void` is circular - `T` references itself in its own constraint. This is technically invalid TypeScript and can cause compiler errors in stricter configurations.

**Impact:**
- May cause TypeScript errors in future TS versions
- Prevents proper type inference in some cases
- Known TS anti-pattern

**Fix Required:**
Use a non-circular constraint:
```typescript
function debounce<T extends (...args: any[]) => void>(fn: T, ms: number): T {
  let timer: ReturnType<typeof setTimeout> | null = null;
  return ((...args: Parameters<T>) => {
    if (timer) clearTimeout(timer);
    timer = setTimeout(() => fn(...args), ms);
  }) as T;
}
```

**Verification:**
1. `npm run build` passes
2. No TypeScript errors in useURLFilterSync.ts
3. Filter debouncing still works correctly

---

### UAT-041-06: Missing DB Value Validation for `filterVisibility` (MEDIUM)

**File:** `src/hooks/useURLFilterSync.ts`
**Lines:** 145-146

**Problem:**
```typescript
if (!searchParams.has(visibilityParam) && prefs.filterVisibility !== 'all') {
  setVisibilityFilterState(prefs.filterVisibility);
}
```

The `prefs.filterVisibility` value from the database is applied directly without validating it against `isValidVisibilityFilter()`. Compare to line 148 which correctly validates `sortBy`:
```typescript
if (!searchParams.has(sortByParam) && isValidSortBy(prefs.sortBy) && prefs.sortBy !== defaultSortBy) {
```

**Impact:**
- Corrupted or legacy DB values could break the UI
- No defense against invalid data

**Fix Required:**
Add validation:
```typescript
if (!searchParams.has(visibilityParam) && isValidVisibilityFilter(prefs.filterVisibility) && prefs.filterVisibility !== 'all') {
  setVisibilityFilterState(prefs.filterVisibility);
}
```

**Verification:**
1. Filter persistence still works
2. Invalid DB values don't crash the UI

---

### UAT-041-07: Missing DB Value Validation for `sortDirection` (MEDIUM)

**File:** `src/hooks/useURLFilterSync.ts`
**Lines:** 151-152

**Problem:**
```typescript
if (!searchParams.has(sortDirParam) && prefs.sortDirection !== defaultSortDirection) {
  setSortDirectionState(prefs.sortDirection);
}
```

Same issue as UAT-041-06 - no validation before applying. The `isValidSortDirection()` helper exists but isn't used.

**Impact:**
- Corrupted DB values could set invalid sort direction
- Inconsistent validation pattern

**Fix Required:**
Add validation:
```typescript
if (!searchParams.has(sortDirParam) && isValidSortDirection(prefs.sortDirection) && prefs.sortDirection !== defaultSortDirection) {
  setSortDirectionState(prefs.sortDirection);
}
```

**Verification:**
1. Sort direction persistence still works
2. Invalid DB values don't crash the UI

---

### UAT-041-08: Unguarded `console.error` in Production (LOW)

**File:** `src/hooks/useInfiniteCopyEvents.ts`
**Lines:** 223-225

**Problem:**
```typescript
queryClient.invalidateQueries({
  queryKey: ['copyEvents'],
  refetchType: 'active',
}).catch((err) => {
  console.error('Failed to invalidate copy event queries via subscription:', err);
});
```

Per CLAUDE.md: "Remove all `console.log` before commit unless feature-flagged. Console should only show actionable warnings in production."

Also missing `void` prefix for fire-and-forget promise.

**Impact:**
- Console noise in production
- Violates project guidelines

**Fix Required:**
```typescript
void queryClient.invalidateQueries({
  queryKey: ['copyEvents'],
  refetchType: 'active',
}).catch((err) => {
  if (import.meta.env.DEV) {
    console.error('Failed to invalidate copy event queries via subscription:', err);
  }
});
```

**Verification:**
1. No console errors in production build
2. Errors still logged in development

---

### UAT-041-09: Unguarded `console.error` in Filter Preferences (LOW)

**File:** `src/hooks/useURLFilterSync.ts`
**Lines:** 130-132, 154-156

**Problem:**
Two unguarded `console.error` statements:
```typescript
// Line 130-132
adapter.updateFilterPreferences(prefs).catch((err) => {
  console.error('Failed to persist filter preferences:', err);
});

// Line 154-156
}).catch((err) => {
  console.error('Failed to load filter preferences:', err);
});
```

Same issue as UAT-041-08 - violates project logging guidelines.

**Impact:**
- Console noise in production
- Non-actionable errors displayed to users

**Fix Required:**
Either dev-gate or remove both console.error statements. The error handling via `.catch()` is sufficient - the app gracefully degrades.

**Verification:**
1. No console errors for filter preferences in production
2. Filter functionality still works when DB fails (graceful degradation)

---

### UAT-041-11: Search Normalization Inconsistency (MEDIUM)

**File:** `src/hooks/usePromptFilters.ts`
**Lines:** 116-126

**Problem:**
```typescript
const searchLower = searchTerm.toLowerCase();
result = result.filter((prompt) => {
  const titleMatch = prompt.title.toLowerCase().includes(searchLower);
  const bodyMatch = prompt.body.toLowerCase().includes(searchLower);
  // ...
});
```

Per CLAUDE.md: "Normalize consistently across ALL comparison points: `.replace(/[\s_]+/g, '').toLowerCase()`"

The search only uses `toLowerCase()`, not the full normalization pattern.

**Impact:**
- Searching `my_variable` won't match `myvariable`
- Inconsistent with variable normalization elsewhere in app
- Users may miss results due to spacing/underscore differences

**Fix Required:**
Apply shared normalization:
```typescript
const normalize = (s: string) => s.replace(/[\s_]+/g, '').toLowerCase();
const searchNormalized = normalize(searchTerm);
result = result.filter((prompt) => {
  const titleMatch = normalize(prompt.title).includes(searchNormalized);
  const bodyMatch = normalize(prompt.body).includes(searchNormalized);
  const authorMatch = (authorName && normalize(authorName).includes(searchNormalized)) ||
                      (authorId && normalize(authorId).includes(searchNormalized));
  return titleMatch || bodyMatch || authorMatch;
});
```

Consider extracting the normalize helper to a shared utility.

**Verification:**
1. Search "my_variable" matches prompt containing "myvariable"
2. Search "test prompt" matches "testprompt"
3. Normal searches still work correctly

---

### UAT-041-12: Trust Gate Missing for @claude Workflow (SECURITY)

**File:** `.github/workflows/claude.yml`
**Lines:** 15-19

**Problem:**
```yaml
claude:
  if: |
    (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
    (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
    (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
    (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
```

Anyone who can comment on the repo can trigger the Claude workflow by mentioning @claude. This consumes compute/API quota and runs with repository secrets.

**Impact:**
- Security risk on public repositories
- Potential quota exhaustion by bad actors
- Secrets exposed to untrusted workflow runs

**Fix Required:**
Add `author_association` checks to restrict to trusted roles:
```yaml
claude:
  if: |
    (github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@claude') &&
      contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.comment.author_association)) ||
    (github.event_name == 'pull_request_review_comment' &&
      contains(github.event.comment.body, '@claude') &&
      contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.comment.author_association)) ||
    (github.event_name == 'pull_request_review' &&
      contains(github.event.review.body, '@claude') &&
      contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.review.author_association)) ||
    (github.event_name == 'issues' &&
      (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')) &&
      contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.issue.author_association))
```

**Verification:**
1. Trusted collaborators can still trigger @claude
2. External contributors cannot trigger the workflow

---

### UAT-041-13: Documentation Mismatch - Ring Color in Verification (DOC)

**Files:**
- `.planning/phases/15.4-public-prompt-ux-improvements/15.4-VERIFICATION.md` (line 42)
- Also affects: STATE.md decisions, any other docs referencing "primary" ring

**Problem:**
Verification document claims:
> "PromptCard.tsx:223 applies ring-2 ring-primary/50"

Actual code uses:
```typescript
isOwnPrompt === false ? 'ring-2 ring-green-500/50 bg-green-50/30' : ''
```

UAT notes correctly say "green outline for others" - but verification/planning docs weren't updated.

**Impact:**
- Misleading documentation
- Confusion for future contributors

**Fix Required:**
Update verification document and any other references to reflect the actual green-500 styling.

**Verification:**
1. All docs accurately describe the green styling
2. No references to "primary" ring for owned prompts remain

---

### UAT-041-14: Verification Doc Item Count Mismatch (DOC)

**File:** `.planning/phases/15.4-public-prompt-ux-improvements/15.4-VERIFICATION.md`
**Line:** 101

**Problem:**
```markdown
Four items flagged for manual browser testing:

1. **Realtime Copy Event Updates** - ...
2. **Owner Auto-Redirect Flow** - ...
3. **Visual Distinction in Library** - ...
4. **Copy History Context Note** - ...
5. **Public Prompt Badges on History** - ...
```

Heading says "Four items" but lists five items.

**Fix Required:**
Change "Four items" to "Five items".

**Verification:**
1. Count in heading matches number of list items

---

### UAT-041-15: Plan Document Inconsistent Guidance (DOC)

**File:** `.planning/phases/15.4-public-prompt-ux-improvements/15.4-01-PLAN.md`
**Lines:** 65-70

**Problem:**
The plan document says both:
- Line 65: "call `refetch()` to refresh the copy history list"
- Line 70: "Use React Query's `invalidateQueries` method"

The actual implementation uses `invalidateQueries()` exclusively.

**Fix Required:**
Remove `refetch()` reference and clarify that `invalidateQueries()` is the correct approach.

**Verification:**
1. Plan document gives consistent guidance

---

## CONDITIONAL - Fix If Condition Applies

These issues should only be addressed if the stated condition is true.

---

### UAT-041-C1: Missing Language Tags on Code Fences

**Files:**
- `.planning/phases/15.4-public-prompt-ux-improvements/15.4-04-SUMMARY.md` (line 95)
- `.planning/phases/15.4-public-prompt-ux-improvements/15.4-01-SUMMARY.md` (lines 73-75, 78-80)

**Condition:** Only fix if markdownlint is enforced in CI/pre-commit.

**Problem:** Code fences for ASCII diagrams lack language identifiers (should use `text` or `plaintext`).

**Fix:** Add `text` language specifier to affected code fences.

---

### UAT-041-C2: Migration Constraints Not Idempotent

**File:** `supabase/migrations/20260119060449_add_filter_preferences.sql`
**Lines:** 11-15

**Condition:** Only fix if migration has NOT been pushed to remote yet.

**Problem:** `ADD CONSTRAINT` statements will fail if re-run. Per CLAUDE.md, editing applied migrations is forbidden.

**Fix:** If not pushed, wrap in exception handling or use `DROP CONSTRAINT IF EXISTS` first.

---

### UAT-041-C3: Pinned Styling Visible on Non-Owned Prompts

**File:** `src/components/PromptCard.tsx`
**Lines:** 220-221

**Condition:** Only fix if pin state is meant to be private to the owner.

**Problem:** Yellow pinned ring appears on public prompts regardless of ownership, exposing author's personal pin state.

**Fix:** Gate pinned styling to `shouldShowPinAction && prompt.isPinned` or `source === 'owned'`.

---

### UAT-041-C4: Unused git fetch Permission

**File:** `.claude/settings.local.json`
**Line:** 18

**Condition:** Only remove if you want strict least-privilege for agents.

**Problem:** `Bash(git fetch:*)` permission exists but isn't actively used.

**Fix:** Remove the permission entry if least-privilege is desired.

---

## LATER - Valid But Lower Priority

These issues are valid but can be addressed in a future cleanup effort.

---

### UAT-041-L1: Progress Bar Percentage Mismatch

**File:** `.planning/STATE.md`
**Line:** 17

**Problem:** Visual bar shows 60% but text says 65%.

**Priority:** Low - documentation accuracy only.

---

## IGNORE - No Action Required

These were determined to be false positives or not applicable.

---

### UAT-041-X1: "Negation Always True" (Comment 23)

**File:** `src/pages/PublicPromptDetail.tsx`
**Line:** 58

**Finding:** FALSE POSITIVE. The control flow is correct - the `!loading` check follows an early return, making it contextually accurate.

---

### UAT-041-X2: Unsupported Action Inputs (Comment 3)

**File:** `.github/workflows/claude-code-review.yml`
**Lines:** 39-40

**Finding:** The `plugin_marketplaces` and `plugins` inputs ARE supported by recent versions of the action despite not being in older documentation. No action needed unless plugin loading fails in practice.

---

### UAT-041-X3: Inconsistent `isOwnPrompt` Prop Naming (Comment 10)

**File:** `src/components/PromptCard.tsx`
**Lines:** 80-81, 223

**Finding:** FALSE POSITIVE. Root cause analysis (debug agent investigation) confirmed this is INTENTIONAL UX design:

- `isOwnPrompt=true` → user's own prompt → NO green styling
- `isOwnPrompt=false` → someone else's prompt → green highlight marks "discoverable community content"

The prop name describes **what the value represents** (ownership status), not **what visual effect it triggers**. This follows good practice: semantic prop names over presentational ones. The JSDoc at line 80-81 accurately describes the behavior: "Whether this prompt is owned by the current user (for visual distinction in Library)".

The reviewer misunderstood the UX intent — green highlights OTHER users' prompts as community content worth discovering, not the user's own prompts.

---

## Planning Agent Instructions

**CREATE A GAP CLOSURE PLAN** that addresses all **IMPLEMENT NOW** issues (14 issues).

Group fixes logically:
1. **Critical functional bugs:** UAT-041-01 (created_at), UAT-041-02 (race condition)
2. **Code safety:** UAT-041-03 (onDelete guard), UAT-041-05 (TypeScript fix)
3. **Validation consistency:** UAT-041-06, UAT-041-07 (DB validation)
4. **Logging compliance:** UAT-041-08, UAT-041-09 (console.error)
5. **Code cleanup:** UAT-041-04 (unused imports), UAT-041-11 (search normalization)
6. **Security:** UAT-041-12 (trust gate)
7. **Documentation:** UAT-041-13, UAT-041-14, UAT-041-15

Do NOT plan fixes for CONDITIONAL, LATER, or IGNORE items (including UAT-041-10 which was determined to be a false positive).
