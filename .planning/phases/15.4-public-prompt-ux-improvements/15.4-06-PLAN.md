---
phase: 15.4-public-prompt-ux-improvements
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/storage/supabaseAdapter.ts
  - src/pages/CopyHistory.tsx
  - src/components/CopyEventCard.tsx
  - src/components/PromptView.tsx
  - src/hooks/useURLFilterSync.ts
  - src/hooks/useInfiniteCopyEvents.ts
  - src/pages/PublicPromptDetail.tsx
  - src/hooks/usePromptFilters.ts
  - .github/workflows/claude.yml
  - .planning/phases/15.4-public-prompt-ux-improvements/15.4-VERIFICATION.md
  - .planning/phases/15.4-public-prompt-ux-improvements/15.4-01-PLAN.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Library prompts sort correctly by Created date (no NaN/random order)"
    - "Copy History page shows correct public badges during initial load"
    - "PromptView does not crash when onDelete prop is undefined"
    - "Filter preferences from DB are validated before applying"
    - "No console.error statements appear in production builds"
    - "Search matches prompts with underscores/spaces normalized"
    - "Only trusted collaborators can trigger @claude workflow"
  artifacts:
    - path: "src/lib/storage/supabaseAdapter.ts"
      provides: "getPublicPrompts with created_at column"
      contains: "created_at"
    - path: "src/hooks/useURLFilterSync.ts"
      provides: "Validated DB preference loading"
      contains: "isValidVisibilityFilter"
    - path: ".github/workflows/claude.yml"
      provides: "Trust-gated workflow triggers"
      contains: "author_association"
  key_links:
    - from: "supabaseAdapter.getPublicPrompts()"
      to: "mapPublicPromptRow()"
      via: "created_at field mapping"
      pattern: "created_at"
    - from: "useURLFilterSync"
      to: "setVisibilityFilterState"
      via: "validation guard"
      pattern: "isValidVisibilityFilter.*prefs\\.filterVisibility"
---

<objective>
Fix 14 issues identified by PR #41 automated review to unblock merge.

Purpose: Close all IMPLEMENT NOW issues from UAT-041 review to complete Phase 15.4 and prepare for merge.
Output: All source files patched, documentation corrected, build and lint passing.
</objective>

<execution_context>
@C:\Users\2supe\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\2supe\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.4-public-prompt-ux-improvements/15.4-UAT-ISSUES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix missing created_at in getPublicPrompts (UAT-041-01)</name>
  <files>src/lib/storage/supabaseAdapter.ts</files>
  <action>
  At line 205, add `created_at` to the SELECT statement for `getPublicPrompts()`.

  Current:
  ```typescript
  .select('id, user_id, title, body, variables, updated_at, is_pinned, times_used, visibility')
  ```

  Change to:
  ```typescript
  .select('id, user_id, title, body, variables, created_at, updated_at, is_pinned, times_used, visibility')
  ```

  This matches `getPublicPromptById()` at line 222 which correctly includes `created_at`.
  The `mapPublicPromptRow()` at line 68 already expects `row.created_at`.
  </action>
  <verify>
  1. `npm run build` passes
  2. Go to Library page, select "Created" sort - prompts sort by creation date, not randomly
  </verify>
  <done>Public prompts in Library have valid createdAt dates and sort correctly by Created</done>
</task>

<task type="auto">
  <name>Task 2: Fix CopyHistory loading race condition (UAT-041-02)</name>
  <files>src/pages/CopyHistory.tsx, src/components/CopyEventCard.tsx</files>
  <action>
  In CopyHistory.tsx around lines 50-53:

  1. Destructure `loading` from `usePrompts()`:
  ```typescript
  const { prompts, loading: promptsLoading, incrementCopyCount, incrementPromptUsage } = usePrompts();
  ```

  2. Update ownedPromptIds derivation to return null during loading:
  ```typescript
  const ownedPromptIds = useMemo(
    () => promptsLoading ? null : new Set(prompts.map(p => p.id)),
    [prompts, promptsLoading]
  );
  ```

  3. Update isPublicPrompt prop on CopyEventCard (find usages in the component):
  Pass `isPublicPrompt={ownedPromptIds === null ? undefined : !ownedPromptIds.has(event.promptId)}`

  In CopyEventCard.tsx:
  1. Update prop type to allow undefined: `isPublicPrompt?: boolean;` (if not already)
  2. Only render the "Public" badge when `isPublicPrompt === true` (not when undefined)
  3. Do NOT render the badge at all when `isPublicPrompt === undefined` (loading state)
  </action>
  <verify>
  1. Clear browser cache, load /history on slow 3G throttle
  2. Owned prompts should NOT flash green "Public" badges during load
  3. After load completes, correct badges appear
  </verify>
  <done>CopyHistory shows no public badges during initial load, correct badges after prompts loaded</done>
</task>

<task type="auto">
  <name>Task 3: Add onDelete guard in PromptView (UAT-041-03)</name>
  <files>src/components/PromptView.tsx</files>
  <action>
  At line 161, in the `handleDelete` function, add an early return guard:

  ```typescript
  const handleDelete = async () => {
    if (!onDelete) return;
    try {
      await onDelete(prompt.id);
      toast.success('Prompt deleted');
      onNavigateBack();
    } catch (err) {
      toast.error('Failed to delete prompt');
    }
  };
  ```

  This prevents potential crashes if handleDelete is ever called when onDelete is undefined.
  The button at line 422 is already conditionally rendered, but this adds defense-in-depth.
  </action>
  <verify>
  1. `npm run build` passes
  2. PromptView renders without crash when onDelete is undefined (public prompt detail)
  3. Delete still works normally when onDelete is provided (owned prompt detail)
  </verify>
  <done>handleDelete has guard against undefined onDelete prop</done>
</task>

<task type="auto">
  <name>Task 4: Fix useURLFilterSync issues (UAT-041-05, 06, 07, 09)</name>
  <files>src/hooks/useURLFilterSync.ts</files>
  <action>
  Four fixes in this file:

  **1. Fix circular TypeScript constraint (line 68):**
  Change:
  ```typescript
  function debounce<T extends (...args: Parameters<T>) => void>(fn: T, ms: number): T {
  ```
  To:
  ```typescript
  function debounce<T extends (...args: unknown[]) => void>(fn: T, ms: number): T {
  ```

  **2. Add filterVisibility validation (lines 145-146):**
  Change:
  ```typescript
  if (!searchParams.has(visibilityParam) && prefs.filterVisibility !== 'all') {
  ```
  To:
  ```typescript
  if (!searchParams.has(visibilityParam) && isValidVisibilityFilter(prefs.filterVisibility) && prefs.filterVisibility !== 'all') {
  ```

  **3. Add sortDirection validation (lines 151-152):**
  Change:
  ```typescript
  if (!searchParams.has(sortDirParam) && prefs.sortDirection !== defaultSortDirection) {
  ```
  To:
  ```typescript
  if (!searchParams.has(sortDirParam) && isValidSortDirection(prefs.sortDirection) && prefs.sortDirection !== defaultSortDirection) {
  ```

  **4. Dev-gate console.error statements (lines 130-132, 154-156):**
  Change line 130-132:
  ```typescript
  adapter.updateFilterPreferences(prefs).catch((err) => {
    console.error('Failed to persist filter preferences:', err);
  });
  ```
  To:
  ```typescript
  adapter.updateFilterPreferences(prefs).catch((err) => {
    if (import.meta.env.DEV) {
      console.error('Failed to persist filter preferences:', err);
    }
  });
  ```

  Change line 154-156:
  ```typescript
  }).catch((err) => {
    console.error('Failed to load filter preferences:', err);
  });
  ```
  To:
  ```typescript
  }).catch((err) => {
    if (import.meta.env.DEV) {
      console.error('Failed to load filter preferences:', err);
    }
  });
  ```
  </action>
  <verify>
  1. `npm run build` passes with no TypeScript errors
  2. Filter persistence still works correctly
  3. No console.error in production build (can verify by checking bundle or testing)
  </verify>
  <done>useURLFilterSync has non-circular generics, validates all DB values, and dev-gates console.error</done>
</task>

<task type="auto">
  <name>Task 5: Dev-gate console.error in useInfiniteCopyEvents (UAT-041-08)</name>
  <files>src/hooks/useInfiniteCopyEvents.ts</files>
  <action>
  At lines 223-225, update the catch block:

  Change:
  ```typescript
  queryClient.invalidateQueries({
    queryKey: ['copyEvents'],
    refetchType: 'active',
  }).catch((err) => {
    console.error('Failed to invalidate copy event queries via subscription:', err);
  });
  ```

  To:
  ```typescript
  void queryClient.invalidateQueries({
    queryKey: ['copyEvents'],
    refetchType: 'active',
  }).catch((err) => {
    if (import.meta.env.DEV) {
      console.error('Failed to invalidate copy event queries via subscription:', err);
    }
  });
  ```

  Note: Add `void` prefix to explicitly mark fire-and-forget promise.
  </action>
  <verify>
  1. `npm run build` passes
  2. No console.error for copy event invalidation in production
  </verify>
  <done>useInfiniteCopyEvents has dev-gated console.error with void prefix</done>
</task>

<task type="auto">
  <name>Task 6: Remove unused usePrompts destructuring (UAT-041-04)</name>
  <files>src/pages/PublicPromptDetail.tsx</files>
  <action>
  Remove line 18 which destructures unused functions:
  ```typescript
  const { togglePinPrompt, incrementCopyCount, incrementPromptUsage } = usePrompts();
  ```

  Also remove the `usePrompts` import from line 5 if nothing else in the file uses it:
  ```typescript
  import { usePrompts } from '@/contexts/PromptsContext';
  ```

  Verify the component still works - PromptView has its own usePrompts call internally.
  </action>
  <verify>
  1. `npm run build` passes
  2. `npm run lint` passes with no unused variable warnings
  3. PublicPromptDetail page still functions correctly
  </verify>
  <done>PublicPromptDetail has no unused imports or destructured variables</done>
</task>

<task type="auto">
  <name>Task 7: Add search normalization (UAT-041-11)</name>
  <files>src/hooks/usePromptFilters.ts</files>
  <action>
  At lines 115-127, update search filtering to use proper normalization per CLAUDE.md:

  Add a normalize helper at the top of the filter logic (inside the useMemo or as a const before it):
  ```typescript
  const normalizeSearchString = (s: string) => s.replace(/[\s_]+/g, '').toLowerCase();
  ```

  Then update the search filter block:
  ```typescript
  // Search filter (normalized match across title, body, author name, and author ID)
  if (searchTerm) {
    const searchNormalized = normalizeSearchString(searchTerm);
    result = result.filter((prompt) => {
      const titleMatch = normalizeSearchString(prompt.title).includes(searchNormalized);
      const bodyMatch = normalizeSearchString(prompt.body).includes(searchNormalized);
      // Check author name and ID for public prompts
      const authorName = prompt.author?.displayName;
      const authorId = prompt.authorId;
      const authorMatch = (authorName && normalizeSearchString(authorName).includes(searchNormalized)) ||
                          (authorId && normalizeSearchString(authorId).includes(searchNormalized));
      return titleMatch || bodyMatch || authorMatch;
    });
  }
  ```

  Note: This normalizes by removing spaces/underscores and lowercasing, per CLAUDE.md guidelines.
  </action>
  <verify>
  1. Search "my_variable" matches prompt with "myvariable" in title
  2. Search "test prompt" matches prompt with "testprompt" in body
  3. Normal searches (without underscores/spaces) still work correctly
  </verify>
  <done>Search uses consistent normalization removing spaces/underscores</done>
</task>

<task type="auto">
  <name>Task 8: Add trust gate to @claude workflow (UAT-041-12)</name>
  <files>.github/workflows/claude.yml</files>
  <action>
  Update lines 15-19 to add author_association checks.

  Change the `if` block to:
  ```yaml
  claude:
    if: |
      (github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@claude') &&
        contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.comment.author_association)) ||
      (github.event_name == 'pull_request_review_comment' &&
        contains(github.event.comment.body, '@claude') &&
        contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.comment.author_association)) ||
      (github.event_name == 'pull_request_review' &&
        contains(github.event.review.body, '@claude') &&
        contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.review.author_association)) ||
      (github.event_name == 'issues' &&
        (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')) &&
        contains(fromJSON('["MEMBER","OWNER","COLLABORATOR"]'), github.event.issue.author_association))
  ```

  This restricts @claude triggers to MEMBER, OWNER, or COLLABORATOR roles only.
  </action>
  <verify>
  1. YAML syntax is valid (no parse errors)
  2. Trusted collaborators can still trigger @claude
  3. External contributors cannot trigger the workflow
  </verify>
  <done>@claude workflow only triggers for trusted repository members</done>
</task>

<task type="auto">
  <name>Task 9: Fix documentation issues (UAT-041-13, 14, 15)</name>
  <files>
    .planning/phases/15.4-public-prompt-ux-improvements/15.4-VERIFICATION.md
    .planning/phases/15.4-public-prompt-ux-improvements/15.4-01-PLAN.md
  </files>
  <action>
  **Fix 1 (UAT-041-13):** In 15.4-VERIFICATION.md around line 42, update the ring color reference.

  Change:
  ```
  ring-primary/50
  ```
  To:
  ```
  ring-2 ring-green-500/50 bg-green-50/30
  ```

  **Fix 2 (UAT-041-14):** In 15.4-VERIFICATION.md around line 101, fix the item count.

  Change:
  ```
  Four items flagged for manual browser testing:
  ```
  To:
  ```
  Five items flagged for manual browser testing:
  ```

  **Fix 3 (UAT-041-15):** In 15.4-01-PLAN.md around line 65, remove inconsistent refetch() reference.

  Find text mentioning "call `refetch()` to refresh the copy history list" and update to be consistent with line 70 which correctly says "Use React Query's `invalidateQueries` method".

  Either remove the refetch() reference or change it to invalidateQueries() for consistency.
  </action>
  <verify>
  1. 15.4-VERIFICATION.md mentions correct green-500 styling
  2. 15.4-VERIFICATION.md says "Five items" not "Four items"
  3. 15.4-01-PLAN.md gives consistent invalidateQueries guidance
  </verify>
  <done>Documentation accurately describes implementation</done>
</task>

<task type="auto">
  <name>Task 10: Build and lint verification</name>
  <files>N/A (verification only)</files>
  <action>
  Run full build and lint to verify all fixes compile without errors:

  ```bash
  npm run lint
  npm run build
  ```

  If any issues found, fix them before completing.
  </action>
  <verify>
  1. `npm run lint` exits 0 with no errors
  2. `npm run build` exits 0 with no errors
  3. No TypeScript errors or warnings
  </verify>
  <done>All fixes pass lint and build checks</done>
</task>

</tasks>

<verification>
## Functional Verification

After all tasks complete, verify end-to-end:

1. **UAT-041-01 (Created sort):**
   - Go to Library page
   - Select "Created" sort option
   - Prompts should sort by creation date (oldest/newest based on direction)

2. **UAT-041-02 (Copy History race):**
   - Clear browser cache
   - Throttle network to slow 3G
   - Load /history page
   - NO green "Public" badges should flash during load

3. **UAT-041-03 (onDelete guard):**
   - View a public prompt detail (non-owned)
   - Component renders without crash
   - Delete button is not shown

4. **UAT-041-05, 06, 07, 09 (useURLFilterSync):**
   - Filter preferences load from DB
   - TypeScript compiles without errors
   - No console errors in production build

5. **UAT-041-08 (useInfiniteCopyEvents):**
   - No console errors in production build

6. **UAT-041-04 (unused imports):**
   - `npm run lint` passes with no unused variable warnings

7. **UAT-041-11 (search normalization):**
   - Search "test_prompt" matches "testprompt"
   - Search "my variable" matches "myvariable"

8. **UAT-041-12 (trust gate):**
   - YAML is valid
   - Workflow condition includes author_association checks
</verification>

<success_criteria>
- All 14 IMPLEMENT NOW issues from UAT-041 are resolved
- `npm run lint` exits 0
- `npm run build` exits 0
- No TypeScript errors
- Documentation matches implementation
- Security: @claude workflow restricted to trusted roles
</success_criteria>

<output>
After completion, create `.planning/phases/15.4-public-prompt-ux-improvements/15.4-06-SUMMARY.md`
</output>
