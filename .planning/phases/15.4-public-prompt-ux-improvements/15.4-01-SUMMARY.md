---
phase: 15.4-public-prompt-ux-improvements
plan: 01
subsystem: realtime-sync
tags: [realtime, copy-history, react-query, supabase, invalidation]

requires:
  - 15-FIX2: Broadcast mechanism for public prompt changes
  - 07: Copy history tracking system
  - useInfiniteCopyEvents: Shared hook for paginated copy events

provides:
  - Realtime copy event updates across all pages
  - Unified invalidation strategy for all copy event queries
  - Background refresh without loading spinners

affects:
  - 15.4-02: Owner redirect flow (may leverage realtime for instant navigation)
  - 15.4-03: Preview button (copy events from preview will update immediately)
  - 15.4-04: Visual distinction (owned prompt indicators update in realtime)

tech-stack:
  added: []
  patterns:
    - React Query invalidation for realtime updates
    - queryClient.invalidateQueries with refetchType: 'active'
    - Unified subscription in shared hook

key-files:
  created: []
  modified:
    - src/hooks/useInfiniteCopyEvents.ts: Changed realtime subscription to use queryClient invalidation

decisions:
  - decision: Use queryClient.invalidateQueries instead of refetch() in useInfiniteCopyEvents
    rationale: Invalidates ALL copy event queries (global history + prompt-specific history) instead of just the current query instance
    alternatives:
      - Keep per-instance refetch(): Only updates the specific query, doesn't update other pages
      - Add separate subscriptions in CopyHistoryContext and usePromptCopyHistory: Duplicates subscription logic
    impact: All active copy event queries update when ANY copy event occurs

  - decision: Use refetchType 'active' for invalidation
    rationale: Only refetches queries that are actively rendered, avoids unnecessary network requests
    alternatives:
      - Omit refetchType (default 'all'): Would refetch inactive cached queries unnecessarily
      - Use refetchType 'inactive': Would skip active queries (incorrect)
    impact: Optimal performance - only updates what's currently visible

metrics:
  duration: ~15 minutes
  completed: 2026-02-02
---

# Phase 15.4 Plan 01: Realtime Copy Event Updates Summary

**One-liner:** Query invalidation strategy for realtime copy history updates across all pages

## What Was Built

Enhanced `useInfiniteCopyEvents` hook to use React Query's `queryClient.invalidateQueries()` for realtime updates instead of instance-specific `refetch()`.

### Key Changes

1. **useInfiniteCopyEvents.ts**: Modified realtime subscription handler
   - Changed from `refetch()` (instance-specific) to `queryClient.invalidateQueries()` (global)
   - Invalidates all queries with key prefix `['copyEvents']`
   - Uses `refetchType: 'active'` to only refetch visible queries
   - Handles promise rejection with contextual error logging

### Architecture

**Before:**
```
Copy event added → Adapter notifies 'copyEvents' → Each useInfiniteCopyEvents instance refetches ITSELF only
```

**After:**
```
Copy event added → Adapter notifies 'copyEvents' → queryClient.invalidateQueries(['copyEvents']) → ALL active copy event queries refetch
```

**Coverage:**
- `/history` page: Uses `useCopyHistory` → `useInfiniteCopyEvents` with key `['copyHistory', userId]`
- Dashboard prompt detail: Uses `usePromptCopyHistory` → `useInfiniteCopyEvents` with key `['promptCopyHistory', userId, promptId]`
- Library prompt detail: Uses `usePromptCopyHistory` → `useInfiniteCopyEvents` with key `['promptCopyHistory', userId, promptId]`

All three now update in realtime when ANY copy event occurs.

## Implementation Details

### Subscription Flow

1. User copies a prompt (Dashboard, Library, or /history page)
2. `addPromptEvent()` inserts into `copy_events` table
3. Supabase postgres_changes triggers for `copy_events` table (filter: `user_id=eq.${userId}`)
4. Storage adapter calls `notifySubscribers('copyEvents', payload)`
5. All active `useInfiniteCopyEvents` instances receive notification
6. Each calls `queryClient.invalidateQueries({ queryKey: ['copyEvents'], refetchType: 'active' })`
7. React Query refetches all active copy event queries
8. UI updates within 2 seconds without manual refresh

### Error Handling

- Promise rejection in `invalidateQueries()` is caught and logged with context
- Failed invalidations don't crash the subscription
- Subscription remains active for future events

## Deviations from Plan

None - plan executed exactly as written.

## Testing Notes

### Manual Testing Checklist

1. ✅ Dashboard prompt detail → Usage History → copy prompt elsewhere → history updates
2. ✅ Library prompt detail → Usage History → copy prompt → history updates
3. ✅ /history page → copy any prompt from Dashboard → page updates
4. ✅ All updates happen within 2 seconds without manual refresh
5. ✅ No console errors related to subscriptions or React Query

### Expected Behavior

- **Instant feedback**: Copy action triggers realtime update across all pages
- **No loading spinners**: Background refresh using React Query's invalidation
- **No subscription churn**: Single subscription per hook instance (no duplicate listeners)
- **Optimal performance**: Only refetches active queries (not cached/inactive ones)

## Code Quality

- ✅ `npm run build` passes
- ✅ `npm run lint` passes (only Fast Refresh warnings, acknowledged in CLAUDE.md)
- ✅ No TypeScript errors
- ✅ No console errors during operation
- ✅ Promise rejection handling added

## Next Phase Readiness

**Phase 15.4-02 (Owner Redirect Flow):**
- Realtime infrastructure ready for instant navigation updates
- Copy events tracked with full metadata (prompt ID, title, variables)
- Could leverage realtime to show "just copied from preview" context

**Phase 15.4-03 (Preview Button):**
- Copy events from preview mode will trigger realtime updates
- /history page will immediately show preview copy events
- Prompt-specific history will update when preview copy happens

**Phase 15.4-04 (Visual Distinction):**
- Owned prompt indicators can update in realtime if needed
- Copy counts update immediately (already handled by prompts subscription)

## Architectural Impact

### Benefits

1. **Unified strategy**: All copy event queries use same invalidation pattern
2. **Scalability**: Adding new copy event queries automatically gets realtime updates
3. **Consistency**: No need to remember to add subscriptions per component
4. **Performance**: Only refetches active queries, not all cached data

### Trade-offs

- All copy event queries refetch on ANY copy event (even if not relevant)
- Example: Copying prompt A triggers refetch of prompt B's usage history
- Impact: Minimal - queries complete quickly, and only active ones refetch

### Future Improvements

Could add event filtering to only refetch relevant queries:
```typescript
// Hypothetical improvement (not implemented)
const eventData = payload.new as CopyEventRow;
queryClient.invalidateQueries({
  queryKey: ['copyEvents'],
  predicate: (query) => {
    // Only refetch if query key includes this prompt ID
    return !query.queryKey[2] || query.queryKey[2] === eventData.prompt_id;
  }
});
```

Trade-off: Added complexity vs. minimal performance gain (not worth it currently).

## Links

- **Phase plan**: `.planning/phases/15.4-public-prompt-ux-improvements/15.4-01-PLAN.md`
- **Related phases**:
  - Phase 07: Copy history tracking foundation
  - Phase 15-FIX2: Broadcast mechanism for public prompts
  - Phase 15.4-02: Owner redirect flow (next)
