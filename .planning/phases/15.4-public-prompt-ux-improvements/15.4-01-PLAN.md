---
phase: 15.4-public-prompt-ux-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/storage/supabaseAdapter.ts
  - src/hooks/useInfiniteCopyEvents.ts
  - src/contexts/CopyHistoryContext.tsx
autonomous: true

must_haves:
  truths:
    - "Usage history updates in realtime when user copies a prompt on Dashboard"
    - "Usage history updates in realtime when user copies a prompt on Library page"
    - "/history page updates in realtime when new copy events occur"
  artifacts:
    - path: "src/lib/storage/supabaseAdapter.ts"
      provides: "Realtime subscription to copy_events table with broadcast notification"
      contains: "notifySubscribers('copyEvents'"
    - path: "src/hooks/useInfiniteCopyEvents.ts"
      provides: "React Query invalidation on realtime copy event changes"
      contains: "queryClient.invalidateQueries"
  key_links:
    - from: "src/lib/storage/supabaseAdapter.ts"
      to: "src/hooks/useInfiniteCopyEvents.ts"
      via: "subscribe callback triggers queryClient invalidation"
      pattern: "adapter\\.subscribe.*copyEvents"
---

<objective>
Add realtime updates to usage history across all pages where copy history is displayed.

Purpose: When a user copies a prompt, the usage history should update immediately without requiring a page refresh. This provides instant feedback and keeps the UI consistent with the actual database state.

Output: Modified storage adapter with copy_events realtime subscription, and React Query integration that invalidates copy history caches on realtime events.
</objective>

<execution_context>
@C:\Users\2supe\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\2supe\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/storage/supabaseAdapter.ts
@src/hooks/useInfiniteCopyEvents.ts
@src/contexts/CopyHistoryContext.tsx
@src/hooks/usePromptCopyHistory.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add copy_events realtime notification to CopyHistoryContext</name>
  <files>src/contexts/CopyHistoryContext.tsx</files>
  <action>
The storage adapter already subscribes to copy_events changes in supabaseAdapter.ts (see line 926). However, the CopyHistoryContext currently only handles the 'prompts' and 'stats' notification types for refreshing data.

Modify CopyHistoryContext to:
1. Listen for 'copyEvents' type in the storage adapter subscription callback
2. When 'copyEvents' is received, call `refetch()` to refresh the copy history list (use silent mode if available to avoid loading spinners)
3. This will cause the /history page and any component using useCopyHistory to update automatically

The pattern already exists in PromptsContext - see how it handles 'prompts' events. Apply the same pattern for 'copyEvents'.

Important: Use React Query's `invalidateQueries` method with the appropriate query key to trigger refetch without showing loading states. The query key pattern is ['copyEvents', 'copyHistory', userId].
  </action>
  <verify>
1. Open the app in two browser tabs
2. Navigate to /history in Tab A
3. In Tab B, go to Dashboard and copy a prompt
4. Tab A's /history page should show the new copy event within 2 seconds without manual refresh
  </verify>
  <done>Copy history page updates in realtime when copy events are added via copy action in another context</done>
</task>

<task type="auto">
  <name>Task 2: Add realtime copy event updates to prompt-specific history</name>
  <files>src/hooks/useInfiniteCopyEvents.ts</files>
  <action>
The useInfiniteCopyEvents hook is used by usePromptCopyHistory to fetch copy events for a specific prompt (shown in the "Usage History" accordion on prompt detail pages).

Modify useInfiniteCopyEvents to:
1. Accept an optional `onRealtimeUpdate` callback or set up its own subscription
2. Subscribe to storage adapter changes for 'copyEvents' type
3. When copy_events change, invalidate the specific query key to trigger a refetch
4. Use `queryClient.invalidateQueries({ queryKey: queryKey })` to refresh the data

Pattern to follow:
- Import useStorageAdapterContext if not already present
- In a useEffect, subscribe to adapter changes
- Filter for 'copyEvents' type
- Invalidate the query to trigger background refresh
- Clean up subscription on unmount

Make sure the invalidation uses { refetchType: 'active' } to only refetch if the query is actively being used.
  </action>
  <verify>
1. Open prompt detail page (Dashboard -> click a prompt)
2. Expand "Usage History" accordion
3. In another tab, copy the same prompt from the card view
4. The Usage History in the first tab should update within 2 seconds showing the new copy event
  </verify>
  <done>Prompt-specific usage history updates in realtime when that prompt is copied</done>
</task>

<task type="auto">
  <name>Task 3: Verify and test all realtime copy event paths</name>
  <files>src/pages/CopyHistory.tsx, src/components/PromptView.tsx</files>
  <action>
Verify that all copy event display locations properly receive realtime updates:

1. Check /history page (CopyHistory.tsx):
   - Uses useCopyHistory() from CopyHistoryContext
   - Should already work after Task 1

2. Check prompt detail Usage History (PromptView.tsx):
   - Uses usePromptCopyHistory() which uses useInfiniteCopyEvents
   - Should work after Task 2
   - Both Dashboard and Library detail pages use PromptView

3. If any path is not working, trace the subscription chain:
   - Storage adapter subscribe() -> callback with 'copyEvents' type
   - Context/hook receives callback -> invalidates query
   - React Query refetches -> UI updates

No code changes may be needed in these files if Tasks 1 and 2 are correct. This task is for verification and any edge case fixes.

If search results in CopyHistory.tsx need realtime updates too:
- The searchResults state is separate from the paginated history
- If search is active and a new event matches the search, it won't appear until search is re-run
- This is acceptable behavior - searches are point-in-time snapshots
  </action>
  <verify>
Manual testing checklist:
1. Dashboard prompt detail -> Usage History -> copy prompt elsewhere -> history updates
2. Library prompt detail -> Usage History -> copy prompt -> history updates
3. /history page -> copy any prompt from Dashboard -> page updates
4. All updates should happen within 2 seconds without manual refresh
5. No console errors related to subscriptions or React Query
  </verify>
  <done>All copy event display locations (Dashboard detail, Library detail, /history page) update in realtime</done>
</task>

</tasks>

<verification>
- `npm run build` completes without errors
- `npm run lint` passes
- Manual testing confirms realtime updates work across all three locations:
  1. /history page
  2. Dashboard prompt detail Usage History
  3. Library prompt detail Usage History
</verification>

<success_criteria>
- Usage history updates within 2 seconds of copy action without manual refresh
- No subscription churn or console spam (follow CLAUDE.md broadcast channel pattern)
- Works across Dashboard, Library, and /history page
- Loading states do not flash during realtime updates (background refresh)
</success_criteria>

<output>
After completion, create `.planning/phases/15.4-public-prompt-ux-improvements/15.4-01-SUMMARY.md`
</output>
